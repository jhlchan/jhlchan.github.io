<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<!-- JC: inserted for greatnow -->
<meta name="dummy" content="body">
<script type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 2, revision: 1, date: new Date("Jun 8, 2007"), extensions: {}};
//]]>
</script>
<!--
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) UnaMesa Association 2004-2007

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>
<!--}}}-->
<!--PRE-HEAD-END-->
<title> JCQ - Math Topics </title>
<style type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
    background:[[ColorPalette::TertiaryPale]];
    border-left:1px solid [[ColorPalette::TertiaryLight]];
    border-top:1px solid [[ColorPalette::TertiaryLight]];
    border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
    border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background::[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
    border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
    border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

table {border:2px solid [[ColorPalette::TertiaryDark]];}
th, thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
td, tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity:60)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
    #mainMenu .tiddlyLinkNonExisting,
    #sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0em 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0em 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0em 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 .3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0em 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0em 0em 0em; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0em;}
.wizardFooter .status {padding:0em 0.4em 0em 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em 0.1em 0.2em;}

#messageArea {position:absolute; top:2em; right:0em; margin:0.5em; padding:0.5em; z-index:200;}
*[id='messageArea'] {position:fixed !important; z-index:200;}
.messageToolbar {display:block; text-align:right; padding:0.2em 0.2em 0.2em 0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em 0.2em 0.2em 0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em 1em 1em 1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0em;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0em 0em 0.5em;}
.tab {margin:0em 0em 0em 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0em 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0em 1em;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0em 0.25em; padding:0em 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

table {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0em; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px 1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em 0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0em; right:0em;}
#backstageButton a {padding:0.1em 0.4em 0.1em 0.4em; margin:0.1em 0.1em 0.1em 0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; margin:0em 3em 0em 3em; padding:1em 1em 1em 1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em 0.2em 0.4em;}
#backstageCloak {display:none; z-index:50; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which use a logographic writing system and need larger font sizes.
***/

/*{{{*/
body {font-size:0.8em;}

#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}

.subtitle {font-size:0.8em;}

.viewer table.listView {font-size:0.95em;}

.htmlarea .toolbarHA table {border:1px solid ButtonFace; margin:0em 0em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar {display: none ! important;}
#displayArea {margin: 1em 1em 0em 1em;}
/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
noscript {display:none;}
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler &gt; fields syncing permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:
* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* MainMenu: The menu (usually on the left)
* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These InterfaceOptions for customising TiddlyWiki are saved in your browser

Your username for signing your edits. Write it as a WikiWord (eg JoeBloggs)

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; SaveBackups
&lt;&lt;option chkAutoSave&gt;&gt; AutoSave
&lt;&lt;option chkRegExpSearch&gt;&gt; RegExpSearch
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; CaseSensitiveSearch
&lt;&lt;option chkAnimate&gt;&gt; EnableAnimations

----
Also see AdvancedOptions</pre>
</div>
</div>
<!--POST-SHADOWAREA-->
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges(); if(window.scrubNodes) scrubNodes(document.body);">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2007 Osmosoft Limited
</div>
<noscript>
    <div id="javascriptWarning">This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
    <div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="storeArea">
<div title="ColorPalette" modifier="Joseph" created="200706100912" changecount="1">
<pre>Background: #bbbbff
Foreground: #000
PrimaryPale: #FF8C69
PrimaryLight: #cc66ff
PrimaryMid: #440044
PrimaryDark: #410
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #002244
TertiaryPale: #99aacc
TertiaryLight: #aaaaff
TertiaryMid: #000
TertiaryDark: #8B7355 </pre>
</div>
<div title="Cryptography" modifier="Joseph" modified="201002240649" created="201002230456" changecount="48">
<pre>Cryptography has a fascinating history. Here is a brief summary. For more info, read [[here|http://en.wikipedia.org/wiki/Cryptography]].

!One Key, Two Methods
From ancient Greeks and Romans up to World Wars I and II, everybody assumed that only one type of encryption/decryption is possible: ''symmetric-key cryptography'' -- a cipher with only 1 single key, and 2 methods (encrypt/decrypt) that undo each other. Putting in steps:
# ''//Somehow//'' A and B each holds the same key.
# A puts message in a box, locks by the key, and sends to B.
# B receives the box, unlocks by the key, reads the message from A.
# ''//Assumption//'': without the key, the box cannot be unlocked.

This works good if ''//assumption//'' is OK, and ''//somehow//'' can be worked out. Let's examine each in turn.

The ''//assumption//'' believes in the existence of ''unbreakable cipher''. The skill of [[lock-picking|http://en.wikipedia.org/wiki/Lock_picking]] implies this is doubtful. Surely you can make the lock (or cipher) very complicated, thus giving the lock-pickers (or codebreakers) a challenge, but this is a cat-and-mouse chase. During WWII the Germans used a mechanical device with complicated connections (the [[Enigma|http://en.wikipedia.org/wiki/Enigma_machine]]) to encrypt all military messages, assuming that no human can ever break their code. They were right: no human effort could -- but the British recruited a brilliant mathematician Alan Turing who eventually deduced how the Enigma works, and constructed an electronic machine (non-human) to break the code -- here is the [[story|http://www.pbs.org/wgbh/nova/decoding/]].

The ''//somehow//'' is technically known as the ''[[Key Distribution Problem|http://en.wikipedia.org/wiki/Key_distribution]]'': how do A and B get the same key at the beginning? For example, the ATM card pin number is a form of symmetric-key cryptography: you key in the PIN to identify yourself, and the bank uses the PIN to verify you. But how did the bank send you the PIN? Perhaps by registered mail -- safe enough? The German military changed their Enigma keys almost everyday, resulting in some keys being reused -- a loophole exploited by the British codebreakers.

For a cipher, the encrypt and decrypt methods are mechanical, never-changing, and applied repeatedly -- so their secrets cannot be kept for too long. Thus the job of codebreakers is to deduce the key from whatever information available. A good cipher leaks very few or no information, so the only hope for a codebreaker is: //try ''every'' key// -- similar to trying every permutation for a combination-lock. Therefore the strength of ''symmetric-key cipher'' depends on the size of ''key space'': how many key permutations are there? 

If the key space is ''//infinite//'', the cipher will be ''//unbreakable//''. This is the case for [[one-time pad|http://en.wikipedia.org/wiki/One-time_pad]], which uses, effectively, an infinitely long random key. This is proven to be truly unbreakable (by mathematician Claude Shannon in 1945), but the key distribution problem is the worst: how do A and B agree on an infinitely long random key? For the spies before the age of computers, each gets a palm-size notepad with pages and pages of random digits. Each page is a ''pad''. Upon receiving an encrypted message of length n, the first n random digits are used to decrypt the message. These n digits will be crossed out, and the next message of length m will use the next m random digits. When all digits of a page have been crossed out, the page is simply burnt away -- hence ''one-time pad''. Nowadays spies can simply store the pad in ~USB-drives.

!One Method, Two Keys
Modern cryptography arises from the discovery of ''asymmetric-key cryptography'' (also called ''public-key cryptography''): a cipher with only 1 method, but 2 keys (public/private) that are inverses of each other. Putting in steps:
# B sends A the public key ''e'' with no encryption -- anyone can read ''e'', e.g. via [[SSL Certificate]].
# A applies key ''e'' to the message through a known method, sends to B -- anyone can google the method, e.g. [[RSA|Key pairs for RSA]].
# B applies the private key ''d'' to the received message with the same method, recovers the original.
# ''//Assumption//'': Someone who knows the method and public key ''e'' still cannot deduce the private key ''d''.

Thus the ''asymmetric-key cryptography'' require no key distribution, a big advantage over ''symmetric-key cryptography''. However, it relies on one ''//assumption//'', also known as the ''Trapdoor property'' or ''One-way function''. About this assumption:
* it is not ''//strictly//'' true: for ''RSA'' method using modulus ''n'', it is mathematically possible to compute ''d'' from ''e'' if the prime factorization of ''n'' is known.
* it is ''//almost//'' true: for ''RSA'', factorization of ''n'', usually a 1024-bit binary number, is impractical for any super-computers with known methods.

In 1994, a mathematician at MIT, Peter Shor, found a fast [[integer factorization algorithm|http://en.wikipedia.org/wiki/Shor%27s_algorithm]] which, in theory, can break the ''RSA''. However, the algorithm relies on massive parallel computations that can only be realized on ''//quantum computer//''. Lucky for ''RSA'', no one has the slightest idea of how to start building a quantum computer. 

!More Info
Beyond Discovery: The Code War
http://www.beyonddiscovery.org/content/view.asp?I=3420

</pre>
</div>
<div title="Cyclic Addition" modifier="Joseph" modified="201001231231" created="201001230518" changecount="18">
<pre>We are looking at the equation: ''x = x#e#d''  with operation ''#'' replaced by addition modulo ''n'': ''+'' under ''mod n''. That is:

''x = x + e + d  (mod n)''

Given a modulus ''n'', can we find a pair of public key ''e'' and private key ''d'' to satisfy this equation?

!Additive Inverses
Anyone who knows about modular arithmetic can answer this question: yes. Because the equation implies:

''0 = e + d (mod n)'',   so ''d = -e (mod n) = n - e''.

In fact, the remainders under modular addition forms a group ''(Z/n,+)''. Therefore, given modulus ''n'', any remainder in the range 1,2,...,(n-1) can be ''e'', then ''d=n-e'', the ''additive inverse'' of ''e'' (mod ''n'').

For example, taking modulus ''n=6'', picking ''e=1'', then ''d=5'':

|!Possible data for modulus 6|!Encrypt by +1 (mod 6)|!Decrypt by +5 (mod 6)|
|0|0+1=1|1+5=6=0|
|1|1+1=2|2+5=7=1|
|2|2+1=3|3+5=8=2|
|3|3+1=4|4+5=9=3|
|4|4+1=5|5+5=10=4|
|5|5+1=6=0|0+5=5|
|''Encryption and Decryption in Cyclic Add modulo 6''|c

!Is This Secure?
Since ''Encrypt by +e (mod n)'' is made public, the private key ''d=n-e'' can be easily computed. This method of encryption and decryption is not secure at all.

Historically, this cyclic add method is used in cryptography by keeping everything secret: ''e'' and ''n'' are known only to the sender, perhaps through a face-to-face meeting with the receiver. For example, the ''Caesar Cipher'' just encrypts by shifting each alphabet by 1 unit, and decrypts by shifting back:

|!Message|!Encrypt|!Decrypt|
|~AttackAtDawn|~BuubdlBuEbxo|~AttackatDawn|
|''Caesar Cipher''|c

I guess even you can crack this type of code without much effort.
</pre>
</div>
<div title="Cyclic Exponentiation" modifier="Joseph" modified="201001240842" created="201001231120" changecount="28">
<pre>We are looking at the equation: ''x = x#e#d''  with operation ''#'' replaced by exponentiation modulo ''n'': ''^'' under ''mod n''. That is:

''x = x ^ e ^ d  (mod n)''  or ''x = (x^^e^^)^^d^^ (mod n)'' or ''x = x^^(e*d)^^ (mod n)''

Given a modulus ''n'', can we find a pair of public key ''e'' and private key ''d'' to satisfy this equation?

In general, the arithmetics of modulo ''n'' forms a [[Ring|Group, Ring and Field]] ''(Z/n,+,*)'': only addition is nice, multiplication is bad. We cannot even cancel ''x'' on both sides of the equation. So we must turn our attention to specific modulus n.

!Exponent Inverses for Modulo Prime
If the modulus is a prime ''p'', then ''(Z/p,+,*)'' is a [[Field|Group, Ring and Field]]. In particular, the nonzero remainders under multiplication is a group: ''(Z/p^^*^^,*)''. Also, we have ''Fermat's Little Theorem'':

For prime ''p'', ''a^^p^^=a (mod p)'' for any remainder ''a''.

So all we need is to solve: ''e*d = p''. Since ''p'' is prime, this implies ''e=1 and d=p'', or ''e=p and d=1''. These keys are useless for encryption and decryption.

All hope is not lost -- we just need to think harder. ''Fermat's Little Theorem'' can also be written as:

For prime ''p'', ''a^^(p-1)^^=1 (mod p)'' for any remainder ''a''.

This is because ''(Z/p^^*^^,*)'' is a group, and cancellation is allowed. This also implies:

  ''(a^^(p-1)^^)^^k^^=1^^k^^=1 (mod p)'' for any integer ''k''
or ''a^^[k*(p-1)]^^=1 (mod p)''
or ''a^^[k*(p-1)+1]^^=a (mod p)''

Now we need to solve: ''e*d = k*(p-1)+1'', or ''e*d - k*(p-1) = 1''. Upon seeing this, a math expert will say: choose e relatively prime to (p-1) -- because any common divisor of ''e'' and ''(p-1)'' must also divide ''e*d - k*(p-1)'', which is 1.

Therefore, given prime modulus ''p'', any ''e'' relatively prime to ''(p-1)'' will do, and d=e^^-1^^ (mod (p-1)), the multiplicative inverse of ''e'' in ''mod (p-1)''.

For example, taking prime modulus ''p=11'', then (p-1)=10, so pick ''e=3'' which relatively prime to 10, and ''d=7'' because 3*7=21=1 (mod 10).

|!Possible data for modulus 11|!Encrypt by ^3 (mod 11)|!Decrypt by ^7 (mod 11)|
|1|1^^3^^=1|1^^7^^=1|
|2|2^^3^^=8|8^^7^^=(8*8)^^3^^*8=(64)^^3^^*8=(9)^^3^^*8=(-2)^^3^^*8=-64=2 (mod 11)|
|3|3^^3^^=27=5|5^^7^^=(5*5)^^3^^*5=(3)^^3^^*5=(5)*5=25=3 (mod 11)|
|4|4^^3^^=16*4=5*4=20=9|9^^7^^=(9*9)^^3^^*9=(4)^^3^^*9=16*36=(5)*(3)=15=4 (mod 11)|
|5|5^^3^^=25*5=3*5=15=4|4^^7^^=(4*4)^^3^^*4=(5)^^3^^*4=25*20=(3)*(-2)=-6=5 (mod 11)|
|''Encryption and Decryption in Cyclic Exponent modulo 11''|c

!Is This Secure?
Since ''Encrypt by ^e (mod p)'' is made public, the private key ''d=e^^-1^^ mod (p-1)'' can be computed, at least by number theorists -- or as clever as Euler, see recipe below. This method of encryption and decryption is hopeful, but still not secure enough for bank transactions.

!Computing Multiplicative Inverse
For a prime modulus ''p'', the multiplicative inverse can be computed via help from ''Fermat's Little Theorem'': ''a^^p^^=a (mod p)''.

However, the key pair above are related by: ''e*d = 1 (mod p-1)'', and (p-1) is not prime when p is prime.

Is there a similar little theorem in non-prime modulus?

Euler proved the little theorem in 1736, and in 1760 he found its generalization, now called ''Euler's Theorem'':

For any modulus ''n'', ''a^^&amp;phi;(n)^^=1 (mod n)'' for remainder ''a relatively prime to n'' .

The ''Euler phi-function'': ''&amp;phi;(n)'' = number of remainders relatively prime to n.

When the modulus ''n'' is a prime ''p'', ''&amp;phi;(p) = p-1'' since all the number 1,2,...(p-1) cannot divide a prime p, thus giving ''Fermat's Little Theorem'':

For prime modulus ''p'', ''a^^(p-1)^^=1 (mod p)'' for any remainder ''a''.

|!n|!Remainders relatively prime to n|!&amp;phi;(n)|
|2|1|1|
|3|1,2|2|
|4|1,3|2|
|5|1,2,3,4|4|
|6|1,5|2|
|7|1,2,3,4,5,6|6|
|8|1,3,5,7|4|
|9|1,2,4,5,7,8|6|
|10|1,3,7,9|4|
|''Euler's phi-function &amp;phi;(n)''|c

''Euler's Theorem'' can be re-written as: ''a*a^^(&amp;phi;(n)-1)^^=1 (mod n)'' for ''a'' relatively prime to ''n''.

This gives an explicit formula for the multiplicative inverse of e mod (p-1): ''d = e^^(&amp;phi;(p-1)-1)^^ (mod p-1)''.

|!prime modulus p|!p-1|!Possible e for encrypt|!&amp;phi;(p-1)|!Compute d for decrypt|!Verify: e*d = 1 (mod p-1)|
|5|4|3|2|3^^(2-1)^^=3^^1^^=3 (mod 4)|3*3=9=1 (mod 4)|
|7|6|5|2|5^^(2-1)^^=5^^1^^=5 (mod 6)|5*5=25=1 (mod 6)|
|11|10|3|4|3^^(4-1)^^=3^^3^^=27=7 (mod 10)|3*7=21=1 (mod 10)|
|13|12|7|4|7^^(4-1)^^=7^^3^^=(49)*7=(1)*7=7 (mod 12)|7*7=48=1 (mod 12)|
</pre>
</div>
<div title="Cyclic Multiplication" modifier="Joseph" modified="201001231340" created="201001231119" changecount="20">
<pre>We are looking at the equation: ''x = x#e#d''  with operation ''#'' replaced by multiplication modulo ''n'': ''*'' under ''mod n''. That is:

''x = x * e * d  (mod n)''

Given a modulus ''n'', can we find a pair of public key ''e'' and private key ''d'' to satisfy this equation?

!Multiplicative Inverses
If you know about modular arithmetic, let's see what the equation implies. First you can only cancel ''x'' on both sides if multiplication in ''mod n'' forms a group -- this is the case only when the modulus is ''prime'', see [[Group, Ring and Field]].

Taking a prime modulus ''p'', the nonzero remainders of modulus p under multiplication forms a group ''(Z/p^^*^^,*)''. We can cancel ''x'' on both sides to obtain:

''1 = e * d (mod p)'',  which means ''d'' is the multiplicative inverse of ''e'' in ''Z/p^^*^^'' (in a group, inverse always exists).

Therefore, given prime modulus ''p'', any remainder in the range 1,2,...,(p-1) can be ''e'', then ''d=e^^-1^^'', the ''multiplicative inverse'' of ''e'' (mod ''p'').

For example, taking prime modulus ''n=7'', pick ''e=3'', then ''d=5'', because 3*5=15=1 (mod 7):

|!Possible data for modulus 7|!Encrypt by *3 (mod 7)|!Decrypt by *5 (mod 7)|
|1|1*3=3|3*5=15=1|
|2|2*3=6|6*5=30=2|
|3|3*3=9=2|2*5=10=3|
|4|4*3=12=5|5*5=25=4|
|5|5*3=15=1|1*5=5|
|''Encryption and Decryption in Cyclic Multiply modulo 7''|c

!Is This Secure?
Since ''Encrypt by *e (mod p)'' is made public, the private key ''d=e^^-1^^ (mod p)'' can be computed, at least by those who have studied group theory -- or as clever as Fermat, see the recipe below. This method of encryption and decryption is probably secure for kids, but certainly not for bank transactions!

!Computing Multiplicative Inverse
Around 1640, Pierre de Fermat discovered this surprising result in modular multiplication:

If ''p'' is a prime, ''a^^p^^ = a  (mod p)''  for any remainder ''a''.

This shows repeated multiplication, or exponentiation, in modular arithmetic is quite interesting: with a prime modulus ''p'', if you multiply any remainder by itself repeatedly for p times, you'll get back the original remainder!

Since ''Z/p^^*^^'' is a group under modular multiplication, we can cancel one ''a'' on both sides, giving:

''a^^(p-1)^^ = 1 (mod p)''

This is usually called ''Fermat's Little Theorem''. Since all prime p &gt; 1, we can further write:

''a*a^^(p-2)^^ = 1 (mod p)''

which gives an explicit formula for the multiplicative inverse of a mod p.

Therefore, by the little theorem, the formula for private key is: ''d = e^^(p-2)^^ (mod p)''.

|!prime modulus p|!Possible e for encrypt|!Compute d for decrypt|!Verify: e*d = 1 (mod p)|
|5|3|3^^(5-2)^^=3^^3^^=3*3*3=(9)*3=(4)*3=12=2 (mod 5)|3*2=6=1 (mod 5)|
|7|3|3^^(7-2)^^=3^^5^^=(3*3)^^2^^*3=(9)^^2^^*3=(2)^^2^^*3=4*3=12=5 (mod 7)|3*5=15=1 (mod 7)|
|7|4|4^^(7-2)^^=4^^5^^=(4*4)^^2^^*4=(16)^^2^^*4=(2)^^2^^*4=4*4=16=2 (mod 7)|4*2=8=1 (mod 7)|
|11|5|5^^(11-2)^^=5^^9^^=(5*5)^^4^^*5=(25)^^4^^*5=(3)^^4^^*5=81*5=4*5=20=9 (mod 11)|5*9=45=1 (mod 11)|
|11|7|7^^(11-2)^^=7^^9^^=(7*7)^^4^^*7=(49)^^4^^*5=(5)^^4^^*7=(3)^^2^^*7=63=8 (mod 11)|7*8=56=1 (mod 11)|

This ''Little Theorem'' was stated in a letter from Fermat to the amateur mathematician Frenicle de Bessy dated October 1640. No proof was provided. The first proof was given by Euler in 1736, almost a century after Fermat's announcement. Leibniz had given an identical proof in an unpublished work about 50 years prior to Euler's. Eleven years later in 1747, Euler will give another proof of the same theorem.</pre>
</div>
<div title="DefaultTiddlers" modifier="Joseph" modified="201001170531" created="200706090856" changecount="5">
<pre>[[Prime Applications]]</pre>
</div>
<div title="E.A.S.E" modifier="YannPerrin" modified="200702072052" created="200701131437" tags="systemConfig E.A.S.E Framework ForBlogUse Plugins" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200702072052">
<pre>/***
|!''Name:''|!''E''asily ''A''daptable ''S''ource ''E''ditor|
|''Description:''|this framework allows you to easily create commands that work on the current tiddler text selection in edit mode|
|''Version:''|0.1.0|
|''Date:''|13/01/2007|
|''Source:''|http://yann.perrin.googlepages.com/twkd.html#E.A.S.E|
|''Author:''|[[Yann Perrin|YannPerrin]]|
|''License:''|[[BSD open source license]]|
|''~CoreVersion:''|2.x|
|''Browser:''|Firefox 1.0.4+; Firefox 1.5; InternetExplorer 6.0|
***/
////Messages Definition
//{{{
config.messages.Ease = {
noselection:&quot;nothing selected&quot;,
asktitle:&quot;enter the new tiddler title&quot;,
exists:&quot; already exists, please enter another title&quot;,
askForTagsLabel:&quot;enter the new tiddler tags&quot;,
tiddlercreated:&quot; tiddler created&quot;
}
//}}}
////
//{{{
if (!window.TWkd) window.TWkd={context:{}};
if (!TWkd.Ease)
 TWkd.Ease = function (text,tooltip){
 this.text = text;
 this.tooltip = tooltip;
 this.modes = [];
 this.addMode = function(modeDefinition) {this.modes.push(modeDefinition);};
 this.handler = function(event,src,title) {
 TWkd.context.command = this;
 TWkd.context.selection=this.getSelection(title);
 if (this.modes.length==1) {
 this.modes[0].operation();
 }
 else {
 var popup = Popup.create(src);
 if(popup) {
 for (var i=0; i&lt;this.modes.length; i++) {
 createTiddlyButton(createTiddlyElement(popup,&quot;li&quot;), this.modes[i].name, this.modes[i].tooltip, this.OperateFromButton, null, 'id'+i, null);
 }
 Popup.show(popup,false);
 event.cancelBubble = true;
 if (event.stopPropagation) event.stopPropagation();
 return false;
 }
 }
 };
 };

TWkd.Ease.prototype.OperateFromButton = function(e){
 var commandMode=this.getAttribute('Id').replace('id','');
 TWkd.context.command.modes[commandMode].operation();
};

TWkd.Ease.prototype.getTiddlerEditField = function(title,field){
 var tiddler = document.getElementById(story.idPrefix + title);
 if(tiddler != null){
 var children = tiddler.getElementsByTagName(&quot;*&quot;)
 var e = null;
 for (var t=0; t&lt;children.length; t++){
 var c = children[t];
 if(c.tagName.toLowerCase() == &quot;input&quot; || c.tagName.toLowerCase() == &quot;textarea&quot;){
 if(!e) {e = c;}
 if(c.getAttribute(&quot;edit&quot;) == field){e = c;}
 }
 }
 if(e){return e;}
 }
} // closes getTiddlerEditField function definition

TWkd.Ease.prototype.getSelection = function(title,quiet) {
 var tiddlerTextArea = this.getTiddlerEditField(title,&quot;text&quot;);
 var result = {};
 if (document.selection != null &amp;&amp; tiddlerTextArea.selectionStart == null) {
 tiddlerTextArea.focus();
 var range = document.selection.createRange();
 var bookmark = range.getBookmark();
 var contents = tiddlerTextArea.value;
 var originalContents = contents;
 var marker = &quot;##SELECTION_MARKER_&quot; + Math.random() + &quot;##&quot;;
 while(contents.indexOf(marker) != -1) {
 marker = &quot;##SELECTION_MARKER_&quot; + Math.random() + &quot;##&quot;;
 }
 var selection = range.text;
 range.text = marker + range.text + marker;
 contents = tiddlerTextArea.value;
 result.start = contents.indexOf(marker);
 contents = contents.replace(marker, &quot;&quot;);
 result.end = contents.indexOf(marker);
 tiddlerTextArea.value = originalContents;
 range.moveToBookmark(bookmark);
 range.select();
 }
 else {
 result.start=tiddlerTextArea.selectionStart;
 result.end=tiddlerTextArea.selectionEnd;
 }
 result.content=tiddlerTextArea.value.substring(result.start,result.end);
 result.source=title;
 if (!result.content&amp;&amp;!quiet) displayMessage(config.messages.Ease.noselection);
 return(result);
}//closes getSelection function definition

// replace selection or insert new content
TWkd.Ease.prototype.putInPlace=function(content,workplace) {
 var tiddlerText = this.getTiddlerEditField(workplace.source,&quot;text&quot;);
 tiddlerText.value = tiddlerText.value.substring(0,workplace.start)+content+tiddlerText.value.substring(workplace.end);
}

// asking for title
TWkd.Ease.prototype.askForTitle = function(suggestion) {
 if (!suggestion)
 suggestion = &quot;&quot;;
 var newtitle;
 while (!newtitle||store.tiddlerExists(newtitle))
 {
 if (store.tiddlerExists(newtitle))
 displayMessage(newtitle+config.messages.Ease.exists);
 newtitle = prompt(config.messages.Ease.asktitle,suggestion);
 if (newtitle==null)
 {
 displayMessage(config.messages.Ease.titlecancel);
 return(false);
 }
 }
 return(newtitle);
}//closes askForTitle function definition

// creation of a new tiddler
TWkd.Ease.prototype.newTWkdLibTiddler = function(title,content,from,askForTags){
 var tiddler = new Tiddler();
 tiddler.title = title;
 tiddler.modifier = config.options.txtUserName;
 tiddler.text = content;
 (from) ? tiddler.tags = [from] : tiddler.tags=[];
 if (askForTags)
 tiddler.tags = prompt(config.messages.Ease.askForTagsLabel,'[['+from+']]').readBracketedList();
 store.addTiddler(tiddler);
 //store.notifyAll();
 displayMessage(title+config.messages.Ease.tiddlercreated);
}

if (!TWkd.Mode)
 TWkd.Mode = function (name,tooltip,ask,operation) {
 this.name = name;
 this.tooltip = tooltip;
 this.ask = ask;
 this.operation = operation;
 };
//}}}</pre>
</div>
<div title="Fermat Numbers" modifier="Joseph" modified="201001310303" created="201001271216" changecount="48">
<pre>Based on this fact: 

If the odd number ''2^^n^^+1'' is prime, then ''n=2^^k^^'', a pure even.

Pierre de Fermat (1601 – 1665) studied the following question:

Given a pure even ''2^^n^^'', will the odd number ''F~~n~~ = 2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1'' be prime?

!Fermat Numbers
Fermat probably started with the following compilation:

|!n|!2^^n^^|!2^^2&lt;html&gt;&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^|!F~~n~~ = 2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1|!Factorization of F~~n~~|
|0| 1| 2| 3| prime F~~0~~|
|1| 2| 4| 5| prime F~~1~~|
|2| 4| 16| 17| prime F~~2~~|
|3| 8| 256| 257| prime F~~3~~|
|4| 16| 65536| 65537| prime F~~4~~|
|5| 32| 4294967296| 4294967297|??|
|''Factorization of F~~n~~ by Fermat''|c

Obviously, Fermat was stuck at F~~5~~. So he couldn't answer his question, but he made a conjecture.

!Fermat Primes
Pierre de Fermat wrote to Marin Mersenne on December 25, 1640 that:

//If I can determine the basic reason why 3, 5, 17, 257, 65537, ...,  are prime numbers, 
I feel that I would find very interesting results, for I have already found marvelous things [along these lines] which I will tell you about later.//

Thus Fermat asserted that all F~~n~~ are primes, although he had no proof of this.

In 1732 Euler discovered 641 divides F~~5~~. It only takes two trial divisions to find this factor because Euler showed that:

Every divisor of a Fermat number F~~n~~ with n &gt; 2 has the form k(2^^n+2^^)+1.

In the case of F~~5~~ this is k(2^^7^^)+1 = 128k+1, so he tried 257 and 641 (129, 385, and 513 are not primes).

|!n|!2^^n^^|!F~~n~~ = 2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1|!Factorization of F~~n~~|!When|!Who|
|5| 32| 4294967297|641*6700417|1732|Euler|
|6| 64| 18446744073709551617|274177*67280421310721|1880|Clausen and Landry|
|7| 128| 340282366920938463463374607431768211457|59649589127497217*5704689200685129054721|1975|Morrison and Brillhart|

With computers, it is shown that all known F~~n~~ for n &gt; 4 are composite, although not all such F~~n~~ are completely factorized.

!Use of Fermat Primes
In 1796, the German teen prodigy Gauss made a discovery that led him to study math further:

The ''regular 17-gon'' is ''constructible'' (by ruler and compass) -- because ''17'' is a ''Fermat prime''!

This is a surprising connection of Fermat primes with geometric constructions. Indeed, what Gauss discovered was more general:

If the Fermat number ''F~~n~~'' is ''prime'', then the ''regular F~~n~~-gon'' can be constructed by ruler and compass.

From this Gauss claimed that:

A ''regular n-gon'' is constructible by ruler and compass if and only if the odd factors of ''n'' are distinct ''Fermat primes''.

However, Gauss only gave the proof for the ''if''-part -- perhaps the ''only-if'' part was left as an exercise. The ''only-if'' part was completed by Wantzel in 1837.

Why? The connection between Fermat primes and geometric constructions belongs to Galois' group theory. Indeed, the group structure of the roots of the equation ''x^^n^^ = 1'' determines its solvability, which is related to ruler and compass constructions.

|!n|!regular n-gon|!Factorization of n|!ruler and compass construction possible?|!Comment|
|3| equilateral triangle| 3 = F~~0~~|yes|known to Greeks|
|4| square| 4 = 2^^2^^|yes|no odd factor|
|5| regular pentagon| 5 = F~~1~~|yes|known to Greeks|
|6| regular hexagon| 6 = 2 F~~0~~|yes|known to Greeks|
|7| regular 7-gon| 7 is prime| no|known to Greeks, but not why|
|8| regular 8-gon| 8 = 2^^3^^|yes|no odd factor|
|9| regular 9-gon| 9 = F~~0~~^^2^^| no|not distinct Fermat primes|
|10| regular 10-gon| 10 = 2 F~~1~~|yes||
|11| regular 11-gon| 11 is prime| no|Greeks didn't know why|
|12| regular 12-gon| 12 = 4 F~~0~~|yes||
|13| regular 13-gon| 13 is prime| no|Greeks didn't know why|
|14| regular 14-gon| 14 = 2*7| no||
|15| regular 15-gon| 15 = F~~0~~F~~1~~|yes|distinct Fermat primes|
|16| regular 16-gon| 16 = 2^^4^^|yes|no odd factor|
|17| regular 17-gon| 17 = F~~2~~|yes|Gauss 1732|
|''Ruler and Compass construction of Regular n-gons''|c

Factoring Fermat numbers is extremely difficult as a result of their large size. This advances the study of primality testing and factorization of special forms.

!Use of Fermat Numbers
Current evidence is that: of the Fermat numbers ''F~~n~~=2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1'', only F~~0~~, F~~1~~, F~~2~~, F~~3~~, F~~4~~ are primes, all F~~n~~ with n &gt; 4 are composite. However, even when F~~n~~ are composite, they are still useful -- they can tell something about primes.

Observe the following pattern of factorization (repeated use of difference of squares) and its relationship with Fermat numbers:

|!Factorization|!Putting x=2|
|x^^2^^-1 = (x-1)(x+1)|2^^2^^-1=F~~0~~|
|x^^4^^-1 = (x^^2^^-1)(x^^2^^+1)=(x-1)(x+1)(x^^2^^+1)|2^^4^^-1=F~~0~~F~~1~~|
|x^^8^^-1 = (x^^4^^-1)(x^^4^^+1)=(x^^2^^-1)(x^^2^^+1)(x^^4^^+1)=(x-1)(x+1)(x^^2^^+1)(x^^4^^+1)|2^^8^^-1=F~~0~~F~~1~~F~~2~~|
|x^^16^^-1 = (x^^8^^-1)(x^^8^^+1)=...=(x-1)(x+1)(x^^2^^+1)(x^^4^^+1)(x^^8^^+1)|2^^16^^-1=F~~0~~F~~1~~F~~2~~F~~3~~|
|x^^32^^-1 = (x^^16^^-1)(x^^16^^+1)=...=(x-1)(x+1)(x^^2^^+1)(x^^4^^+1)(x^^8^^+1)(x^^16^^+1)|2^^32^^-1=F~~0~~F~~1~~F~~2~~F~~3~~F~~4~~|
|x^^64^^-1 = (x^^32^^-1)(x^^32^^+1)=...=(x-1)(x+1)(x^^2^^+1)(x^^4^^+1)(x^^8^^+1)(x^^16^^+1)(x^^32^^+1)|2^^64^^-1=F~~0~~F~~1~~F~~2~~F~~3~~F~~4~~F~~5~~|

This pattern can be continued, giving the result:

2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^ = F~~0~~F~~1~~F~~2~~.....F~~n-1~~ + 1

This is a very spectacular result: pure even = product of pure odds + 1, since all Fermat numbers are odd. Adding 1 to both sides and re-arranging is even more revealing:

F~~n~~ -  F~~0~~F~~1~~F~~2~~.....F~~n-1~~ = 2

A math expert will see this and say, &quot;ah, no ''two'' Fermat numbers share the same ''prime'' factor!&quot;.

Why? Well, all Fermat numbers are odd. If an odd prime p divides F~~n~~ and one of its smaller Fermat numbers, p divides the left side, so p also divides the right side, which is 2. However, no odd prime p can divide 2, therefore F~~n~~ must be relatively prime to all the smaller Fermat numbers. Examination of the factorization of F~~n~~ will confirm this fact.

There are countless Fermat numbers, each with its own distinct prime factors -- hence the number of primes must be ''infinite''.

This is a sweet alternative to Euclid's proof (300 BC) of the infinite supply of primes. The strategy is similar: Euclid added 1 to the product of all smaller primes than a given prime ''p''.
</pre>
</div>
<div title="Finite Interleaving" modifier="Joseph" modified="201003081146" created="201003040247" changecount="24">
<pre>!Finite Interleaving - Periodic
The normal weekdays: 1, 2, 3, 4, 5, 6, 7, ... is a cyclic sequence with ''period'' 7.
The skipping workdays: 1, 3, 5, 7, 2, 4, 6, ... is a cyclic sequence with interleaving. The ''order'' of interleave is 2, because the next term is obtained by adding 2 to the previous term, in modulo 7 arithmetic.

The Beatles has a song titled //Eight Days a Week//. In this fancy world, the weekdays are counted as: 1, 2, 3, 4, 5, 6, 7, 8, .... with ''period'' 8.
If you work one day, sleep the next day, your work-days count as: 1, 3, 5, 7, .... or 2, 4, 6, 8, ..... You'll get 2 interleaving sub-sequence of ''order'' 2, each being shorter, with ''period'' 4.

Why? Let's see. The sequence 1, 2, ...., p has ''period'' p. When interleaving with ''order'' d, starting from a, the successive terms will be: a+d, a+2d, ....  If for some integer k, a+kd &amp;equiv; a (mod p), we shall end up with a sub-sequence of period k. However, this means kd &amp;equiv; 0 (mod p), or kd = pq for some q. Since this is true independent of the starting value a, the various starting values will give n sub-sequences, each with period k. This means p = nk, so n divides p. Since kd = pq = (nk)q, or d = nq, n also divides d. Therefore n is a common divisor of p, d. For the smallest period k, n is the greatest common divisor of p, d, i.e. n = gcd(p,d). It follows that the period k = p/n = p/ gcd(p,d).

Hence we have:
&lt;&lt;&lt;
@@bgcolor(#9DEB95):''Finite Interleaving Theorem''@@:
For the finite sequence 1,2,...,p of ''period'' p, interleaving with ''order'' d (0 &lt; d &lt; p) will give ''gcd(d,p)'' sub-sequences each of period ''p/gcd(p,d)''.
&lt;&lt;&lt;
!Using Prime Periods
If the period p is a ''prime'', gcd(p,d)=1 for all d (0 &lt; d &lt; p). In this case, interleave with any ''order'' d will give a sequence with original ''prime'' period p.

For the normal weekday sequence of period 7, interleaving with various orders gives:
|!Interleaving order|!Interleaved sequence|!Period|!Comment|
|! 1| 1,2,3,4,5,6,7,...| 7|This is the original sequence|
|! 2| 1,3,5,7,2,4,6,...| 7| next is add 2 (mod 7)|
|! 3| 1,4,7,3,6,2,5,...| 7| next is add 3 (mod 7)|
|! 4| 1,5,2,6,3,7,4,...| 7| next is add 4 (mod 7)|
|! 5| 1,6,4,2,7,5,3,...| 7| next is add 5 (mod 7)|
|! 6| 1,7,6,5,4,3,2,...| 7| next is add 6 (mod 7)|
|''Interleaving of period 7 sequence with various orders''|c
!Application of Finite Interleaving
See [[Hard Disk Interleaving]]: old-style hard-disks have 17 sectors per track.</pre>
</div>
<div title="GettingStarted" modifier="YourName" created="200706090852" changecount="1">
<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:
* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* MainMenu: The menu (usually on the left)
* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="Group, Ring and Field" modifier="Joseph" modified="201001220612" created="201001220607" changecount="5">
<pre>We can't get too deep into the math, so we shall skip through, highlighting the role of prime numbers in the theory.

The last words of &amp;Eacute;variste Galois (1811 - 1832) to his brother was, &quot;Don't cry, Alfred! I need all my courage to die at twenty.&quot; Had he been alive today, and knowing all the development of his ideas, this is the story he would like to tell.

!Group
You know everything about adding and subtracting integers? You have no trouble solving 7+x=5 ? OK, let's summarize this knowledge about integer addition: The integers ''Z'' = { 0, &amp;plusmn;1, &amp;plusmn;2, ...} forms a ''Group'' under the operation ''+''.

In general, a ''Group'' is a system with one operation (say #) which is meaningful and equations are solvable:
* the operation # is meaningful if
** a#b is always inside the system (closed)
** a#b#c makes sense without brackets (associative).
* equations in the system are: a#x=b for any element a,b in the system.
** a#x=a is solvable implies the existence of identity e in the system
** a#x=e is solvable implies the existence of inverse of a in the system
While integers ''Z'' forms a group under ''+'', it doesn't form a group under ''*'': the equation 5*x=7 is not solvable in integers. For that we need to extend the integers to fractions, called rational numbers ''Q''. The non-zero elements of ''Q'', denoted by ''Q^^*^^'', forms a group under ''*''.

So we have at least two group examples: ''Z'' under ''+'', and ''Q^^*^^'' under ''*''.

!Ring
The integers ''Z'' forms a group under ''+'', but not a group under ''*'' -- is there anything good we can get from ''*''? Well, we can always multiply two integers within the system, it is only division that's worrying. Let's forget about division for now, and summarize this knowledge about integer addition and multiplication: The integers ''Z'' forms a ''Ring'' under two operations ''+'' and ''*''.

In general, a ''Ring'' is a system with two operations (say # and *) which are meaningful, one nice, and both consistent. If we call the good operation ''add'' (+), and the other operation ''multiply'' (*) --  just names, may or may not be add or multiply of numbers -- the definition can be rephrased as:
a ''Ring'' ''R'' is a system in which add, subtract and multiply can be done consistently:
* the add, subtract part means ''R'' is a group under ''+'', nice means: a+b = b+a (commutative).
* the multiply part means at least a*b and a*b*c are meaningful in ''R''.
* the consistency part means: a*(b+c) = (a*b)+(a*c), (b+c)*a = (b*a)+(c*a) hold (distributive).
The identity of ''+'' is denoted by 0, and the identity of ''*'', if exists, is denoted by 1.

!Field
Since the fractions (or rational numbers) ''Q'' include all integers ''Z'', ''Q'' surely is also a ring with ''+'' and ''*'', but it is much better: division by nonzero fraction always results in a fraction. Let's summarize this knowledge about rational addition and multiplication: The rational numbers ''Q'' forms a ''Field'' under two operations ''+'' and ''*''.

In general, a ''Field'' is a system with two operations (say + and *) which are meaningful, both nice and consistent. Or equivalently:
a ''Field'' ''F'' is a system in which add, subtract, multiply and divide can be done consistently:
* the add, subtract and nice part means ''F'' under ''+'' is a commutative group, its identity is 0.
* the multiply, divide and nice part means ''F^^*^^'' (''F'' exclude 0) under ''*'' is also a commutative group, its identity is 1.
* the consistent part means distribution of ''*'' over ''+'' is valid, i.e. ''F'' is at least a ring under ''+'' and ''*''.

Integers ''Z'' is a group under ''+'', also a ring under ''+'' and ''*''. Rationals ''Q^^*^^'' is a group under ''*'', and ''Q'' a field under ''+'' and ''*''. But integers and rationals are all infinite sets. Are there examples of group, ring and field that are finite?

!Finite Groups
Let's go back and take a look at division of integers ''Z''. It's not that bad after all -- every child learns how to divide integers.

Given two integers b and a&amp;ne;0, we can use long division (or division algorithm) to obtain the quotient q and remainder r: b = q*a + r. If remainder r=0, we say a ''divides'' b, or b is ''divisible'' by a, denoted by ''a|b''. This gives rise to the concept of divisibility -- an interesting idea that leads ultimately to primes and factorization.

When a|b, i.e. a divides b, the equation a*x=b is solvable in ''Z''. Since 1*x=b always has a solution (x=b), so 1 divides any b. Since b*x=b always has a solution (x=1) b divides any b. If 1 and b are the only divisor of b, b is called a ''prime''. Breaking down any b into products (i.e. solving x*y=b) is called a ''factorization'' of b. Keep breaking down the factors we eventually reach the primes, giving b its ''prime factorization'' -- which in ''Z'' happens to be unique, up to ordering of factors and ignoring the unit 1.

What can we do about the remainders? Well, for a given integer n, the possible remainders are 0,1,...,(n-1) -- a finite set. Indeed, if we divide every element of ''Z'' by n, we have the set ''Z/n'' = {0,1,2,...,(n-1)} with n elements. Addition in ''Z'' gives a similar addition in ''Z/n'' -- when we add remainders, if the result exceeds n, we just replace the result by it remainder of division by n. This is cyclic math (or add in modulo n). Because ''Z'' is a group under ''+'', ''Z/n'' is also a group under this modulo ''+''. But this group ''(Z/n,+)'' is finite, with n elements only. It is called the ''Cyclic Group'' of order n, denoted by ''C~~n~~''.

For example, the weekdays are ''Z/7'': Sunday is day 0, Monday is day 1, etc.

!Finite Fields
Recall that ''Z'' is a ring under ''+'' and ''*''. Therefore ''Z/n'', the remainders of modulo n, is also a ring under ''+'' and ''*'', when add and multiply always keep only the remainder of division by n. This ring ''Z/n'', although finite, can be quite shocking: for example 3*4=0 (mod 6). This is because 3*4=12, and 6 divides 12. This means, as a ring, ''Z/6'' has zero divisors -- even 0 has nonzero factors! Better to avoid such queer rings.

Let's turn to another direction: can the ring ''Z/n'' be made into a field? A ring is almost a field, if only the multiplication is nice. In ''Z/n'', there is already the multiplication identity 1. So we ask: how to make a multiplicative inverse for every remainder a in ''Z/n''? That is, how to make a*x=1 (mod n) solvable?

Number theorist proceeds like so: if a*x=1 (mod n), this means when n divides the product a*x, there is a remainder 1. If q is the quotient, we have a*x=q*n+1, or a*x - q*n = 1. Upon seeing this, the number theorist says: a and n must be relatively prime.

Why? Because if a common divisor d divides both a and n, then d also divides a*x, and q*n, so d divides (a*x-q*n), meaning d divides 1. Therefore a and n have only a common divisor 1, or a and n are relatively prime.

Given a modulus n, if it is to be relatively prime to every remainder a, n itself must be a prime -- that's the wonder of primes!

This is the first discovery of Galois, with two related results:
# Every prime ''p'' gives a finite field ''(Z/p,+,*)'' with p elements. This finite field is denoted by ''GF(p)''.
# Every prime ''p'' gives a finite group ''(Z/p^^*^^,*)'' with (p-1) nonzero elements.

The smallest finite field ''GF(2)'' is built from the only even prime ''2'':

|!+|!0|!1| |!*|!1||
|!0|0|1|   |!1|1||
|!1|1|0|   | | ||

This is also called the ''binary field''.
</pre>
</div>
<div title="Hard Disk Interleaving" modifier="Joseph" modified="201003081317" created="201003070458" changecount="40">
<pre>!Reading Disk Sectors
The computer disk is divided into concentric circular tracks. Each circular track is sub-divided into sectors. Each sector is a basic read/write block of data storage on the medium. Suppose the disk manufecturer makes 9 sectors per track, and number the sectors in the usual way: 1,2,3,4,5,6,7,8,9. Remember that a track is circular, so if we linearize it the track looks periodic:
|!Sectors on a (circular) Track|1|2|3|4|5|6|7|8|9|1|2|3|4|5|6|7|8|9|...|
|!Disk Controller (1 read + 1 wait) reading sectors|R|-|X|X|X|X|X|X|X|X|R|-|X|X|X|X|X|X|...|
Each sector is being read/write by the Disk Controller, an electronic interface to the physical disk, which reads the bytes into a buffer. After reading sector #1, say, the buffer is full. The controller must wait for the buffer content to be emptied (i.e. read by the Disk I/O program) before it can refill the buffer. Suppose the situation is 1 Read (R shown above) with 1 Wait (- shown above). By the time the controller is ready, sector #2 has rotated away. The controller will be idle (X shown above) until sector #2 comes around, then read it. Same thing happens when reading successive sectors #3, #4, #5, etc. Can these idle delays be reduced?

Using an interleaving of order 2 (i.e. each next terms is add 2, modulo 9), the sectors can be marked as:
|!Sectors on a (circular) Track, with interleave of order=2|1|3|5|7|9|2|4|6|8|1|3|5|7|9|2|4|6|8|...|
|!Disk Controller (1 read + 4 waits) reading sectors|R|-|-|-|-|R|-|-|-|-|R|-|-|-|-|R|-|-|...|
This would be ideal for a Disk Controller that must wait 4 sectors to pass before it can read again.
An interleave of order 5 (next = add 5, mod 9) would be ideal for the first Disk Controller that must wait 1 sector to pass:
|!Sectors on a (circular) Track, with interleave of order=5|1|6|2|7|3|8|4|9|5|1|6|2|7|3|8|4|9|5|...|
|!Disk Controller (1 read + 1 wait) reading sectors|R|-|R|-|R|-|R|-|R|-|R|-|R|-|R|-|R|-|...|
However, for a Disk Controller that takes 2 waits, an interleave of order 3 still have occasional delays (X) between reads:
|!Sectors on a (circular) Track, with interleave of order=3|1|4|7|2|5|8|3|6|9|1|4|7|2|5|8|3|6|9|...|
|!Disk Controller (1 read + 2 waits) reading sectors|R|-|-|R|-|-|R|-|-|X|R|-|-|R|-|-|R|-|...|
This is because an interleave of order 3 will give 3 shorter sub-sequences: (1,4,7),(2,5,8),(3,6,9). Within sub-sequences, there is no delay, but there will be delay across sub-sequences.

The number of waits for a Disk Controller depends on the Disk I/O program, whose processing time depends on the CPU speed. None of these are known to the Hard Disk Manufacturer, who is now presented with this problem:
//Can the idle delays be avoided for any number of waits? If yes, how many sectors per track will work the best?//
!How many Sectors per Track?
Using the math from [[Finite Interleaving]], the solution to the problem is:
//Yes, by making the sectors per track a ''prime'' number, it can accommodate interleaving of any order, suitable for any number of waits.//

The default standard is 17 sectors per track, for early, primitive hard-drives. Advances in hard-disk technology make the disk geometry more complicated, and the Disk Controller is no longer the deciding factor for the number of sectors per track.
!Interleaving in Modern Drives
This is because while sector read/write is mechanical (need have the sector spin to a spot right under the read/write head), the Disk Controller is electronic. Hard Disk Interleaving is required only when the mechanical spin is //faster// than the electronic response -- which nowadays is rare. With CPU running at ~GHz range, now the electronic response is much faster than the spin rate, and sector interleaving is not required in modern hard drives.

However, the read/write head still needs to move mechanically to read different tracks and cylinders. Simple sequential numbering of tracks and cylinders cause another level of idle waits similar to sequential sectors in the old days. Modern drives use [[Cylinder and Head Skew|http://www.pcguide.com/ref/hdd/geom/tracksSkew-c.html]] to overcome this problem, which is a form of interleaving.
!For more Info
PC Guide: Track Interleaving
http://www.pcguide.com/ref/hdd/geom/tracksInterleaving-c.html
Hard Disk Sector Structures
http://www.dewassoc.com/kbase/hard_drives/hard_disk_sector_structures.htm</pre>
</div>
<div title="Hashing" modifier="Joseph" modified="201003080454" created="201002281348" changecount="166">
<pre>!What is Hashing?
In ordinary English, the word ''hash'' means a mess, jumble, or muddle: //a hash of unorganized facts and figures//.
In computer science, ''hashing'' is used for quick data retrieval based on a key, here //quick// means the time to retrieve is constant.

How does a bad concept become good in computing? Well, like our brains computers are equipped with data storage - either in memory or in disks. The storage must be organized so that data can be put in based on a key, and get back data via the same key. Methods of data storage for efficient data put/get are studied in computer science. It turns out that ''hashing'' is only messy on the surface -- underneath it is fast and effective.
!Indexing and Hashing
An example of data storage is a library. A librarian will register a new book, creates an entry in the catalog, giving the book a unique identification number -- the ''key''. Then the book is shelfed to the appropriate location by the identification number -- ''put'' data. To find the book later, look up the catalog, find the identification number, which gives the location on the shelf -- ''get'' data. The catalog is the master ''index''. This data storage method is called ''indexing''.

Imagine a crazy library: with no shelves, only four walls. The librarian, upon receiving a new book, reads the title and author (the ''key''), then throws a dart. Where the dart hits, the assistant will hang the book there (''put'' data). When you ask for a book, you tell the librarian the title and author (the ''key''). He throws a dart -- where it lands the assistant will pick up the book and give to you (''get'' data). No catalog is required for this crazy method of storage, known as ''hashing'' -- because this library with books hanging on walls look like a mess!

''Indexing'' is not messy: the order is in the index. Without an index, ''hashing'' looks messy; but in reality it is not. This is because the dart-throwing, known as ''hash function'', is very precise: //same key, same spot; different keys, different spots// -- at least in theory.

''Hash functions'' surely are wonderful and magical. But first, let us analyze these two data storage methods in practice:

|!Data Storage Method|!Indexing|!Hashing|!Comment|
|!quick data put/get? | slow when index is large| fast computation, always|so, hashing is good?|
|!conceptual capacity? | infinite (index can grow)| fixed (e.g. 4 walls)|ah, hashing not so good ...|
|!any catch? | index needs maintenance| collision will occur|oh, hashing is bad?|

If the data set is known, hash function can be designed to be ''collision-free'', e.g. a compiler hashing keywords in a programming language. These are called ''prefect hashing''. In general, when data is unknown, or unrestricted, hashing will give ''collision'' -- //different keys, but same spot// -- due to fixed size of the function range: usually restricted to a range of values by modular arithmetic. ''Collision'' is bound to occur in most hashing. However, A well-designed ''hash function'' will give a random-looking distribution of keys, with very few collisions.

''Hashing'' offers fast put/get -- and these are frequent operations. This advantage far outweighs the disadvantage of occasional collision, assuming a good hash function. There are many schemes of hashing, each with its own hash function, and its own way of dealing with collision. We shall skip the many ways to deal with hash collision (read [[here|http://en.wikipedia.org/wiki/Hash_collision]] for some ideas) as they are not related to primes. Instead, we shall take a closer look at ''hash functions'' -- how to throw darts by computation.
!Hashing and Prime
Click [[Try Your Own Hashing]] for examples of ''hash functions'': these are mechanical math computations involving constants for add, subtract, multiply, perhaps divide, and taking remainders in modulo arithmetic: to keep the final result within a specific range of values.

''Hashing'' can be related to prime numbers in two places:
#use of prime constants in hash function -- there are some evidence that primes can lower the probability of collision for typical data.
#use of prime modulo in hash computation -- that is, fix the size of hash table to be prime; again, the collision probability can be minimized.
''Hashing'' maps an unlimited number of keys into a finite space (fixed size), so collision is bound to occur, by the &lt;html&gt;&lt;b&gt;&lt;a title=&quot;When there are more pigeons than holes, there must be a hole with at least two pigeons.&quot;&gt;pigeon-hole principle&lt;/a&gt;&lt;/b&gt;&lt;/html&gt;. A well-designed ''hash function'', using primes or not, can make collision rare for typical, common keys. 

''Hashing'' aims for fast ''hash computation''. To be really fast, hash constants or modulo can be chosen as ''powers of 2'' (2, 4, 8, 16, ...) for binary data -- just like it is fast to multiply, divide or modulo decimal numbers by powers of 10 (10, 100, 1000, ...). However, this makes the hash value looking not much different from the key --  multiply is left-shift, divide is right-shift, modulo is chop-off. Hence different, but sufficiently similar, keys (like different names but with the same surname) will hit the same spot, resulting in a collision. Choosing ''prime'' constants or modulus can avoid such collisions, but there will be others, as collisions are unavoidable for hashing infinite keys. Moreover, multiply, divide and modulo by a prime will mean real computations, taking many more machine cycles than using powers of 2, thus slowing down the ''hash computation'', contrary to the aim.

The [[Java String HashCode]] implementation takes a compromise: the modulo is 2^^32^^ (since Java int is 32-bit), but the constant is 2^^5^^-1=31, a prime. The ''hashCode'' computation uses the prime 31 only as multiplier, not divisor -- and 31x = 2^^5^^x - x, involving 5 left-shifts and 1 subtraction in binary.
!Other Uses of Hashing
Did you notice that the ''hash function'' is a ''one-way function''? It scrambles the key to a value (throw the dart), but there is no need to unscramble the value back to the key (no unthrow of the dart). This ''one-way property'' is useful in the following:
# ''Digital Signature'' -- When you download a file from Internet, how to ensure that it is good: no missing bytes from download, no extra bytes by virus-hackers, or just some altered bytes due to transmission error? Well, a file is just a long String, which can be taken as a key to a ''hash function'', giving a hash value that serves as a ''digital signature'' of the file. Any missing or extra or changed bytes will alter the key, hashing to a different value. Yes, collision in hashing is unavoidable, so there is a chance that the file is changed but giving the same hash value. To make this rare, you'll use a more complicated ''hash function'' (for this use, fast is not important, only desirable), and produce a longer hash value. For example, [[OpenOffice|http://download.openoffice.org/index.html]] download includes [[MD5 checksum|http://download.openoffice.org/md5sums/]] (with [[Instructions for use|http://www.openoffice.org/dev_docs/using_md5sums.html]]) as digital signature. The ~MD5 checksum is a 128-bit binary number, or 32 hexadecimal digits.&lt;html&gt;&lt;p&gt;&lt;/html&gt;
# ''Password Verification'' -- Passwords are usually not stored in cleartext, for obvious reasons, but instead in digest form. To authenticate a user, the password presented by the user is hashed and compared with the stored hash. For such systems, if you forget the password, even the administrator cannot tell you what it is; the administrator can only reset your password. This mechanism is used in Unix, Linux (e.g. [[crypt(3)|http://en.wikipedia.org/wiki/Crypt_(Unix)]]) and Windows (e.g. [[LM Hash|http://en.wikipedia.org/wiki/LM_hash]] of Microsoft).
These ''cryptographic hash functions'' aim for complexity, making them effectively ''one-way''. Use of primes is generally not a priority in the algorithm. Yet in ''[[SHA-256 Hashing|http://en.wikipedia.org/wiki/SHA_hash_functions]]'' (used in [[SSL Certificate]] digital signatures), square-roots and cube-roots of primes appear as constants in the computation. You can also use one-half of [[RSA|Key pairs for RSA]] (just keep the modulus and public key, throw away the private key), which depends on primes, for ''one-way hashing''.</pre>
</div>
<div title="HideWhenPlugin" modifier="YannPerrin" modified="200701311908" created="200610180258" tags="systemConfig MonkeyPirateTW">
<pre>/***
| Name:|HideWhenPlugin|
| Description:|Allows conditional inclusion/exclusion in templates|
| Version:|6.9.3|
| Date:|30-Sep-2006|
| Source:|http://mptw.tiddlyspot.com/#HideWhenPlugin|
| Author:|Simon Baird &lt;simon.baird@gmail.com&gt;|
For use in ViewTemplate and EditTemplate. Eg
{{{&lt;div macro=&quot;showWhen tiddler.tags.contains('Task')&quot;&gt;[[TaskToolbar]]&lt;/div&gt;}}}
{{{&lt;div macro=&quot;showWhen tiddler.modifier == 'BartSimpson'&quot;&gt;&lt;img src=&quot;bart.gif&quot;/&gt;&lt;/div&gt;}}}
***/
//{{{
merge(config.macros,{

 hideWhen: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
 if (eval(paramString)) {
 removeChildren(place);
 place.parentNode.removeChild(place);
 }
 }},

 showWhen: { handler: function (place,macroName,params,wikifier,paramString,tiddler) {
 config.macros.hideWhen.handler(place,macroName,params,wikifier,'!('+paramString+')',tiddler);
 }}

});

//}}}</pre>
</div>
<div title="History of RSA" modifier="Joseph" modified="201001311245" created="201001240327" changecount="8">
<pre>Who come up with the idea of Public Key Cryptography?

!The Popular Version
In 1976, Whitfield Diffie and Martin Hellman described the idea of public key cryptography, by using a ''trapdoor'' function to make decryption without private key hard. They suggested a plausible trapdoor function, but did not implement it. That was implemented in 1977 by 3 MIT mathematicians, and they devised another algorithm based on easy-to-multiply but hard-to-factorize: the ''RSA'' algorithm.

!The Secret Version
Around 1969 and early 1970s, people in UK's GCHQ (Government Communications Headquarters, i.e. national spies agency) had already developed these ideas, including the RSA algorithm. However, due to secrecy, they could not publish anything then, and could not say anything when the events of 1976/77 unfolded -- they are allowed to talk about it only much later. GCHQ put the RSA algorithm for checking by math experts, and they could not find any flaws. But GCHQ did not trust the new algorithm, so they never implemented and made use of it.

For more information, read:

The Open Secret
[[http://www.wired.com/wired/archive/7.04/crypto_pr.html|crypto_pr.html]]
</pre>
</div>
<div title="How to Format Text" modifier="GiffMex" modified="200703071359" created="200703051332" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200703071359">
<pre>|!Format|!It will look like this...|!...if you format it like this...|
|Bold-faced type|''text''|{{{''text''}}}|
|Italic text|//text//|{{{//text//}}}|
|Underlined text|__text__|{{{__text__}}}|
|Strike-through text|--text--|{{{--text--}}}|
|Links with wikiwords|EnchiLada (inactive link - no tiddler yet)&lt;br&gt;WikiWord (active link to tiddler)|{{{EnchiLada}}}&lt;br&gt;{{{WikiWord}}}|
|~De-Wikify a ~WikiWord|~WikiWord, ~EnchiLada|{{{~WikiWord, ~EnchiLada}}}|
|Links with brackets|[[How to add background images]]|{{{[[How to add background images]]}}}|
|Pretty links|[[display text|ColorSchemes]] - links to the tiddler of color schemes|{{{[[display text|ColorSchemes]]}}}|
|External links work the same way:|http://groups.google.com/group/TiddlyWiki &lt;br&gt;&lt;br&gt;[[TiddlyWiki Google group|http://groups.google.com/group/TiddlyWiki]]|{{{http://groups.google.com/group/TiddlyWiki}}} &lt;br&gt;&lt;br&gt; {{{[[TiddlyWiki Google group|http://groups.google.com/group/TiddlyWiki]]}}}|
|Links to local files|To a file on a CD in your D drive: &lt;br&gt;&lt;br&gt;To a file on your USB stick on your e drive: &lt;br&gt;&lt;br&gt;To a file in your hard drive:|{{{file:///D:/filename.doc/}}}&lt;br&gt;&lt;br&gt;{{{file:///E:/filename.doc/}}}&lt;br&gt;&lt;br&gt;{{{file:///C:/filepath/filename.doc/}}}|
|Colored text|@@color(green):green colored@@|{{{@@color(green):green colored@@}}}|
|Text with colored background|@@bgcolor(#ff0000):color(#ffffff):red colored@@|{{{@@bgcolor(#ff0000):color(#ffffff):red colored@@}}}|
|Highlighting|@@text@@|{{{@@text@@}}}|
|Superscript|2^^3^^=8|{{{2^^3^^=8}}}|
|Subscript|a~~ij~~ = -a~~ji~~|{{{a~~ij~~ = -a~~ji~~}}}|

''Simple indenting:''
{{{ {{indent{text }}} produces:

{{indent{text

''Numbered lists:''
{{{#item one }}}
{{{##Item 1a}}}
{{{###Item 1ai}}}

produces:
#item one
##Item 1a
###Item 1ai
''Bulleted lists:''
{{{*Bullet one}}}
{{{**Bullet two}}}
{{{***Bullet three}}}

produces:
*Bullet one
**Bullet two
***Bullet level three
''Headlines''

{{{!Text}}} produces:
!Text
{{{!!Text}}} produces:
!!Text
{{{!!!Text}}} produces:
!!!Text
and so on.

''Tables:''
This is the formatting:

{{{|!Table header|!Column Two|}}}
{{{|&gt;| colspan |}}}
{{{| rowspan |left aligned|}}}
{{{|~| right aligned|}}}
{{{|bgcolor(#DC1A1A):colored| centered |}}}
{{{||*lists&lt;br&gt;*within&lt;br&gt;*tables&lt;br&gt;&lt;br&gt;and double-spaced too|}}}
{{{|caption|c}}}

This is the result:

|!Table header|!Column Two|
|&gt;| colspan |
| rowspan |left aligned|
|~| right aligned|
|bgcolor(#DC1A1A):colored| centered |
||*lists&lt;br&gt;*within&lt;br&gt;*tables&lt;br&gt;&lt;br&gt;and double-spaced too|
|caption|c

To align a cell so that its text displays at the top rather than the center, add {{{vertical-align:top;}}} at the beginning of the cell.

''Images:''
{{{[img[http://farm1.static.flickr.com/39/122259544_6913ca58f3_m.jpg]]}}} is the formatting for:

[img[http://farm1.static.flickr.com/39/122259544_6913ca58f3_m.jpg]]

''Dotted horizontal lines:''
{{{----}}} produces:
----

''Line-by-line blockquotes:''
{{{&gt;level 1}}}
{{{&gt;level 1}}}
{{{&gt;&gt;level 2}}}
{{{&gt;&gt;level 2}}}
{{{&gt;&gt;&gt;level 3}}}
{{{&gt;&gt;&gt;level 3}}}
{{{&gt;&gt;level 2}}}
{{{&gt;level 1}}}

produces:
&gt;level 1
&gt;level 1
&gt;&gt;level 2
&gt;&gt;level 2
&gt;&gt;&gt;level 3
&gt;&gt;&gt;level 3
&gt;&gt;level 2
&gt;level 1

''Extended blockquotes:''
{{{&lt;&lt;&lt;}}}
{{{Extended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotes}}}
{{{&lt;&lt;&lt;}}}

produces:
&lt;&lt;&lt;
Extended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotesExtended blockquotes
&lt;&lt;&lt;</pre>
</div>
<div title="ISBN check digit" modifier="Joseph" modified="201001311243" created="201001181311" changecount="28">
<pre>Take any book, and you should find its International Standard Book Numbers (ISBN). It is a code with 10 digits -- the last digit is a ''check digit''. It is designed in such a way that, if the ISBN is copied with specific types of error, that error will be detected.

&lt;html&gt;
&lt;form&gt;
&lt;table width=&quot;80%&quot; border=&quot;3&quot; bgcolor=&quot;#EBBC55&quot;&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       ISBN (?=check-digit): &lt;INPUT name=&quot;isbn&quot; type=&quot;text&quot; size=&quot;20%&quot; value=&quot;0-306-40615-?&quot;&gt;
       modulus N: &lt;INPUT name=&quot;mod&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;11&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
            onClick=&quot;Logger.set('isbn.logger'); try {new ISBN(isbn.value, parseInt(mod.value)).run();} catch (error) {alert(error);}&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot;&gt;&lt;textarea id=&quot;isbn.logger&quot; cols=&quot;100%&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/html&gt;

Enter the ISBN as &quot;0-306-40615-?&quot;, leaving the check digit with a question mark &quot;?&quot;. Press ''Go''. See what the check-digit is, and what errors are detected.

!ISBN
The ISBN check digit is determined by a formula making use of ''Cyclic Math'' in modulus ''n''. 
Ignoring the hyphens &quot;-&quot;, let ''d~~j~~'' be the ''j-th'' digit, so that the check digit is ''d~~10~~''. The ''check sum'' is calculated by:

check sum = ''10*d~~1~~+9*d~~2~~+8*d~~3~~+7*d~~4~~+6*d~~5~~+5*d~~6~~+4*d~~7~~+3*d~~8~~+2*d~~9~~+d~~10~~ (mod n)''

For a valid ISBN,  check sum = ''0 (mod n)''.

The actual ISBN in use takes modulus ''n=11'', a prime. The ISBN check digit can range from 0 to 10, when it is 10, the symbol X is used instead.

!Errors Detected by ISBN
For the example ISBN = 0-306-40615-?, the check digit is ''2'' in modulus ''11''. In this case, the calculation is:

|!ISBN digit|0|3|0|6|4|0|6|1|5|2|
|!multiplier|10|9|8|7|6|5|4|3|2|1|
|!check sum|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|10*0+9*3+8*0+7*6+6*4+5*0+4*6+3*1+2*5+1*2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=0+27+0+42+24+0+24+3+10+2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=132 (mod 11) = 0, ISBN checked OK.|

If there is an error in, say, digit 3, the calculation becomes:

|!ISBN digit|0|3|@@9@@|6|4|0|6|1|5|2|
|!multiplier|10|9|8|7|6|5|4|3|2|1|
|!check sum|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|10*0+9*3+8*9+7*6+6*4+5*0+4*6+3*1+2*5+1*2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=0+27+72+42+24+0+24+3+10+2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=204 (mod 11) = 6 &amp;ne; 0, ISBN error.|

If there is a transposition error, say digits 4 and 5 are swapped, the calculation becomes:

|!ISBN digit|0|3|0|@@4@@|@@6@@|0|6|1|5|2|
|!multiplier|10|9|8|7|6|5|4|3|2|1|
|!check sum|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|10*0+9*3+8*0+7*4+6*6+5*0+4*6+3*1+2*5+1*2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=0+27+0+28+36+0+24+3+10+2|
||&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|=130 (mod 11) = 9 &amp;ne; 0, ISBN error.|

This error-detection property of ISBN under modulus 11 is closely related to the fact that modular multiplication of 11 forms a group, the multiplicative group of ''GF(11)''. Cyclic multiplication only forms a group under a prime modulus ''p'', ''(Z/p^^*^^, *)''.

In the ISBN interactive, try other modulus instead of 11 to see how the check digit change, and see if digit and transposition errors can be detected. The results should look like:

|!Choices of modulus n|!ISBN for 0-306-40615-?|!Digit errors detected?|!Transposition errors detected?|!Comments|
|11|0-306-40615-2|yes|yes|11 is a prime|
|12|0-306-40615-2|no|no||
|13|0-306-40615-0|yes|yes|13 is a prime|
|10|0-306-40615-0|no|no||
|16|0-306-40615-B|no|no||
|17|0-306-40615-6|yes|yes|17 is a prime|
|5|0-306-40615-0|no|no||

!More Information
Secrets of the ISBN - An Error Detection Method
[[http://www.ee.unb.ca/tervo/ee4253/isbn.html|isbn.html]]

The International Standard Book Numbers work with a check digit, which exploits the fact that 11 is a prime.
http://en.wikipedia.org/wiki/International_Standard_Book_Number
</pre>
</div>
<div title="Infinite Interleaving" modifier="Joseph" modified="201003081312" created="201003040248" changecount="43">
<pre>!Infinite Interleaving - Aperiodic
The sequence 1,2,3,... is infinite, without any period. But you can interleave in any order, which is equivalent to splitting the sequence into parts.

Imagine a bank with 5 counters, but only 1 main queue, with customers 1, 2, 3, 4, 5, 6, 7, 8, 9, ... (no ending). Assume the same time for customer service, the counters will serve these customers:
|!Counter 1|1, 6, 11, 16, ...|
|!Counter 2|2, 7, 12, 17, ...|
|!Counter 3|3, 8, 13, 18, ...|
|!Counter 4|4, 9, 14, 19, ...|
|!Counter 5|5, 10, 15, 20, ...|
|''A bank with 5 Counters''|c

Note that all multiples of 5 goes to Counter 5, which is obvious. Other than that:
|!all multiples of 4|4,8,12,16,20,...|in Counters 1,2,3,4,5|
|!all multiples of 3|3,6,9,12,15,...|in Counters 1,2,3,4,5|
|!all multiples of 2|2,4,6,8,10,...|in Counters 1,2,3,4,5|
|''Distribution of multiples for 5 Counters''|c

However, if the bank has only 4 counters instead of 5, the result about multiples is different:
|!Counter 1|1, 5, 9, 13, ...|
|!Counter 2|2, 6, 10, 14, ...|
|!Counter 3|3, 7, 11, 15, ...|
|!Counter 4|4, 8, 12, 16, ...|
|''A bank with 4 Counters''|c

|!all multiples of 3|3,6,9,12,...|in Counters 1,2,3,4|
|!all multiples of 2|2,4,6,8,...|in Counters 2,4 only|
|''Distribution of multiples for 4 Counters''|c

Note that multiples of 2 now spreads over not all the 4 Counters, but only 2 of them.

Why? Let's see. If the infinite sequence 1,2,3,.... is interleaved into p parts, the result looks like:
|!Parts|!Terms|!Comment|
|!Part 1|1, 1+p, 1+2p, 1+3p, 1+4p, 1+5p, .....| x &amp;equiv; 1 (mod p)|
|!Part 2|2, 2+p, 2+2p, 2+3p, 2+4p, 2+5p, .....| x &amp;equiv; 2 (mod p)|
|!Part 3|3, 3+p, 3+2p, 3+3p, 3+4p, 3+5p, .....| x &amp;equiv; 3 (mod p)|
|!....| ....| ...|
|!Part p|p, 2p, 3p, 4p, 5p, ...| x &amp;equiv; 0 (mod p)|
|''Infinite sequence interleaved into p Parts''|c

Note that the parts are the different remainders under modulo p. The multiples of k (0 &lt; k &lt; p) are: k, 2k, 3k, ..... Under modulo p, these multiples become: k (mod p), 2k (mod p), 3k (mod p), .... To find out how many parts these multiples of k will spread over is the same as asking: how many multiples of k in mod p are distinct?

For any p, the modulo arithmetic Z~~p~~ = Z/p under addition is a cyclic group G, the additive identity is 0.
For a given k, the multiples of k generates a cyclic subgroup &lt;k&gt; of G, with the same additive identity 0.

This means there is a smallest x such that xk = 0 (mod p), or xk = hp for some h.
Denote this common product by q, i.e. q = hp = xk.
Since q is a multiple of p (q=hp) and also a multiple of k (q = xk), q is a common multiple of p, k.
Since x is the smallest, q is the least common multiple of p, k, i.e. q = lcm(p,k).
Therefore number of distinct remainders of multiples of k in mod p = x = q/k = lcm(p,k)/k = (kp/gcd(p,k))/k = p/gcd(p,k).

We therefore have:
&lt;&lt;&lt;
@@bgcolor(#9DEB95):''Infinite Interleaving Theorem''@@:
For the infinite sequence 1,2,3,... interleaving into p ''parts'', ''multiples'' of k (0 &lt; k &lt; p) will spread over ''p/gcd(p,k)'' parts.
&lt;&lt;&lt;
!Using Prime Parts
If the number of parts p is a ''prime'', gcd(p,k)=1 for all k (0 &lt; k &lt; p). Hence interleaving the infinite sequence into ''prime'' parts guarantees all ''multiples'' of k (0 &lt; k &lt; p) will spread over all the parts.

An example of interleaving 1,2,3,4,5,.... into 7 parts is shown:
|!Part|!Terms|!Comment|!Has 1x?|!Has 2x?|!Has 3x?|!Has 4x?|!Has 5x?|!Has 6x?|
|! 1| 1, 8,@@bgcolor(#F3A1EE):15@@,22,29,36,43,...| x &amp;equiv; 1 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 2| 2, 9,16,23,@@bgcolor(#F3A1EE):30@@,37,44,...| x &amp;equiv; 2 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 3| 3,@@bgcolor(#F3A1EE):10@@,17,24,31,38,@@bgcolor(#F3A1EE):45@@,...| x &amp;equiv; 3 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 4| 4,11,18,@@bgcolor(#F3A1EE):25@@,32,39,46,...| x &amp;equiv; 4 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 5| @@bgcolor(#F3A1EE):5@@,12,19,26,33,@@bgcolor(#F3A1EE):40@@,47,...| x &amp;equiv; 5 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 6| 6,13,@@bgcolor(#F3A1EE):20@@,27,34,41,48,...| x &amp;equiv; 6 (mod 7)| yes| yes| yes| yes| yes| yes|
|! 7| 7,14,21,28,@@bgcolor(#F3A1EE):35@@,42,49,...| x &amp;equiv; 0 (mod 7)| yes| yes| yes| yes| yes| yes|
|''Infinite sequence interleaved into 7 Parts''|c
The multiples of 5 are marked, and they spread over all the 7 parts. You can easily verify that this is also true for multiples of 1,2,3,4,6.
!Application of Infinite Interleaving
See [[Memory Bank Interleaving]]: some supercomputers and high-end serves have 5 or 7 banks for parallel memory.</pre>
</div>
<div title="InlineJavascriptPlugin" modifier="churu1" created="200706041426" tags="systemConfig includeNew TidIDEPackage BackstagePackage MenuPackage MediaPackage">
<pre>/***
|Name|InlineJavascriptPlugin|
|Source|http://www.TiddlyTools.com/#InlineJavascriptPlugin|
|Version|1.6.0|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;&lt;br&gt;&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides||
|Description|Insert Javascript executable code directly into your tiddler content.|

''Call directly into TW core utility routines, define new functions, calculate values, add dynamically-generated TiddlyWiki-formatted output'' into tiddler content, or perform any other programmatic actions each time the tiddler is rendered.
!!!!!Usage
&lt;&lt;&lt;
When installed, this plugin adds new wiki syntax for surrounding tiddler content with {{{&lt;script&gt;}}} and {{{&lt;/script&gt;}}} markers, so that it can be treated as embedded javascript and executed each time the tiddler is rendered.

''Deferred execution from an 'onClick' link''
By including a {{{label=&quot;...&quot;}}} parameter in the initial {{{&lt;script&gt;}}} marker, the plugin will create a link to an 'onclick' script that will only be executed when that specific link is clicked, rather than running the script each time the tiddler is rendered.  You may also include a {{{title=&quot;...&quot;}}} parameter to specify the 'tooltip' text that will appear whenever the mouse is moved over the onClick link text

''External script source files:''
You can also load javascript from an external source URL, by including a src=&quot;...&quot; parameter in the initial {{{&lt;script&gt;}}} marker (e.g., {{{&lt;script src=&quot;demo.js&quot;&gt;&lt;/script&gt;}}}).  This is particularly useful when incorporating third-party javascript libraries for use in custom extensions and plugins.  The 'foreign' javascript code remains isolated in a separate file that can be easily replaced whenever an updated library file becomes available.

''Display script source in tiddler output''
By including the keyword parameter &quot;show&quot;, in the initial {{{&lt;script&gt;}}} marker, the plugin will include the script source code in the output that it displays in the tiddler.

''Defining javascript functions and libraries:''
Although the external javascript file is loaded while the tiddler content is being rendered, any functions it defines will not be available for use until //after// the rendering has been completed.  Thus, you cannot load a library and //immediately// use it's functions within the same tiddler.  However, once that tiddler has been loaded, the library functions can be freely used in any tiddler (even the one in which it was initially loaded).

To ensure that your javascript functions are always available when needed, you should load the libraries from a tiddler that will be rendered as soon as your TiddlyWiki document is opened.  For example, you could put your {{{&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;}}} syntax into a tiddler called LoadScripts, and then add {{{&lt;&lt;tiddler LoadScripts&gt;&gt;}}} in your MainMenu tiddler.

Since the MainMenu is always rendered immediately upon opening your document, the library will always be loaded before any other tiddlers that rely upon the functions it defines.  Loading an external javascript library does not produce any direct output in the tiddler, so these definitions should have no impact on the appearance of your MainMenu.

''Creating dynamic tiddler content''
An important difference between this implementation of embedded scripting and conventional embedded javascript techniques for web pages is the method used to produce output that is dynamically inserted into the document:
* In a typical web document, you use the document.write() function to output text sequences (often containing HTML tags) that are then rendered when the entire document is first loaded into the browser window.
* However, in a ~TiddlyWiki document, tiddlers (and other DOM elements) are created, deleted, and rendered &quot;on-the-fly&quot;, so writing directly to the global 'document' object does not produce the results you want (i.e., replacing the embedded script within the tiddler content), and completely replaces the entire ~TiddlyWiki document in your browser window.
* To allow these scripts to work unmodified, the plugin automatically converts all occurences of document.write() so that the output is inserted into the tiddler content instead of replacing the entire ~TiddlyWiki document.

If your script does not use document.write() to create dynamically embedded content within a tiddler, your javascript can, as an alternative, explicitly return a text value that the plugin can then pass through the wikify() rendering engine to insert into the tiddler display.  For example, using {{{return &quot;thistext&quot;}}} will produce the same output as {{{document.write(&quot;thistext&quot;)}}}.

//Note: your script code is automatically 'wrapped' inside a function, {{{_out()}}}, so that any return value you provide can be correctly handled by the plugin and inserted into the tiddler.  To avoid unpredictable results (and possibly fatal execution errors), this function should never be redefined or called from ''within'' your script code.//

''Accessing the ~TiddlyWiki DOM''
The plugin provides one pre-defined variable, 'place', that is passed in to your javascript code so that it can have direct access to the containing DOM element into which the tiddler output is currently being rendered.

Access to this DOM element allows you to create scripts that can:
* vary their actions based upon the specific location in which they are embedded
* access 'tiddler-relative' information (use findContainingTiddler(place))
* perform direct DOM manipulations (when returning wikified text is not enough)
&lt;&lt;&lt;
!!!!!Examples
&lt;&lt;&lt;
an &quot;alert&quot; message box:
&gt;&lt;script show&gt;
   alert('InlineJavascriptPlugin: this is a demonstration message');
&lt;/script&gt;
dynamic output:
&gt;&lt;script show&gt;
  return (new Date()).toString();
&lt;/script&gt;
wikified dynamic output:
&gt;&lt;script show&gt;
   return &quot;link to current user: [[&quot;+config.options.txtUserName+&quot;]]&quot;;
&lt;/script&gt;
dynamic output using 'place' to get size information for current tiddler:
&gt;&lt;script show&gt;
   if (!window.story) window.story=window;
   var title=story.findContainingTiddler(place).id.substr(7);
   return title+&quot; is using &quot;+store.getTiddlerText(title).length+&quot; bytes&quot;;
&lt;/script&gt;
creating an 'onclick' button/link that runs a script:
&gt;&lt;script label=&quot;click here&quot; title=&quot;clicking this link will show an 'alert' box&quot; show&gt;
   if (!window.story) window.story=window;
   alert(&quot;Hello World!\nlinktext='&quot;+place.firstChild.data+&quot;'\ntiddler='&quot;+story.findContainingTiddler(place).id.substr(7)+&quot;'&quot;);
&lt;/script&gt;
loading a script from a source url:
&gt;http://www.TiddlyTools.com/demo.js contains:
&gt;&gt;{{{function demo() { alert('this output is from demo(), defined in demo.js') } }}}
&gt;&gt;{{{alert('InlineJavascriptPlugin: demo.js has been loaded'); }}}
&gt;&lt;script src=&quot;demo.js&quot; show&gt;
  return &quot;loading demo.js...&quot;
&lt;/script&gt;
&gt;&lt;script label=&quot;click to execute demo() function&quot; show&gt;
    demo()
&lt;/script&gt;
&lt;&lt;&lt;
!!!!!Installation
&lt;&lt;&lt;
import (or copy/paste) the following tiddlers into your document:
''InlineJavascriptPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)
&lt;&lt;&lt;
!!!!!Revision History
&lt;&lt;&lt;
''2007.02.19 [1.6.0]'' added support for title=&quot;...&quot; to specify mouseover tooltip when using an onclick (label=&quot;...&quot;) script
''2006.10.16 [1.5.2]'' add newline before closing '}' in 'function out_' wrapper.  Fixes error caused when last line of script is a comment.
''2006.06.01 [1.5.1]'' when calling wikify() on script return value, pass hightlightRegExp and tiddler params so macros that rely on these values can render properly
''2006.04.19 [1.5.0]'' added 'show' parameter to force display of javascript source code in tiddler output
''2006.01.05 [1.4.0]'' added support 'onclick' scripts.  When label=&quot;...&quot; param is present, a button/link is created using the indicated label text, and the script is only executed when the button/link is clicked.  'place' value is set to match the clicked button/link element.
''2005.12.13 [1.3.1]'' when catching eval error in IE, e.description contains the error text, instead of e.toString().  Fixed error reporting so IE shows the correct response text.  Based on a suggestion by UdoBorkowski
''2005.11.09 [1.3.0]'' for 'inline' scripts (i.e., not scripts loaded with src=&quot;...&quot;), automatically replace calls to 'document.write()' with 'place.innerHTML+=' so script output is directed into tiddler content.  Based on a suggestion by BradleyMeck
''2005.11.08 [1.2.0]'' handle loading of javascript from an external URL via src=&quot;...&quot; syntax
''2005.11.08 [1.1.0]'' pass 'place' param into scripts to provide direct DOM access
''2005.11.08 [1.0.0]'' initial release
&lt;&lt;&lt;
!!!!!Credits
&lt;&lt;&lt;
This feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.inlineJavascript= {major: 1, minor: 6, revision: 0, date: new Date(2007,2,19)};

config.formatters.push( {
 name: &quot;inlineJavascript&quot;,
   match: &quot;\\&lt;script&quot;,
    lookahead: &quot;\\&lt;script(?: src=\\\&quot;((?:.|\\n)*?)\\\&quot;)?(?: label=\\\&quot;((?:.|\\n)*?)\\\&quot;)?(?: title=\\\&quot;((?:.|\\n)*?)\\\&quot;)?( show)?\\&gt;((?:.|\\n)*?)\\&lt;/script\\&gt;&quot;,

 handler: function(w) {
        var lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);
      lookaheadRegExp.lastIndex = w.matchStart;
     var lookaheadMatch = lookaheadRegExp.exec(w.source)
       if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
          if (lookaheadMatch[1]) { // load a script library
             // make script tag, set src, add to body to execute, then remove for cleanup
              var script = document.createElement(&quot;script&quot;); script.src = lookaheadMatch[1];
              document.body.appendChild(script); document.body.removeChild(script);
         }
         if (lookaheadMatch[5]) { // there is script code
              if (lookaheadMatch[4]) // show inline script code in tiddler output
                   wikify(&quot;{{{\n&quot;+lookaheadMatch[0]+&quot;\n}}}\n&quot;,w.output);
              if (lookaheadMatch[2]) { // create a link to an 'onclick' script
                  // add a link, define click handler, save code in link (pass 'place'), set link attributes
                    var link=createTiddlyElement(w.output,&quot;a&quot;,null,&quot;tiddlyLinkExisting&quot;,lookaheadMatch[2]);
                   link.onclick=function(){try{return(eval(this.code))}catch(e){alert(e.description?e.description:e.toString())}}
                    link.code=&quot;function _out(place){&quot;+lookaheadMatch[5]+&quot;\n};_out(this);&quot;
                    link.setAttribute(&quot;title&quot;,lookaheadMatch[3]?lookaheadMatch[3]:&quot;&quot;);
                    link.setAttribute(&quot;href&quot;,&quot;javascript:;&quot;);
                 link.style.cursor=&quot;pointer&quot;;
                }
             else { // run inline script code
                  var code=&quot;function _out(place){&quot;+lookaheadMatch[5]+&quot;\n};_out(w.output);&quot;
                 code=code.replace(/document.write\(/gi,'place.innerHTML+=(');
                    try { var out = eval(code); } catch(e) { out = e.description?e.description:e.toString(); }
                    if (out &amp;&amp; out.length) wikify(out,w.output,w.highlightRegExp,w.tiddler);
              }
         }
         w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
 }
} )
//}}}</pre>
</div>
<div title="Interleaving" modifier="Joseph" modified="201003080813" created="201002281350" changecount="153">
<pre>!What is Interleaving?
In English, to ''interleave'' is to insert something alternately and regularly between something else: //Interleave carbon paper between pages//.

Every child learns to count the weekdays: 1, 2, 3, 4, 5, 6, 7, 1, 2, .... This is a cyclic sequence, no interleaving.
If you work one day, rest the next day, your work-days count as: 1, 3, 5, 7, 2, 4, 6, 1, 3, ... This is still cyclic, with interleaving.

Compared to a cyclic sequence, an interleaving cycle looks complicated. How can this be useful in computer science? It turns out that smart interleaving can reduce unneccessary delays, and //smart// means using primes!

But first, let's take a closer look at Interleaving. 
!Finite and Infinite Interleaving
The example above takes a ''finite'' sequence, 1,2,3,4,5,6,7 and repeats it, making it periodic with a ''period'' 7.
We shall say that the interleaving sequence: 1,3,5,7,2,4,6,... has ''order'' 2, which is the difference between successive terms (in modulo 7).
So this is an example of a period-7 sequence with interleaving of order 2.
We shall be interested in the question: what ''periods'' can accommodate interleaving of any ''order''?
Click [[Finite Interleaving]] for more discussion.

The ''infinite'' sequence 1,2,3,4,5,6,7,8,9,... has no period. But you can interleave by //pulling// alternating 2^^nd^^ numbers to start another sequence, like so:
1, 3, 5, 7, ...  (the odds, or remainder = 1 when divided by 2)
2, 4, 6, 8, ...  (the evens, or remainder = 0 when divided by 2)
This is an example of interleaving the infinite sequence into 2 ''parts''.
Note that ''multiples'' of 2 are in the evens, but multiples of 3 (3, 6, 9,...) are in both odds and evens. How about multiples of 4? multiples of 5?
In general, the infinite sequence can be interleaved into any number of parts. We shall be interested in the distribution of ''multiples'' in the ''parts''.
Click [[Infinite Interleaving]] for further discussion.

To experiment with interleaving sequences, finite or infinite, open [[Try Your Own Interleaving]].
!Interleaving and Prime
Prime numbers can be important in both types of interleaving:
#From [[Finite Interleaving]] we have this corollary: &lt;html&gt;&lt;br&gt;&lt;/html&gt;For the cyclic sequence 1, 2, 3, ..., p, 1, 2,..., a prime period ''p'' allows good interleaving of any order ''d'', as gcd(p,d)=1.&lt;html&gt;&lt;p&gt;&lt;/html&gt;This is used in [[Hard Disk Interleaving]], with the default standard of 17 sectors per track. However, this feature is only relevant to old-style disk controllers, which are slow compared to the spinning disc. Nowadays, although the disc is spinning very fast, the disk controller can respond even faster. Modern hard disk technology doesn't need interleaving for performance.&lt;html&gt;&lt;p&gt;&lt;/html&gt;
#From [[Infinite Interleaving]] we have this corollary: &lt;html&gt;&lt;br&gt;&lt;/html&gt;The infinite sequence 1, 2, 3, ... interleaving into prime parts ''p'' allows good distribution of any multiples of ''k'', as gcd(p,k)=1.&lt;html&gt;&lt;p&gt;&lt;/html&gt;This is used in [[Memory Bank Interleaving]]: for example, super-computers and high-end servers have parallel access to 5 or 7 memory banks. Personal Computer (PC) technology is starting to have dual-core for CPU, while parallel access to memory banks is still too expensive for general consumers. However, digital cameras, mobile phones, ~MP3/~MP4 players, GPS devices, etc. are ~System-on-Chips (SOC): they are increasingly demanding parallel access to memory/buffer for real-time processing.
!Other Uses of Interleaving
* ''Load Balancing'' -- interleave the use of resources to several components to avoid single-component overload. This is used in technologies like multi-threading, dual-cores, disk-arrays, ~P2P download via torrents, etc. Modern applications, even operating system, are object-based: objects are created to perform tasks. Web applications run on servers, and it is the job of servers to keep objects in a pool so that identical tasks (e.g. transactions) can be shared among identical objects -- how good the server can achieve this load balancing is an important performance indicator of the Web server. Try Google &quot;load balancing interleave&quot; for more information.&lt;html&gt;&lt;p&gt;&lt;/html&gt;
* ''Error Correction'' -- interleave input signals among several error-decoders to avoid bursts of error.  This is used in telecommunication signal transmissions (TV signals, Internet, ~WiFi, etc.) since all channels have unavoidable noise. This is also used in CD players and iPods -- reading a hard-disk is still mechanical, and this is error-prone when you're jogging. Standard CD uses [[Cross-interleaved Reed-Solomon coding (CIRC)|http://en.wikipedia.org/wiki/Cross-interleaved_Reed-Solomon_coding]] for error detection/correction. Try Google &quot;error-correction interleave&quot; for more information.
Few of these interleaving applications are based on primes. Most are based on power of 2: interleave into 2 parts, 4 parts, 8 parts, ... Yet note that 2 is a prime (the only even prime), and gcd(power of 2, odd) = 1.
!Simple Interleaving
Whenever you are doing two things at once, you are ''interleaving'': doing a bit of this, doing a bit of that. This is quite common: if there is a need to ''squeeze'' two (or more) things in one ''serial'' channel, some form of interleaving must be applied.

In optical fiber technology, interleaver and deinterleaver are used to squeeze/unsqueeze signals to increase the transmission capacity, see [[this|http://en.wikipedia.org/wiki/Optical_interleaver]].

Such simple interleaving is featured in this story: [[Memoirs of a Space Engineer - Leadpencils|http://www.abc.net.au/science/slab/memoirs/leadpencils.htm]]. Nothing to do with primes, but still worth reading.
</pre>
</div>
<div title="Java String HashCode" modifier="Joseph" modified="201003080422" created="201003060042" changecount="11">
<pre>The Java programming language supports ''hash'' data structures: Hashtable, ~HashMap, and ~HashSet. Since the data to be hashed can be any Object, all Java Objects have hashCode() method.
!String hashCode
''String'' is an Object in Java, and its hashCode() is [[documented|http://java.sun.com/javase/6/docs/api/java/lang/String.html#hashCode()]]:
&lt;html&gt;&lt;pre&gt;
public int &lt;b&gt;hashCode()&lt;/b&gt;
    Returns a hash code for this string. The hash code for a String object is computed as
         s[0]*31&lt;sup&gt;(n-1)&lt;/sup&gt; + s[1]*31&lt;sup&gt;(n-2)&lt;/sup&gt; + ... + s[n-1]
    using int arithmetic, where s[i] is the ith character of the string, n is the length of the string.
&lt;/pre&gt;&lt;/html&gt;
This complicated-looking hash function is in fact a simple loop:
&lt;html&gt;&lt;pre&gt;
public int &lt;b&gt;hashCode()&lt;/b&gt; {
    int h = 0;
    int len = this.length();
    for (int i = 0; i &lt; len; i++) {
        h = 31 * h + this.charAt(i);
    }
    return h;
}
&lt;/pre&gt;&lt;/html&gt;
The string is the key, hash value is a Java int, 32-bits: from ''Integer.~MIN_VALUE''=-2^^31^^=-2147483648 to ''Integer.~MAX_VALUE'' = 2^^31^^-1=2147483647.
!Computing String hashCode
In your browser, to find the hashCode of a Java string &quot;Joe Miller&quot;, try typing this in the address:
 {{{javascript:new java.lang.String(&quot;Joe Miller&quot;).hashCode()}}} 

This works for ~FireFox browsers, but may not work for Internet Explorer (which says, &quot;java undefined&quot;). 

[[Try Your Own Hashing]] simulates this ''String hashCode'' computation in Javascript.</pre>
</div>
<div title="JavaScript" modifier="Joseph" modified="201001180440" created="201001180344" changecount="25">
<pre>&lt;html&gt;
&lt;textarea id=&quot;here&quot; cols=&quot;100%&quot; rows=&quot;25&quot;&gt;&lt;/textarea&gt;
&lt;br /&gt;
&lt;input type=&quot;button&quot; value=&quot;OK 1&quot; height=&quot;50&quot;  onClick=&quot;alert('Hello, TiddlyWiki!')&quot;&gt;
&lt;input type=&quot;button&quot; value=&quot;OK 2&quot; height=&quot;50&quot;  onClick=&quot;alert(document.getElementById('here'))&quot;&gt;
&lt;input type=&quot;button&quot; value=&quot;OK 3&quot; height=&quot;50&quot;  onClick=&quot;alert(parseInt)&quot;&gt;
&lt;input type=&quot;button&quot; value=&quot;OK 4&quot; height=&quot;50&quot;  onClick=&quot;alert(Logger)&quot;&gt;
&lt;input type=&quot;button&quot; value=&quot;Hello&quot; height=&quot;50&quot;  onClick=&quot;Logger.set('here');Logger.log('Hello, TiddlyWiki!')&quot;&gt;
&lt;/html&gt;</pre>
</div>
<div title="Key pairs for RSA" modifier="Joseph" modified="201001251204" created="201001231341" changecount="30">
<pre>The ''RSA'' method is a modification of Cyclic Exponentiation Encryption and Decryption. However, the modulus is not a prime p. Instead, the modulus ''n = pq'', a product of two large primes.

We have seen that, to find key pairs for Cyclic Exponentiation is to look at the equation: ''x = x#e#d''  with operation ''#'' replaced by exponentiation modulo ''n'': ''^'' under ''mod n''. That is:

''x = x ^ e ^ d  (mod n)''  or ''x = (x^^e^^)^^d^^ (mod n)'' or ''x = x^^(e*d)^^ (mod n)''

Given a modulus ''n=pq'', where ''p'', ''q'' are ''primes'', can we find a pair of public key ''e'' and private key ''d'' to satisfy this equation?

This is no special name for a product of two primes -- I just call them ''bi-primes''.

!Exponent Inverses for Modulo Bi-prime
Since the modulus ''n'' is not a prime, ''(Z/n,+,*)'' is just a [[Ring|Group, Ring and Field]]: multiplication can be bad. However, we do have ''Euler's Theorem'' for any modulus ''n'':

For any modulus ''n'', ''a^^&amp;phi;(n)^^=1 (mod n)'' for remainder ''a'' relatively prime to ''n''.

In a ring, multiplication is still closed, so we can first raise both sides to the same power k:

For any modulus ''n'', ''(a^^&amp;phi;(n)^^)^^k^^=a^^k*&amp;phi;(n)^^=1^^k^^=1 (mod n)'' for remainder ''a relatively prime to n'' .

And multiply both sides by ''a'':

For any modulus ''n'', ''a^^(k*&amp;phi;(n)+1)^^=a (mod n)'' for remainder ''a'' relatively prime to ''n''.

For bi-prime ''n=pq'', it can be shown that this is valid even if ''a'' is not relatively prime to ''pq''. Hence:

For any bi-prime modulus ''n=pq'', ''a^^(k*&amp;phi;(n)+1)^^=a (mod n)'' for any remainder ''a''.

Comparing with our equation, it means: ''e*d = k*&amp;phi;(n)+1'', or ''e*d=1 (mod &amp;phi;(n))''. 

For the bi-prime ''n=pq'', only 1, p, 2p, ..., (q-1)p, q, 2q, ..., (p-1)q are relatively prime to pq, so:

&amp;phi;(n)=&amp;phi;(pq)=(pq-1)- (q-1)-(p-1) = pq-q-p+1=(p-1)(q-1).

Thus the key pair ''e'' and ''d'' are multiplicative inverses in mod &amp;phi;(n) = mod (p-1)(q-1).

Therefore, given a bi-prime modulus ''n=pq'', any ''e'' relatively prime to ''&amp;phi;(n)=(p-1)(q-1)'' will do, and ''d=e^^-1^^ (mod (p-1)(q-1))'', the multiplicative inverse of ''e'' in ''mod (p-1)(q-1)''.

Using ''Euler's Theorem'' again for the explicit formula of multiplicative inverse, ''d=e^^&amp;phi;((p-1)(q-1))-1^^ mod (p-1)(q-1)''.

For example, taking two prime ''p=5'' and ''q=11''. The bi-prime modulus ''n=5*11=55'', and &amp;phi;(n)=&amp;phi;(55)=(5-1)(11-1)=40. Pick ''e=3'' which relatively prime to 40, then ''d=27'' because 3*27=81=1 (mod 40). If you count the relatively prime remainders of 40, you'll find &amp;phi;(40)=&amp;phi;((p-1)(q-1))=12, from which you can compute ''d''=3^^(12-1)^^ (mod 40)=3^^11^^=(3*3*3)^^3^^*(3*3) =(27)^^3^^*(9)=27*27*27*9=(729)(243)=(9)(3)=''27'' (mod 40).

|!Possible data for modulus 55|!Encrypt by ^3 (mod 55)|!Decrypt by ^27 (mod 55)|
|2|2^^3^^=8|8^^27^^=(8*8)^^13^^*8=(64)^^13^^*8=(9)^^13^^*8=...= (14)*8=112=2 (mod 55)|
|3|3^^3^^=27|27^^27^^=(27*27)^^13^^*27=(14)^^13^^*27=...=49*27=1323=3 (mod 55)|
|14|14^^3^^=196*14=31*14=434=49|49^^27^^=(49*49)^^13^^*49=(36)^^13^^*49=...=(16)*49=784=14 (mod 55)|
|15|15^^3^^=225*15=5*15=75=20|20^^27^^=(20*20)^^13^^*20=(15)^^13^^*20=...=(20)*20=400=15 (mod 55)|
|''Encryption and Decryption in Cyclic Exponent modulo 55''|c

!Is This Secure?
Although ''Encrypt by ^e (mod n)'' is made public, the private key ''d=e^^&amp;phi;((p-1)(q-1))-1^^ mod (p-1)(q-1)'' can be computed only if the primes factors of ''n=pq'' are known. Note that the public is only given the product ''n'', which is known to be the product of two primes, but the two primes are kept secret. To crack this code you need to factorize the known product ''n''. This is the crux of the RSA scheme, making it secure enough for bank transactions.

!Factorization of Bi-prime
In the example above, the bi-prime is ''55''. You can factorize this bi-prime in your head: ''55=5*11''. You've crack this RSA code!

However, if the bi-prime is ''4294967297'', can you factorize it quickly? This happens to be ''2^^&lt;html&gt;2&lt;sup&gt;5&lt;/sup&gt;&lt;/html&gt;^^+1'', the fifth Fermat Number, or ''F~~5~~''. In 1640, Fermat thought this is a prime, but in 1732 Euler showed that: ''4294967297=641*6700417''.

Currently, there is better factorization methods than trial divisions, but there is no known fast methods to factorize a number, especially when the prime factors involved are large. Experts believe that no such fast methods exist, but there is no proof so far. 

To show that bi-prime factorization is hard, when RSA was introduced in 1977, they posed in a magazine an encrypted message with ''e''=9007, but the modulus ''n'' is a 129-digit number, called ''~RSA-129'':

''~RSA-129'' = 1143816257578888676692357799761466120102182 9672124236256256184293570693524573389783059 7123563958705058989075147599290026879543541

In April 1994, an international cooperative group of mathematicians and computer scientists solved this 17-year-old challenge problem by factorizing ~RSA-129:

''~RSA-129'' = 34905295108476509491478496199038 98133417764638493387843990820577 *
32769132993266709549961988190834 461413177642967992942539798288533. 

For the full story, read [[The Cracking of RSA-129|http://cauchy.math.okstate.edu/~wrightd/crypt/crypt-intro/]].

The RSA scheme recommends using primes of 100-digits. It is estimated that even if you have an ultra-fast super-computer, to factorize a 200-digit bi-prime will require a time longer than the age of universe.
</pre>
</div>
<div title="Linear Congruences" modifier="Joseph" modified="201001200559" created="201001171412" changecount="46">
<pre>One way of generating periodic sequences is by cyclic math, like the ''clock'': after 12, we cycle back to 1, 2, 3 ... In cyclic math, numbers are operated (add, subtract, multiply or divide) by  keeping only the remainder after division by some integer N, called the modulus.

Most computer systems (and computer languages) generate random numbers based on remainders of division by N (or mod N):

 X~~n+1~~ = A X~~n~~ + B (mod N)  with X~~0~~ = seed

Since mod N has only a finite number of remainders, the sequence X~~n~~ must repeat. The idea is this: with a given N, choose suitable values of A and B so that sequence X~~n~~ gives the maximum period. How to  choose suitable constants A, B to achieve the maximum period? This is a math problem (in group theory), but we can do experiments:

&lt;html&gt;
&lt;form&gt;
&lt;table width=&quot;80%&quot; border=&quot;3&quot; bgcolor=&quot;#C5CDFF&quot;&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
    &lt;b&gt;X&lt;sub&gt;n+1&lt;/sub&gt; = A X&lt;sub&gt;n&lt;/sub&gt; + B (mod N)&lt;/b&gt; with X&lt;sub&gt;0&lt;/sub&gt; = seed.&lt;br&gt;
       modulus N: &lt;INPUT name=&quot;N&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;11&quot;&gt;
    multiplier A: &lt;INPUT name=&quot;A&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;2&quot;&gt;
      constant B: &lt;INPUT name=&quot;B&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;0&quot;&gt;
        seed X&lt;sub&gt;0&lt;/sub&gt;: &lt;INPUT name=&quot;seed&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;2&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
            onClick=&quot;Logger.set('lcs.logger'); new LCS(parseInt(N.value), parseInt(A.value), parseInt(B.value), parseInt(seed.value)).run();&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot;&gt;&lt;textarea id=&quot;lcs.logger&quot; cols=&quot;100%&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/html&gt;

These computer computer experiments show that results are usually good when N is a prime.

!Mulitplicative congruence
This is a special case of (1), with B = 0, so only multiplications are performed.
X~~n+1~~ = A X~~n~~ (mod N) with X~~0~~ = seed

For a modulus N, since X~~n~~ must be nonzero, the possible remainders are 1 to N-1, hence the maximum period is (N-1).
|!N|!A|!Seed|!Sequence|!Period|!Max Period|!Comments|
|3|2|2|2,4=1,2 ... |2|2|prime 3 gives max period|
|4|2|2|2,4=0 ...    |dies|3||
|5|2|2|2,4,8=3,6=1,2 ... |4|4|prime 5 gives max period|
|6|2|2|2,4,8=2 ...  |2|5||
|7|2|2|2,4,8=1,2 ... |3|6|prime 7 gives short period|
|7|3|2|2,6,18=4,12=5,15=1,3,9=2 ... |6|6|prime 7 gives max period|

These examples illustrate that to get the maximum period, a prime modulus with a suitable multiplier is essential. Hence a knowledge of primes is important for random number generators based on multiplicative congruences.

For example, in a 32-bit machine, the max signed integer 2^^31^^ - 1 = 2147483647 happens to be a Mersenne prime. This prime has been used in a good random number generator: N = 2147483647, A = 7^^5^^ = 16807, B = 0  (Park and Miller).

!Additive Congruences
This is another special case of (1), with A = 1, so only additions are performed:
X~~n+1~~ = X~~n~~ + B (mod N) with X~~0~~ = seed

For a modulus N, X~~n~~ as remainder can be 0 to N-1, hence the maximum period is N.
|!N|!B|!Seed|!Sequence|!Period|!Max Period|!Comments|
|3|2|2|2,4=1,3=0,2 ... |3|3|gives max period when B=2|
|4|2|2|2,4=0,2 ...     |2|4||
|4|3|2|2,5=1,4=0,3,6=2 ...|4|4|gives max period when B=3|
|5|2|2|2,4,6=1,3,5=0,2 ...  |5|5|gives max period when B=2|
|6|2|2|2,4,6=0,2 ...    |3|6||
|6|5|2|2,7=1,6=0,5,10=4,9=3,8=2 ... |6|6|gives max period when B=5|
|7|2|2|2,4,6,8=1,3,5,7=0,2 ... |7|7|gives max period when B=2|

These examples illustrate that to get the maximum period, a modulus will need a suitable constant B, preferably prime. So a knowledge of primes is also important for random number generators based on additive congruences.

Random number generators in most programming languages are a combination of additive and multiplicative congruences, i.e. using linear congruences with suitable modulus N, multiplier A and constant B. For example,  the random number generator of Borland C/C++: N = 2^^32^^, A = 3x7^^2^^x61x2531 = 22695477, B=1.</pre>
</div>
<div title="MainMenu" modifier="Joseph" modified="201001170531" created="200706090859" changecount="18">
<pre>[[Prime Applications]]
&lt;&lt;newTiddler&gt;&gt;
&lt;&lt;saveChanges&gt;&gt;
&lt;&lt;doPublish&gt;&gt;
&lt;&lt;tiddler ToggleRightSidebar&gt;&gt;</pre>
</div>
<div title="Memory Bank Interleaving" modifier="Joseph" modified="201003081311" created="201003070459" changecount="50">
<pre>!Array in Memory
Most programming languages support a basic data structure: ''Array'', which is logicallly linear with elements a[j], with index j=1,2,3,...:
|!Array a[j]|!Element 1|!Element 2|!Element 3|!Element 4|!Element 5|....|
|!Logical Structure| a[1]| a[2]| a[3]| a[4]| a[5]|..|
|''Linear Array''|c
How this data structure is stored in memory has a direct impact on the speed of array computations.

Memory are organized into ''bytes''. An array element a[j] will take up some number of bytes -- exactly how many bytes depends on the type of the array element. Let's consider an example in which each array element a[j] takes 3 bytes.

PC has sequential memory, and this 3-bytes array is usually stored as:
|!Memory|!Content|!Comment|
|!Byte 1|@@a[1] byte 1@@|a[1] in contiguous cells|
|!Byte 2|a[1] byte 2|~|
|!Byte 3|a[1] byt3 3|~|
|!Byte 4|@@a[2] byte 1@@|a[2] in contiguous cells|
|!Byte 5|a[2] byte 2|~|
|!Byte 6|a[2] byt3 3|~|
|!Byte 7|@@a[3] byte 1@@|a[3] in contiguous cells|
|!Byte 8|a[3] byte 2|~|
|!Byte 9|a[3] byt3 3|~|
|''3-bytes Array in sequential memory''|c

Sequential memory access is fast for a single CPU. For super-computers and high-end servers, their CPU is often dual-core, or 4-core, even 8-core. The [[Connection Machine|http://en.wikipedia.org/wiki/Connection_Machine]] has up to 2^^16^^=64K ~CPUs connected together. For such CPU structures, sequential memory access is slow.
!Parallel Memory
With some ingenious microelectronics, memory can be organized into ''banks'': 
access within each bank is ''sequential'' (normal speed), but access across each bank is ''parallel'' (extremely fast).

Consider storing the 3-bytes array in a 2-bank memory:
|!Memory|!Bank 1|!Bank 2|!Comment|
|!Byte 1|@@a[1]  byte 1@@|a[1] byte 2|part of a[1] is across bank|
|!Byte 2|a[1]  byte 3|@@a[2] byte 1@@| |
|!Byte 3|a[2]  byte 2|a[2] byte 3|part of a[2] is across bank|
|!Byte 4|@@a[3]  byte 1@@|a[3] byte 2| |
|!Byte 5|a[3]  byte 3|@@a[4] byte 1@@|part of a[3] is across bank |
|''3-bytes Array in 2-bank memory''|c
Since memory access across bank is fast, this gives partial improvement in speeding up array access.

Consider storing the 3-bytes array in a 3-bank memory:
|!Memory|!Bank 1|!Bank 2|!Bank 3|!Comment|
|!Byte 1|@@a[1]  byte 1@@|a[1] byte 2|a[1] byte 3|a[1] is across bank|
|!Byte 2|@@a[2]  byte 1@@|a[2] byte 2|a[2] byte 3|a[2] is across bank|
|!Byte 3|@@a[3]  byte 1@@|a[3] byte 2|a[3] byte 3|a[3] is across bank|
|''3-bytes Array in 3-bank memory''|c
Now each array element (3 bytes) has fast access, but successive array elements a[1], a[2], a[3], ... are still accessed sequentially.

Consider storing the 3-bytes array in a 4-bank memory:
|!Memory|!Bank 1|!Bank 2|!Bank 3|!Bank 4|!Comment|
|!Byte 1|@@a[1]  byte 1@@|a[1] byte 2|a[1] byte 3|@@a[2] byte 1@@|a[1] is across bank|
|!Byte 1|a[2]  byte 2|a[2] byte 3|@@a[3] byte 1@@|a[3] byte 2|a[2] is across bank|
|!Byte 3|a[3]  byte 3|@@a[4] byte 1@@|a[4] byte 2|a[4] byte 3|a[3], a[4] are across bank|
Not only each array element has fast access, even array elements a[1], a[2], a[3], a[4],... are across bank, hence fast access.

The actual byte size of an array element is dependent on the programming language, especially its compiler, which is software. This is an unknown factor to the hardware manufacturer of Memory Banks, who is now presented with a problem:
//Is it possible to have memory banks that can accommodate array elements of any size? If yes, how many banks in memory is desirable?//
!How many Banks in Memory?
Using math from [[Infinite Interleaving]], the solution to the problem is:
//A ''prime'' number of banks in memory will (almost) fit array elements of any size across the banks, except elements with size a multiple of the prime.//

The exception can be taken care of by choosing an ''odd'' prime (any prime &gt; 2), and the language compiler keeps array elements size a ''power of 2'' (1-byte, 2-bytes, 4-bytes, 8-bytes, etc). For example, Java's Virtual Machine (VM) provides array access of byte (8-bits), char or short (16-bits), int or float (32-bits), long or double (64-bits) and object references (addresses) -- all can be fitted nicely in even number of bytes.

This scheme for parallel memory is called ''Prime Degree Interleaving''. Some supercomputers and high-end servers make use of parallel memory of 5 or 7 banks.  A small prime is chosen because it is still expensive to manufacture parallel memory -- hence this technology is not used for ~PCs.
!Address Decoding
For sequential memory, the address ''a'' requires no decoding:
|!Memory|!Address|!Comment|
|!Byte 1| 1|address is implicit|
|!Byte 2| 2|~|
|!Byte 3| 3|~|
|!Byte 4| 4|~|
|!Byte 5| 5|~|
|!Byte 6| 6|~|
|!Byte 7| 7|~|
|!...| ...|~|
|''Sequential Memory Addressing''|c

For paralllel memory with 3 banks, the address ''a'' is distributed as:
|!Memory|!Bank 1|!Bank 2|!Bank 3|!Comment|
|!Byte 1| 1| 2| 3|Can you see ''Z/3''?|
|!Byte 2| 4| 5| 6|~|
|!Byte 3| 7| 8| 9|~|
|!Byte 4| 10| 11| 12|~|
|!...| ...| ...| ...|~|
|''3-bank Paralllel Memory Addressing''|c

The logical linear address ''a'' requires some decoding to which Bank, which Byte:
|!Address|!Bank|!Byte|!Comment|
| 1|!Bank 1|!Byte 1|All Byte 1, only Bank varies|
| 2|!Bank 2|!Byte 1|~|
| 3|!Bank 3|!Byte 1|~|
| 4|!Bank 1|!Byte 2|All Byte 2, only Bank varies|
| 5|!Bank 2|!Byte 2|~|
| 6|!Bank 3|!Byte 2|~|
| 7|!Bank 1|!Byte 3|All Byte 3, only Bank varies|
| 8|!Bank 2|!Byte 3|~|
| 9|!Bank 3|!Byte 3|~|
| 10|!Bank 1|!Byte 4|All Byte 4, only Bank varies|
| 11|!Bank 2|!Byte 4|~|
| 12|!Bank 3|!Byte 4|~|
|''3-bank Paralllel Memory Address Decoding''|c

In general, for parallel memory with ''m'' banks, the address ''a'' is decoded as:
bank = ''a mod m'', the ''remainder'',  byte = ''a div m'', the ''quotient''.

Since this addressing decoding is to be performed for every memory fetch, it is better if ''m'' is a power of 2 -- rather than a prime ''m''. In binary system, quotient and remainder of power of 2 is simply ''masking'' -- just like in decimals, quotient and remainder of 1123581321 by 10^^5^^=100000 can be done by chopping. Quotient and remainder in modulo prime is much harder compared to this.

Due to this overhead of address decoding, parallel memory is usually implemented in 2-banks, 4-banks, or 8-banks. To accommodate array elements of any size, special compilers are introduced to keep array element size always odd, because gcd(power of 2, odd) = 1.
!For more Info
PC Guide: Memory Interleaving
http://www.pcguide.com/ref/ram/timingInterleaving-c.html
An Analysis of a new Memory System for ~Conflict-Free Access
http://www.scichina.com:8081/sciAe/fileup/PDF/83ya0205.pdf</pre>
</div>
<div title="Mersenne Numbers" modifier="Joseph" modified="201001281221" created="201001271150" changecount="41">
<pre>Based on this fact:

If the odd number ''2^^n^^-1'' is prime, then ''n'' must be prime. 

Marin Mersenne (1588 – 1648) studied the following question:

Given a prime ''p'', will the odd number ''M~~p~~ = 2^^p^^-1'' be prime?

!Mersenne Numbers
Mersenne probably started with the following compilation:

|!prime p|!2^^p^^|!M~~p~~=2^^p^^-1|!Factorization of M~~p~~|
| 2| 4| 3| prime M~~2~~|
| 3| 8| 7| prime M~~3~~|
| 5| 32| 31| prime M~~5~~|
| 7| 128| 127| prime M~~7~~|
| 11| 2048| 2047|23*89|
| 13| 8192| 8191| prime M~~13~~|
| 17| 131072| 131071| prime M~~17~~|
| 19| 524288| 524287| prime M~~19~~|
| 23| 8388608| 8388607|47*178481|
| 29| 536870912| 536870911|233*1103*2089|
| 31| 2147483648| 2147483647| prime M~~31~~|

So the answer to Mersenne's question is no: given prime ''p'', ''M~~p~~'' can be prime or composite. However, the story continued.

!Mersenne Primes
In the preface to his //Cogitata ~Physica-Mathematica// (1644), Marin Mersenne stated that:

The numbers 2^^p^^-1 were prime for p = 2, 3, 5, 7, 13, 17, 19, 31, 67, 127 and 257, and composite for all other p &lt; 257. 

The primes M~~p~~ for p = 2, 3, 5, 7, 13, 17, 19 were well known at that time, but Mersenne was announcing 4 more. It was obvious to Mersenne's peers that he could not have tested all of these numbers (in fact he admitted as such), and they could not test them either. It took three centuries and several mathematical discoveries (such as the Lucas Lehmer test), before the exponents in Mersenne's conjecture had been completely checked. It was determined that he had made five errors (three primes omitted, two composites listed) and the correct list is:

    p = 2, 3, 5, 7, 13, 17, 19, 31, 61, 89, 107 and 127 

|!#|!prime p|!M~~p~~|!Number of digits in M~~p~~|!When|!Who|
|1| 2| 3| 1|500 BC|Greek mathematicians|
|2| 3| 7| 1|500 BC|Greek mathematicians|
|3| 5| 31| 2|300 BC|Greek mathematicians|
|4| 7| 127| 3|300 BC|Greek mathematicians|
|5| 13| 8191| 4|1456|anonymous|
|6| 17| 131071| 6|1588|Cataldi|
|7| 19| 524287| 6|1588|Cataldi|
|8| 31| 2147483647| 10|1772|Euler|
|9| 61| 2305843009213693951| 19|1883|Pervushin|
|10| 89| 618970019642690137449562111| 27|1911|Powers|
|11| 107| 162259276829213363391578010288127| 33|1914|Powers|
|12| 127| 170141183460469231731687303715884105727| 39|1876|Lucas|
|''Corrected list of Mersenne Primes with p &lt; 257''|c

!Use of Mersenne Primes
Euclid (300 BC) was interested in numbers of the form 2^^p^^-1 due to the perfect numbers -- a number N whose sum of factors (excluding N) equals to N. Such numbers are not too hard to find, the following are know from antiquity:

|!Perfect Number N|!Sum of its factors|!Factorization of N|
|6|1+2+3=6|6=2*3|
|28|1+2+4+7+14=28|28=4*7|

Those familiar with the powers of 2 (2, 4, 8, 16, ...) will immediately spot a formula: ''2^^(p-1)^^(2^^p^^-1)''. Indeed, put in p = 5, you'll get another perfect number: 16*31 = 496. There are several equivalent ways to write this formula:

''2^^(p-1)^^(2^^p^^-1)'' = ''(2^^p^^/2)(2^^p^^-1)'' = ''(M~~p~~+1)M~~p~~/2''.

Indeed, Euclid provided a proof of this formula, which amounts to an application of Mersenne primes:

For a prime ''p'', if ''2^^p^^-1'' is prime, then ''2^^(p-1)^^(2^^p^^-1)'' is a perfect number.

Why? It is simple to observe that, a pure even N=2^^n^^ is almost perfect -- its factors are 1, 2, 4=2^^2^^, ..., 2^^(n-1)^^, so by the geometric series (sum of terms of same ratio) we have:

factor-sum of N = 1 + 2 + 2^^2^^ + ... + 2^^(n-1)^^ = 2^^n^^ - 1 = N - 1

How about a pure even with an odd prime ''q'', say N=2^^n^^q ? The additional factors are: 2^^n^^, q, 2q, 4q, ...., 2^^(n-1)^^q, so:

factor-sum of N = (1+2+...+2^^n-1^^)+(q+2q+...+2^^n-1^^q) + 2^^n^^ = (1+2+...+2^^n-1^^)(1+q) + 2^^n^^= (2^^n^^-1)(1+q) + 2^^n^^

For perfect number N:  (2^^n^^-1)(1+q) + 2^^n^^ = N = 2^^n^^q

Solving for q gives: q = 2^^n^^-1+2^^n^^=2^^(n+1)^^-1. This gives the formula after some symbolic substitutions.

In 1732, Euler proved the converse:

All even perfect numbers are of the form ''2^^(p-1)^^(2^^p^^-1)'', for each Mersenne prime ''2^^p^^-1''.

Therefore each ''Mersenne prime M~~p~~'' corresponds to an ''even Perfect Number'':

|!#|!prime p|!Mersenne prime M~~p~~|!2^^(p-1)^^(2^^p^^-1)|!Perfect Number|
|1| 2| 3| 2*3| 6|
|2| 3| 7| 4*7| 28|
|3| 5| 31| 16*31| 496|
|4| 7| 127| 2^^6^^*127| 8128|
|5| 13| 8191| 2^^12^^(2^^13^^-1)| 33550336|
|6| 17| 131071| 2^^16^^(2^^17^^-1)| 8589869056|
|7| 19| 524287| 2^^18^^(2^^19^^-1)| 34359672832|
|8| 31| 2147483647| 2^^30^^(2^^31^^-1)| 2305843008139952128|
|9| 61| 2305843009213693951| 2^^60^^(2^^61^^-1)| 2658455991569831744654692615953842176|
|10| 89| 618970019642690137449562111|  2^^88^^(2^^89^^-1)| 191561942608236107294793378084303638130997321548169216|
|''Mersenne Primes and Perfect Numbers''|c

It is not know if any odd perfect number exists.

Mersenne's list initiated the study of primality testing of M~~p~~. This is an active area of research even today. The record for the largest Mersenne prime keeps breaking, see [[ GIMPS|www.mersenne.org/]], the ''Great Internet Mersenne Prime Search''.
</pre>
</div>
<div title="PageFormats" modifier="Joseph" modified="201001180343" created="200706081027" changecount="37">
<pre>This is //really// ''funny''
Other special --sorry-- __effects__.

Can we bold like this?  &lt;html&gt;&lt;b&gt;Hello&lt;/b&gt;&lt;/html&gt; Yes! Just put any valid HTML between {{{&lt;html&gt;}}} and {{{&lt;/html&gt;}}}.

This is TiddlyWikiSyntax.

This is [[TiddlyWikiSyntax 2]].

This is ''bold'' (two single quotes), this is //italics// (two slashes).
This is __underline__, this is --strike through--.

This is {{{Monospace}}}.
This is @@Highlighed Text@@.
This is @@color(red):Red colored text@@.

For superscript:  e^^ix^^.
For subscript: a~~n~~.
For underscore: a + b__i__ + c__j__ + d__k__.

Below is a horizontal ruler (4 hyphens):
----

For images, the ways are:
{{{
      [img[filename]]
      [img[filename][link]]         link = jump if image is clicked, optional.
      [img[title|filename]]
      [img[title|filename][link]]   title = tool-tip, optional.
}}}</pre>
</div>
<div title="PageTemplate" modifier="Joseph" modified="200706091241" created="200706091239" changecount="2">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;!-- horizontal MainMenu --&gt;
&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;!--original MainMenu menu--&gt;
&lt;!-- div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div --&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="PeriodicTable" modifier="Joseph" modified="200706101242" created="200612061823" tags="chemistry" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200612061823" changecount="2">
<pre>|Standard Periodic Table (ref. Wikipedia)|c
|!Period\Group| !1 | !2 |!| !3 | !4 | !5 | !6 | !7 | !8 | !9 | !10 | !11 | !12 | !13 | !14 | !15 | !16 | !17 | !18 |
|!1|bgcolor(#a0ffa0): @@color(red):H@@ |&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;||bgcolor(#c0ffff): @@color(red):He@@ |
|!2|bgcolor(#ff6666): Li |bgcolor(#ffdead): Be |&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;||bgcolor(#cccc99): B |bgcolor(#a0ffa0): C |bgcolor(#a0ffa0): @@color(red):N@@ |bgcolor(#a0ffa0): @@color(red):O@@ |bgcolor(#ffff99): @@color(red):F@@ |bgcolor(#c0ffff): @@color(red):Ne@@ |
|!3|bgcolor(#ff6666): Na |bgcolor(#ffdead): Mg |&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;|&gt;||bgcolor(#cccccc): Al |bgcolor(#cccc99): Si |bgcolor(#a0ffa0): P |bgcolor(#a0ffa0): S |bgcolor(#ffff99): @@color(red):Cl@@ |bgcolor(#c0ffff): @@color(red):Ar@@ |
|!4|bgcolor(#ff6666): K |bgcolor(#ffdead): Ca ||bgcolor(#ffc0c0): Sc |bgcolor(#ffc0c0): Ti |bgcolor(#ffc0c0): V |bgcolor(#ffc0c0): Cr |bgcolor(#ffc0c0): Mn |bgcolor(#ffc0c0): Fe |bgcolor(#ffc0c0): Co |bgcolor(#ffc0c0): Ni |bgcolor(#ffc0c0): Cu |bgcolor(#ffc0c0): Zn |bgcolor(#cccccc): Ga |bgcolor(#cccc99): Ge |bgcolor(#cccc99): As |bgcolor(#a0ffa0): Se |bgcolor(#ffff99): @@color(green):Br@@ |bgcolor(#c0ffff): @@color(red):Kr@@ |
|!5|bgcolor(#ff6666): Rb |bgcolor(#ffdead): Sr ||bgcolor(#ffc0c0): Y |bgcolor(#ffc0c0): Zr |bgcolor(#ffc0c0): Nb |bgcolor(#ffc0c0): Mo |bgcolor(#ffc0c0): Tc |bgcolor(#ffc0c0): Ru |bgcolor(#ffc0c0): Rh |bgcolor(#ffc0c0): Pd |bgcolor(#ffc0c0): Ag |bgcolor(#ffc0c0): Cd |bgcolor(#cccccc): In |bgcolor(#cccccc): Sn |bgcolor(#cccc99): Sb |bgcolor(#cccc99): Te |bgcolor(#ffff99): I |bgcolor(#c0ffff): @@color(red):Xe@@ |
|!6|bgcolor(#ff6666): Cs |bgcolor(#ffdead): Ba |bgcolor(#ffbfff):^^*1^^|bgcolor(#ffc0c0): Lu |bgcolor(#ffc0c0): Hf |bgcolor(#ffc0c0): Ta |bgcolor(#ffc0c0): W |bgcolor(#ffc0c0): Re |bgcolor(#ffc0c0): Os |bgcolor(#ffc0c0): Ir |bgcolor(#ffc0c0): Pt |bgcolor(#ffc0c0): Au |bgcolor(#ffc0c0): @@color(green):Hg@@ |bgcolor(#cccccc): Tl |bgcolor(#cccccc): Pb |bgcolor(#cccccc): Bi |bgcolor(#cccc99): Po |bgcolor(#ffff99): At |bgcolor(#c0ffff): @@color(red):Rn@@ |
|!7|bgcolor(#ff6666): Fr |bgcolor(#ffdead): Ra |bgcolor(#ff99cc):^^*2^^|bgcolor(#ffc0c0): Lr |bgcolor(#ffc0c0): Rf |bgcolor(#ffc0c0): Db |bgcolor(#ffc0c0): Sq |bgcolor(#ffc0c0): Bh |bgcolor(#ffc0c0): Hs |bgcolor(#ffc0c0): Mt |bgcolor(#ffc0c0): Ds |bgcolor(#ffc0c0): Rg |bgcolor(#ffc0c0): @@color(green):Uub@@ |bgcolor(#cccccc): Uut |bgcolor(#cccccc): Uuq |bgcolor(#cccccc): Uup |bgcolor(#cccccc): Uuh |bgcolor(#fcfecc): @@color(#cccccc):Uus@@ |bgcolor(#ecfefc): @@color(#cccccc):Uuo@@ |

| !Lanthanides^^*1^^|bgcolor(#ffbfff): La |bgcolor(#ffbfff): Ce |bgcolor(#ffbfff): Pr |bgcolor(#ffbfff): Nd |bgcolor(#ffbfff): Pm |bgcolor(#ffbfff): Sm |bgcolor(#ffbfff): Eu |bgcolor(#ffbfff): Gd |bgcolor(#ffbfff): Tb |bgcolor(#ffbfff): Dy |bgcolor(#ffbfff): Ho |bgcolor(#ffbfff): Er |bgcolor(#ffbfff): Tm |bgcolor(#ffbfff): Yb |
| !Actinides^^*2^^|bgcolor(#ff99cc): Ac |bgcolor(#ff99cc): Th |bgcolor(#ff99cc): Pa |bgcolor(#ff99cc): U |bgcolor(#ff99cc): Np |bgcolor(#ff99cc): Pu |bgcolor(#ff99cc): Am |bgcolor(#ff99cc): Cm |bgcolor(#ff99cc): Bk |bgcolor(#ff99cc): Cf |bgcolor(#ff99cc): Es |bgcolor(#ff99cc): Fm |bgcolor(#ff99cc): Md |bgcolor(#ff99cc): No |

*Chemical Series of the Periodic Table
**@@bgcolor(#ff6666): Alkali metals@@
**@@bgcolor(#ffdead): Alkaline earth metals@@
**@@bgcolor(#ffbfff): Lanthanides@@
**@@bgcolor(#ff99cc): Actinides@@
**@@bgcolor(#ffc0c0): Transition metals@@
**@@bgcolor(#cccccc): Poor metals@@
**@@bgcolor(#cccc99): Metalloids@@
**@@bgcolor(#a0ffa0): Nonmetals@@
**@@bgcolor(#ffff99): Halogens@@
**@@bgcolor(#c0ffff): Noble gases@@

*State at standard temperature and pressure
**those in @@color(red):red@@ are gases
**those in @@color(green):green@@ are liquids
**those in black are solids</pre>
</div>
<div title="Portable Libraries" modifier="Joseph" modified="201001221259" created="201001181305" changecount="22">
<pre>On the software side, the common [[linear congruence random generators|Linear Congruences]] have been extensively analyzed statistically, and some defects are exposed. It is deemed that they are adequate for ordinary use, but will not be good for serious computer simulations -- for example: climate, XBox computer games, etc.). 

!Mersenne Twister
In 1997, two Japanese mathematicians ''Makoto Matsumoto'' and ''Takuji Nishimura'' developed a new type of random number generator based on:
* matrix linear recurrence over the finite field [[GF(2)|Group, Ring and Field]], and
* twisted feedback shift register, a generalization of [[LFSR|Simple Machines]].

This involves the use of Mersenne primes, and they name their new algorithm ''Mersenne Twister'', so that their initials (MT) are hidden in the name. The source code is freely available, hence MT is open-sourced. The authors also make the code platform independent, which means the code is portable to various software or hardware.

MT has been extensively tested in theory and in practice. Its performance is fast with good statistical characteristics. It quickly becomes the (pseudo) random number generator of choice in various software libraries. It is currently used in Ruby, Python, Maple, MATLAB, R (a statistical programming language) and even ~XBox.

This is an application of Mersenne primes in random number generation. The authors (MT) have since improved the code in January 2002.

!Further Information
See http://en.wikipedia.org/wiki/Mersenne_Twister

</pre>
</div>
<div title="Prime Applications" modifier="Joseph" modified="201003041317" created="200706090854" changecount="32">
<pre>!Topics
# [[Primes for Random]]
# [[Primes for Secrets]]
# [[Primes for Checks]]
# [[Primes for Speed]]
# [[Primes for Math]]
# [[Primes for Tricks]]
# [[Primes for Nature]]
# [[Primes for Art]]

!About this page
This page is based on [[TiddlyWiki|http://www.tiddlywiki.com/]]: a reusable non-linear personal web notebook.

A ~TiddlyWiki is a blog in a single webpage: if the cursor over bold word shows a link, clicking will expand the word to the heading of a blog, with details. The details may show other links, clicking will expand to more blogs. The upper right corner of a blog has "close", which closes the blog.

!Note
Years ago in ~TiddlyWiki you can "edit" a blog in a browser, and save the changes. Also, you can run Java applet in a browser. Modern browsers have disabled such features due to security concerns. If you find some contents are not working, don't be disapponted.

</pre>
</div>
<div title="Prime Generating Polynomials" modifier="Joseph" created="201001311309" changecount="1">
<pre>!Pattern from Polynomials
You may be surprised that primes aligning like beads along diagonals of the spiral: some bead pearls are long, some are short.

If you start the spiral with 41, you'll get:

[img[PrimeSpiral41.gif]]

That long string of circled primes on the diagonal, in sequence, is 41, 43, 47, 53, ..., 1523, 1601. They can be produced by
* either the polynomial: ''x^^2^^ + x + 41'' for ''0&amp;le;n&amp;le;39'' due to Euler (1772) ,
* or the polynomial ''x^^2^^ - x + 41'' for ''1&amp;le;n&amp;le;40'' due to Legendre (1798) .

|!x|!x^^2^^ + x + 41|!x^^2^^ - x + 41|
| 0| 0+0+41=41||
| 1| 1+1+41=43| 1-1+41=41|
| 2| 4+2+41=47| 4-2+41=43|
| 3| 9+3+41=53| 9-3+41=47|
| 4| 16+4+41=61| 16-4+41=53|
| 5| 25+5+41=71| 25-5+41=61|
| 6| 36+6+41=83| 36-6+41=71|
|...| ...| ...|
|36| 1296+36+41=1373| 1296-36+41=1301|
|37| 1369+37+41=1447| 1369-37+41=1373|
|38| 1444+38+41=1523| 1444-38+41=1447|
|39| 1521+39+41=1601| 1521-39+41=1523|
|40| | 1600-40+41=1601|
|''Polynomial giving primes''|c

Polynomials like this, which generate long strings of primes, are called ''prime generating polynomials''.

!More information
Wolfram ~MathWorld: ~Prime-Generating Polynomial
http://mathworld.wolfram.com/Prime-GeneratingPolynomial.html

Math Games: Prime Generating Polynomials
http://www.maa.org/editorial/mathgames/mathgames_07_17_06.html</pre>
</div>
<div title="Prime Spectrum" modifier="Joseph" modified="201001311305" created="201001311302" changecount="4">
<pre>!~One-Dimensional Pattern
On the number line, you can mark off the prime numbers, like this:
{{{
1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
   |  |     |     |           |     |           |     |           |                 |   
}}}

Each vertical line indicates the presence of a prime at that number position. Together, they form a ''spectrum'' for the primes.

!Pattern in Spectrum
There are 78 primes &amp;le; 400:

2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 53 59 61 67 71 73 79 83 89 97 101 103 107 109 113 127 131 137 139 149 151 157 163 167 173 179 181 191 193 197 199 211 223 227 229 233 239 241 251 257 263 269 271 277 281 283 293 307 311 313 317 331 337 347 349 353 359 367 373 379 383 389 397

This gives the first of the following ''prime spectrum'':

| 1-400|&lt;&lt;sparkline 0 1 1 0 1 0 1 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0&gt;&gt;|
| 401-800|&lt;&lt;sparkline 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0&gt;&gt;|
| 801-1200|&lt;&lt;sparkline 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0&gt;&gt;|
|1201-1600|&lt;&lt;sparkline 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0&gt;&gt;|
|1601-2000|&lt;&lt;sparkline 1 0 0 0 0 0 1 0 1 0 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 1 0 1 0&gt;&gt;|

At the start, the primes are dense, but there are fewer primes the further away from start. Still, you can find primes nearby: ''p'' and ''p+2'' are primes -- these are called ''Twin Primes''.

Since a line cannot be extended for too long before running out of space (or paper), it is hard to detect any pattern in 1D distribution of primes, if any.
</pre>
</div>
<div title="Primes for Art" modifier="Joseph" modified="201003051358" created="201001170551" changecount="119">
<pre>!Primes and Patterns
Are there patterns in the distribution of primes? To see if there are any, you need to display the primes -- how?
* [[Prime Spectrum]] - a 1D picture of primes.
* [[Ulam Spiral]] - a 2D picture of primes.
* [[Prime Generating Polynomials]] - pattern and polynomials.
!More Patterns
Gruenberger’s prime path
http://bit-player.org/2010/gruenbergers-prime-path</pre>
</div>
<div title="Primes for Checks" modifier="Joseph" modified="201001260615" created="201001170555" changecount="8">
<pre>Thanks to &amp;Eacute;variste Galois, the teenage math wizard during the French Revolutions, we have the following result:

A finite system within which add, subtract, multiply and division can be consistently done (called a [[Finite Field|Group, Ring and Field]]) must have ''p^^n^^'' elements, where ''p'' is a prime and ''n'' a nonzero whole number.

Such finite fields, or ''Galois Fields'' have extensive applications, ranging from error-detection to error-correction, use of extremely weak signals in communication, and the design of invisible surfaces. Here we take a look at a simple application of Galois Fields: in error-detection.

!Error-detection Schemes
* [[ISBN check digit]]</pre>
</div>
<div title="Primes for Math" modifier="Joseph" modified="201001272352" created="201001170540" changecount="49">
<pre>Prime numbers are the building blocks of numbers for multiplication -- the &quot;atomic&quot; factors: a prime has no non-trivial factors. This property of primes is quite useful in mathematics itself, particularly in the study of numbers.

!The Powers of 2
''2'' is the (only) even prime. The powers of 2 (or ''towers of 2''): 2, 2^^2^^=4, 2^^3^^=8, 2^^4^^=16, 2^^5^^=32, ..., are pure even numbers -- they do not have any odd factors. As a result, 2^^n^^&amp;plusmn;1 are odd numbers -- how often will they be (odd) primes?

|!n|!2^^n^^|!2^^n^^-1|!2^^n^^+1|!2^^n^^ in binary|!2^^n^^-1 in binary|!2^^n^^+1 in binary|
|1| 2| 1| @@3@@| 10| 1| 11|
|2| 4| @@3@@| @@5@@| 100| 11| 101|
|3| 8| @@7@@| 9| 1000| 111| 1001|
|4| 16| 15| @@17@@| 10000| 1111| 10001|
|5| 32| @@31@@| 33| 100000| 11111| 100001|
|6| 64| 63| 65| 1000000| 111111| 1000001|
|7| 128| @@127@@| 129| 10000000| 1111111| 10000001|
|8| 256| 255| @@257@@| 100000000| 11111111| 100000001|
|9| 512| 511| 513| 1000000000| 111111111| 1000000001|
|10| 1024| 1023| 1025| 10000000000| 1111111111| 10000000001|
|''Primes of 2^^n^^&amp;plusmn;1 are highlighted''|c

In binary, the ''pure even'' ''2^^n^^'' is just 1 followed by n zeros, and ''2^^n^^-1'' is just n ones.
!One less than Pure Even
Consider odd numbers of the form 2^^n^^-1. Based on the well-known factorization identities:

x^^2^^ - 1 = (x - 1)(x + 1)
x^^3^^ - 1 = (x - 1)(x^^2^^ + x + 1)
x^^5^^ - 1 = (x - 1)(x^^4^^ + x^^3^^ + x^^2^^ + x + 1)

If exponent n has non-trivial factors: ''n=pq'' with p&gt;1 and q&gt;1, then we can apply one of these identities to factorize 2^^n^^-1 = 2^^(pq)^^-1 = (2^^p^^)^^q^^-1:

|!n=pq|!2^^n^^-1|!Factorization of 2^^n^^-1|
| 4=2*2| 15|15=2^^4^^-1=4^^2^^-1=(4-1)(4+1)=3*5|
| 6=2*3| 63|63=2^^6^^-1=8^^2^^-1=(8-1)(8+1)=7*9=3*3*7|
| 8=2*4| 255|255=2^^8^^-1=16^^2^^-1=(16-1)(16+1)=15*17=3*5*17|
| 9=3*3| 511|511=2^^9^^-1=8^^3^^-1=(8-1)(8*8+8+1)=7*73|
| 10=2*5| 1023|1023=2^^10^^-1=32^^2^^-1=(32-1)(32+1)=31*33=3*11*31|
|''Factorization of 2^^n^^-1 when n is composite''|c

Hence we have the this result: If ''n'' is not prime, then the odd number ''2^^n^^-1'' is not prime.

Logically, this is equivalent to: If the odd number ''2^^n^^-1'' is prime, then ''n'' must be prime.

The 17th-century French scholar ''Marin Mersenne'' studied the following question:
Given a prime ''p'', will the odd number ''2^^p^^-1'' be prime?

Nowadays, these odd numbers ''M~~p~~ = 2^^p^^-1'' for prime ''p'' are called [[Mersenne Numbers]] &lt;-- click to find out more.
!One more than Pure Even
Consider odd numbers of the form 2^^n^^+1. If n is composite and has an odd factor, say ''n=pq'' with q ''odd'', then since +1=-(-1)^^q^^ for odd q:

2^^n^^+1 = 2^^pq^^-(-1) = (2^^p^^)^^q^^ - (-1)^^q^^ = (2^^p^^+1)(2^^q^^-2^^q-1^^+....+1)

|!n=pq with q odd|!2^^n^^+1|!Factorization of 2^^n^^+1|
| 3=1*3| 9|9=2^^3^^+1=2^^3^^-(-1)^^3^^=(2+1)(4-2+1)=3*3|
| 5=1*5| 33|33=2^^5^^+1=2^^5^^-(-1)^^5^^=(2+1)(16-8+4-2+1)=3*11|
| 6=2*3| 65|65=2^^6^^+1=4^^3^^-(-1)^^3^^=(4+1)(16-4+1)=5*13|
| 7=1*7| 129|129=2^^7^^+1=2^^7^^-(-1)^^7^^=(2+1)(64-32+16-8+4-2+1)=3*43|
| 9=3*3| 513|513=2^^9^^+1=8^^3^^-(-1)^^3^^=(8+1)(64-8+1)=9*57=3*3*3*19|
| 10=2*5| 1025|1025=2^^10^^+1=4^^5^^-(-1)^^5^^=(4+1)(4^^4^^-4^^3^^+4^^2^^-4+1)=5*205=5*5*41|
|''Factorization of 2^^n^^+1 when n has odd factor''|c

Hence we have the this result: If ''n'' has an odd factor, then the odd number ''2^^n^^+1'' is not prime.

Logically, this is equivalent to: If the odd number ''2^^n^^+1'' is prime, then ''n'' has no odd factors.

This can be re-written as: If the odd number ''2^^n^^+1'' is prime, then ''n=2^^k^^'', a pure even.

The 17th-century French lawyer ''Pierre de Fermat'' studied the following question:
Given a pure even ''2^^n^^'', will the odd number ''2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1'' be prime?

Nowadays, these odd numbers ''F~~n~~ = 2^^&lt;html&gt;2&lt;sup&gt;n&lt;/sup&gt;&lt;/html&gt;^^+1'' are called [[Fermat Numbers]] &lt;-- click to find out more.
</pre>
</div>
<div title="Primes for Nature" modifier="Joseph" modified="201003051200" created="201001170550" changecount="38">
<pre>One way to generate primes is known from antiquity: the [[Sieve of Eratosthenes|sieve.html]]. This is a process of elimination. Evolution also involves elimination, in the famous Darwinian principle of ''Survival of fittest''. Can nature produce primes, too?

!Life Cycle of Cicadas (蟬)
There are three distinct stages in the life cycle of a cicada - egg, nymph and adult.

!!!Egg stage
After mating, the female will lay several hundred eggs. She makes a little slit in the bark of the branch as she walks along and pushes the eggs down through her long tail. She deposits 12 or so into each slit and then moves on a few millimeters to make another slit for more eggs, and so on, until all the eggs have been laid.
!!!Nymph stage
The eggs stay in the slits in the bark for many weeks and then hatch into a miniature cicada called a nymph. Because they are so small they can fall down to the ground without injuring themselves and seek shelter underneath the leaf litter. These cicada nypmhs attached themselves to tree roots at depth of 12&quot; -18&quot; in the ground. It's here, underground, that cicadas spend most of their life. The cicada nymph feeds by piercing small tree roots with its needle-like rostrum and sucking up sap.
!!!Adult stage
When the nymphs finally reach full size they dig their way to the surface. They begin a vertical climb - trees, poles, tall grass - where they anchor themselves and begin popping out of their shells. The life of the adult, in contrast to that of the nymph, is very short.

[img[cicada1.jpg]] [img[cicada2.jpg]] [img[cicada3.jpg]]

When the cicadas emerge from their shells, they are pale and soft, and their wings are folded and compressed. As they are exposed to air, their wings unfold, and their bodies darken and harden. At this mature stage, they begin their nearly incessant singing in search for a mate. They have one purpose at this stage, and it ain't eating!

[img[cicada-life-cycle.jpg]]

After the male empties his sperm capacity, he keels over and dies. The female injects her 400-600 eggs into the thin end of a branch and keels over and dies. The eggs hatch in 6 - 8 weeks, when they fall to the ground, and begin grubbing on grass roots. They begin their downward descent, attach to a tree root for another long time. Repeat. Amazing! 

!Period of Cicadas Life Cycle
Depending on the species, when cicadas emerge from the ground they live from a few days to a couple of months, the majority live for around two to four weeks. However, their underground live as a nymph can take anything from nine months to 13 or 17 years depending on the species. Most species take around 7 years to re-emerge.

Note that the numbers 7, 13, 17 are primes.

Why these primes for the period of life-cycle for cicadas?

Scientists believe there is a predator that likes to prey on the adult and also emerges periodically after a certain number of years. In biological systems, the coexistence of predator and prey often like to [[Predator-Prey-Cycles|http://en.wikipedia.org/wiki/Lotka%E2%80%93Volterra_equation]]. Perhaps the cicadas find that, by choosing a prime-number cycle, they can keep out of step of the predator more often than otherwise. Evolution might have helped the cicadas to find these primes through elimination of multiples, like the [[Sieve of Eratosthenes|sieve.html]] &lt;-- click to have a play.

For the cicadas, the primes are the secret to their survival.

!More Information
Beckham in his prime number
http://plus.maths.org/issue26/features/sautoy/

Return of the 17 Year Cicadas
http://www.youtube.com/watch?v=RYLxxALTfAQ

Brian Hayes: Bugs That Count
http://www.americanscientist.org/issues/pub/bugs-that-count
</pre>
</div>
<div title="Primes for Random" modifier="Joseph" modified="201001190351" created="201001170526" changecount="18">
<pre>!Random Numbers
Nowadays computer games are fast and exciting, but probably you can still find and play the Solitaire Card Game on your PC.  The game starts with 52 cards in random order, face down. How does a computer, at the heart a machine that always give the same output with the same input, produce something random?

The surprising fact is: yes, there is no mechanical way to generate truly random numbers.  

However, there are methods to generate a list of numbers that looks random -- the list is long and there is no obvious patterns; but if you wait long enough you'll find that the numbers eventually repeat. The length of the non-repeating pattern is called the period. There are computer algorithms that generate periodic number sequences, and prime numbers are involved for very long periods.

Some computer theorists would say these should be called pseudo-random numbers (which are periodic), to distinguish them from truly random numbers (which are non-periodic).  We won't be that careful -- we just understand that our generated random numbers are good enough to shuffle the cards in Solitaire.

Having a long period for a number sequence is just one of the many requirements of a random number sequence: patterns of the sequence must pass some statistical tests to ensure how random-like the sequence is. We are not going into the full theory of random number generators -- we just take a look at how primes enter into this process of random number generation.

!How to generate Random Numbers
These are some common methods for random number generation using computer:
* [[Linear Congruences]]
* [[Simple Machines]]
* [[Portable Libraries]]</pre>
</div>
<div title="Primes for Secrets" modifier="Joseph" modified="201002231136" created="201001170537" changecount="69">
<pre>How to send digital information securely over the Internet? This is the number-one topic in Internet security. This is also is the application of modern cryptography, using prime numbers.

!Cryptography
[[Cryptography]] is all about encryption (scramble plain information to secret) and decryption (unscramble secret to plain information). 

For example, during logon to check your email, how to send your password without exposing it to others on the Net? If you are using a web-based email service, you'll notice that the email server changes the protocol from ''http:'' to ''https:'' -- this is secure HTTP protocol, which tells the browser how to encrypt your password. The encrypted password is sent over the Net to the email server. The server then decrypts to recover the password, validates it, and tells the browser if the email logon is successful.

All spies use cryptography for communication. They learn the tricks of encryption and decryption to pass on secrets. Military use cryptography extensively to code and decode their messages, and intelligence must understand cryptography to 'crack the codes'. To make the codes hard to crack, encryption and decryption methods get more and more sophisticated -- meaning more and more tedious for human. Eventually, by World War II, mechanical devices are invented to assist in the encryption and decryption. Later, electronic machines are designed to assist in cracking the code. These electronic machines are the grand-daddy of modern computers.

Therefore, cryptography has been used throughout history. Although math is used in encryption and decryption, the methods are not related to prime numbers. However, none of these spies, military or intelligence before face the same problem of modern-day email server: how to fast encrypt and decrypt thousands of passwords per second, every second?

The answer is really a surprise: use a single, simple method (so it is fast) both to encrypt and decrypt, even the cracking is theoretically simple -- the catch is: cracking is practically impossible. As you'll see, this is where prime numbers come in.

The experts are so confident about the catch that the single, simple method is make known to all -- the method itself is no secret. Upon changing to HTTPS, the browser applies the method with a ''public key'' from the server to encrypt the password. The server applies the same method with a ''private key'' to recover the password. The ''key pair'' (both the public and private keys) is generated by the server. The public key is made public, and the private key is kept private (of course). While it is easy to generate the key pair, it is practically impossible to deduce the private key from a knowledge of the public key and the simple method. This is how your passwords, credit-card details, banking transactions, etc. are protected when you use the Internet.

Refer to [[Public Key Encryption|pkey.html]] for an in-depth discussion. Below is a brief highlight of the main results.

!Key-pair Encryption and Decryption
Nowadays all information is digital -- that is, all data are internally represented by numbers. To encrypt data is to apply a method to the numbers, using a ''public key'' ''e'' (for encrypt). To decrypt is to apply the same method to the encrypted numbers, using a ''private key'' ''d'' (for decrypt). How to generate such pairs of keys ''d'' and ''e''?

The generation of key pairs depends on the method, use both for encryption and decryption. Let the operation of the method be denoted by ''#''. If ''x'' is the original data, ''y'' is the scrambled data, we have: ''y'' = ''x#e'' and ''x'' = ''y#d''. Or, equivalently,

''x'' = ''x#e#d''.

This almost indicates that the operation ''#'' must involve some sort of cyclic math -- you keep changing the data by the ''same'' operation, and arrive back at the original! 

Let's consider 3 possible operations in cyclic math of ''modulus n'', i.e. arithmetic of the remainders after integer division by ''n''.
* Key pairs for [[Cyclic Addition]]
* Key pairs for [[Cyclic Multiplication]]
* Key pairs for [[Cyclic Exponentiation]]

None of these provide a secure method of Public Key Encryption, although the third method raises some hopes.

!RSA Scheme
It took 3 brains from MIT (Ron Rivest, Adi Shamir, and Leonard Adleman) to come with a practical method for Public Key Encryption. They named the method by their initials: ''RSA''.
* [[Key pairs for RSA]]
* [[View the RSA public key|SSL Certificate]]
* [[History of RSA]]</pre>
</div>
<div title="Primes for Speed" modifier="Joseph" modified="201003080803" created="201002281346" changecount="10">
<pre>Prime numbers can be useful in designs for efficiency. Here are two examples:
#[[Hashing]] - How apparent messiness can be effective for searching.
#[[Interleaving]] - How to break up a regular sequence to avoid delay.
Click and see how primes can help in these areas.

Due to practical issues during implementation, in real life not all ''Hashing'' and ''Interleaving'' schemes are based on primes.
However, it is still interesting to know that primes can be useful for better designs, at least in theory.</pre>
</div>
<div title="Primes for Tricks" modifier="Joseph" modified="201001290955" created="201001170545" changecount="28">
<pre>A whole number greater than 1 is either a prime or not a prime. This elementary property can be used effectively in magic tricks.

Here, we shall study a card trick call ''Exchange of Packs'', in 3 versions:
* The 1st description involves no primes, and the trick is so simple that even little kids will not be surprised.
* The 2nd description is the same trick, but slightly modified so that little kids may be surprised.
* The 3rd description is the same trick, but so subtly modified that you can fool a few audiences.
All versions involve a magician (you) and two audiences X, Y (simply pick them from the audiences).

!Exchange of Packs - No-trick version
* Beforehand, prepare the 52 cards in two piles: ''reds'' in pile A, ''blacks'' in pile B.
* Give pile A to audience X, pile B to audience Y.
* Ask each to shuffle his/her pile, randomly select a card, look and show only to audiences, then place the card face-down on the other pile (i.e. X's chosen card on pile B, Y's chosen card on pile A).
* Each shuffle his/her pile again.
* Magician collects piles A and B, one on top of the other (no shuffling).
* Then he flips the cards and scan.
** In the black cards there'll be a red card = X's chosen card.
** In the red cards there'll be a black card = Y's chosen card.
Even kids can figure this out. However, this description shows the principle of the trick -- just two ''types'' of cards. There are many variations on how to define the two ''types''. 
!Exchange of Packs - Tricker version
* Beforehand, prepare the 52 cards in two piles: ''odds'' in pile A, ''evens'' in pile B.
* //rest the same//
!Exchange of Packs - Magic version
* Beforehand, prepare the 52 cards in two piles: ''primes'' in pile A, ''non-primes'' in pile B.
* //rest the same//
Whether a card is prime depends on its value:

|!Card|!Value|!Prime?|
|Ace|1|??|
|2|2|yes|
|3|3|yes|
|4|4| no|
|5|5|yes|
|6|6| no|
|7|7|yes|
|8|8| no|
|9|9| no|
|10|10| no|
|Jack|11|yes|
|Queen|12| no|
|King|13|yes|
|''Cards and Values''|c

How to treat the Ace cards? There are several options:
# You can take Ace=1 as prime, slightly bending the math definition. This makes pile A a bit bigger than pile B.
# You can take Ace=1 as not a prime, true to the math definition. This makes pile A a bit smaller than pile B.
# You can take red Ace as prime, black Ace as non-prime -- or vice versa, as long as you stick to your own definition. Same size for piles A, B.
# You can take out the 4 Ace cards beforehand -- this also makes the two piles A, B the same size.

For more information on adding extras to make this magic trick perfect, see [[Magic Trick: Prime Pairs|http://www.mrmagician.co.uk/prime-pairs.html]].

You can invent your own variation of this trick. As stated in the no-trick version, this only depends on dividing the cards into two ''types''. For example:
** ''type A'': red primes and black non-primes,
** ''type B'': black primes and red non-primes.
</pre>
</div>
<div title="Primitive Polynomials" modifier="Joseph" modified="201001221233" created="201001210147" changecount="84">
<pre>Here is a review of [[Group, Ring and Field]].

!Ring from Ring
It was the investigation of polynomial roots that gets Galois into the study of group, ring and field. We learn about add, subtract, multiply and division of polynomials in our school days. Let's see what's so interesting about polynomials.

A polynomial in x is a symbolic expression for the form: a~~0~~ + a~~1~~x + a~~2~~x^^2^^ + .... + a~~n~~x^^n^^

Here x is just a symbol - we are not going to put any numeric value to x, at least for our simple study of polynomials. The a~~j~~ are coefficients of the corresponding x^^j^^ term. These coefficients a~~j~~ are usually integers, but ''Z(+,*)'' is a ring, and any ring will do. All the polynomials constructed with coefficients from a ''Ring R'' is denoted by ''R[x]''.

We can add, subtract, multiply one polynomial by another. There is also the long division of polynomials, giving a quotient and a remainder. So polynomials behave very much like integers. Indeed, it can be shown that ''R[x]'' is itself a ring -- so this is ring from ring.

A field is just a ring with nice multiplication, so the coefficients can also come from a field. All the polynomials constructed with coefficients from a ''Field F'' is denoted by ''F[x]''.

Note that ''F[x]'' is still a ring, although the nice features of the field ''F'' do give some special properties for this ring.

Without getting into the theory of polynomial rings, let us look at the simplest of such polynomials, built from coefficient of the finite field ''GF(2)'', or ''binary field''.

!Polynomials of GF(2)
A polynomial of GF(2) has coefficients 0 or 1: a~~0~~ + a~~1~~x + a~~2~~x^^2^^ + .... + a~~n~~x^^n^^,  with a~~j~~=0 or 1.

They form the ring ''GF(2)[x]''. Up to the 4th coefficient, the polynomials of ''GF(2)[x]'' are:

|!a~~0~~|!a~~1~~|!a~~2~~|!a~~3~~|!p(x)=a~~0~~+a~~1~~x+a~~2~~x^^2^^+a~~3~~x^^3^^|
|0|0|0|0|0|
|1|0|0|0|1|
|0|1|0|0|x|
|1|1|0|0|1+x|
|0|0|1|0|x^^2^^|
|1|0|1|0|1+x^^2^^|
|0|1|1|0|x+x^^2^^|
|1|1|1|0|1+x+x^^2^^|
|0|0|0|1|x^^3^^|
|1|0|0|1|1+x^^3^^|
|0|1|0|1|x+x^^3^^|
|1|1|0|1|1+x+x^^3^^|
|0|0|1|1|x^^2^^+x^^3^^|
|1|0|1|1|1+x^^2^^+x^^3^^|
|0|1|1|1|x+x^^2^^+x^^3^^|
|1|1|1|1|1+x+x^^2^^+x^^3^^|
|''16 polynomials of GF(2)[x] with 4 coefficients''|c

All the polynomials in ''GF(2)[x]'' form a ring. But can these 16 polynomials themselves form a (sub)-ring? Let's see:
* Addition seems no problem: (x)+(1+x) = 1+2x = 1, since 2=0 in GF(2). In fact, each polynomial is its own additive inverse: p(x)+p(x) = 2p(x) = 0.* Multiplication gives some problem: (x)(x^^3^^) = x^^4^^, which is not one of the 16 polynomials.

It turns out that, if the 15 nonzero polynomials are taken as possible remainders of division by 1+x^^3^^+x^^4^^, then multiplication works fine:
(x)(x^^3^^) = x^^4^^ = (1)(1+x^^3^^+x^^4^^)-(1+x^^3^^), remainder -1-x^^3^^=1+x^^3^^ since -1=1 in GF(2).
(1+x^^2^^)(1+x^^3^^) = 1+x^^2^^+x^^3^^+x^^5^^ = (1+x)(1+x^^3^^+x^^4^^) - (x-x^^2^^+2x^^4^^), remainder x+x^^2^^+2x^^4^^=x+x^^2^^.

Further calculations reveal that the remainder multiplication works very nice:
(x)(x^^2^^+x^^3^^) = x^^3^^+x^^4^^ = (1)(1+x^^3^^+x^^4^^)-(1), remainder -1=1. Hence x and x^^2^^+x^^3^^ are inverses.
(1+x)(x^^3^^) = x^^3^^+x^^4^^ = (1)(1+x^^3^^+x^^4^^)-(1), remainder -1=1. Hence 1+x and x^^3^^ are inverses.
(1+x+x^^2^^)(x+x^^2^^+x^^3^^) = x+2x^^2^^+3x^^3^^+2x^^4^^+x^^5^^ = x + x^^3^^ + x^^5^^ = (1+x)(1+x^^3^^+x^^4^^)-(2x^^4^^+1), remainder -1=1. Hence 1+x+x^^2^^ and x+x^^2^^+x^^3^^ are inverses.

It can be shown that all nonzero elements has multiplicative inverses in this ring ''GF(2)[x]'' modulo ''(1+x^^3^^+x^^4^^)'', or ''GF(2)[x]/(1+x^^3^^+x^^4^^)''. Such polynomials whose nonzero remainders have multiplicative inverses are called ''primitive polynomials''.

A ring with nice multiplication is a field. Hence ''GF(2)[x]/(1+x^^3^^+x^^4^^)'' is a field with 2^^4^^=16 elements (15 nonzero), denoted by ''GF(2^^4^^)''.

This is the next discovery of Galois, with two related results:
# For any prime ''p'', the ring ''GF(p)[x]/poly(x)'' is a field with ''p^^n^^'' elements whenever ''poly(x)'' is a primitive polynomial in ''GF(p)[x]'' with degree ''n''. ''GF(p)[x]/poly(x)'' is structurally the same as ''GF(p^^n^^)''.
# For any prime ''p'', there is a field ''GF(p^^n^^)'' whose multiplicative group has ''p^^n^^-1'' nonzero elements. The multiplication is polynomial multiplication in ''GF(p)[x]'' with modular division by a primitive polynomial ''poly(x)'' of degree ''n''.

!n-bit LFSR and GF(2^^n^^)
For p=2, the only even prime, the field ''GF(2^^4^^)'' can be constructed from ''GF(2)[x]/(1+x^^3^^+x^^4^^)''. This is applied to the ''4-bit LFSR'' in the following way:
* Each nonzero element of ''GF(2^^4^^)'' corresponds to a state of ''4-bit LFSR''.
* The primitive polynomial 1+x^^3^^+x^^4^^ implies the 1-based taps are at 3,4.

In general, the ''n-bit LFSR'' is related to the finite field ''GF(2^^n^^)'':
* Each nonzero element of ''GF(2^^n^^)'' corresponds to a state of ''n-bit LFSR''.
* A primitive polynomial of degree n gives the 1-based tap positions, via the term-indexes of coefficient 1.
</pre>
</div>
<div title="Publish Macro" modifier="Joseph" modified="200711211149" created="200711211129" tags="Plugin systemConfig" changecount="8">
<pre>/***
|''Name:''|Publish Macro|
|''Version:''|0.4 (25 May 2007)|
|''Source''|http://jackparke.googlepages.com/jtw.html#PublishMacro ([[del.icio.us|http://del.icio.us/post?url=http://jackparke.googlepages.com/jtw.html%23PublishMacro]])|
|''Author:''|[[Jack]]|
|''Type:''|Macro|
!Description
Publish tiddlers tagged with these tags &lt;&lt;option txtPublishTags&gt;&gt; (comma seperated) as HTML pages to the subfolder 'publish' (you must create this). Use the [[PublishTemplateHead]] and [[PublishTemplateBody]] templates to style your pages and the [[PublishIndexTemplate]] to define an index page.
!Usage
{{{&lt;&lt;doPublish&gt;&gt;}}} &lt;&lt;doPublish&gt;&gt;
!Revision History
* Original by [[Jack]] 24 May 2006
* Updated 2 Jan 2007
* Refactored 4 Jan 2007
* Small improvements

!Code
***/
//{{{
version.extensions.doPublish = {major: 0, minor: 3,
revision: 0, date: new Date(&quot;Jan4, 2007&quot;)};
config.macros.doPublish = {label: &quot;publish&quot;, prompt: &quot;Publish Tiddlers as HTML files&quot;};
if (config.options.txtPublishTags==undefined) config.options.txtPublishTags=&quot;Publish&quot;;
config.shadowTiddlers.PublishTemplateHead = '&lt;title&gt;%0 - %1&lt;/title&gt;\n&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;style.css&quot;/&gt;\n&lt;meta name=&quot;keywords&quot; content=&quot;%3&quot;/&gt;'
config.shadowTiddlers.PublishTemplateBody = '&lt;div class=\'viewer\' id=\'contentWrapper\'&gt;&lt;small&gt;&lt;a href=\&quot;./publish/index.html\&quot;&gt;Home&lt;/a&gt; &gt; %1&lt;/small&gt;&lt;h1&gt;%0&lt;/h1&gt;\n&lt;h2&gt;%1&lt;/h2&gt;\n%2\n&lt;hr&gt;Tags: %3\n&lt;hr&gt;%4, %5&amp;nbsp;(created %6)\n&lt;/div&gt;\n'
config.shadowTiddlers.PublishIndexTemplate = '&lt;div class=\'viewer\' id=\'contentWrapper\'&gt;&lt;small&gt;&lt;a href=&quot;./publish/index.html&quot;&gt;Home&lt;/a&gt; &gt; %1&lt;/small&gt;&lt;h1&gt;%0&lt;/h1&gt;&lt;h2&gt;%1&lt;/h2&gt;\n&lt;ul&gt;%2\n&lt;/ul&gt;\n&lt;small&gt;Published: %6&lt;/small&gt;\n&lt;/div&gt;\n';
config.macros.doPublish.handler = function(place)
{
 if(!readOnly)
 createTiddlyButton(place,this.label,this.prompt,function () {doPublish(); return false;},null,null,this.accessKey);
}
function doPublish() {
 var savedTiddlers = [];
 var tiddlers = store.getTiddlers(&quot;title&quot;);
 var place = document.getElementById(story.container)
 var HTMLTemplateHead = store.getTiddlerText(&quot;PublishTemplateHead&quot;);
 // We cannot render this template because &lt;title&gt; and other tags fail

 var HTMLTemplateBody = store.getTiddlerText(&quot;PublishTemplateBody&quot;);
 HTMLTemplateBody = renderTemplate(HTMLTemplateBody)

 HTMLTemplateBody = wiki2Web(HTMLTemplateBody);

 var PublishTags = config.options.txtPublishTags || &quot;publish&quot;; PublishTags = PublishTags.split(&quot;,&quot;)
 var PublishFolder = getWikiPath('publish'); if (!PublishFolder) return;
 var indexFile = &quot;&quot;;
 
 var indexFileTemplate = store.getTiddlerText(&quot;PublishIndexTemplate&quot;);
 // This does not allow &lt;&lt;myMacro&gt;&gt; but wants &lt;div macro=&quot;myMacro&quot;&gt;
 indexFileTemplate = renderTemplate(indexFileTemplate)
 // This option allows WIKI-syntax but is limited in it's HTML capabilities
 //indexFileTemplate = wikifyStatic(indexFileTemplate)

 for (var t = 0; t &lt; tiddlers.length; t++) {
 var tiddler = tiddlers[t];
 if (tiddler.tags.containsAny(PublishTags)) {
 var tiddlerHTML = wikifyStatic(store.getValue(tiddler, 'text'));
 var HTML = '&lt;html&gt;\n\&lt;head&gt;\n' + HTMLTemplateHead + '\n&lt;/head&gt;\n&lt;body&gt;\n' + HTMLTemplateBody + '\n&lt;/body&gt;\n&lt;/html&gt;';
 HTML = HTML.format([
 wikifyPlain(&quot;SiteTitle&quot;).htmlEncode(),
 tiddler.title.htmlEncode(),
 wiki2Web(tiddlerHTML),
 tiddler.tags.join(&quot;, &quot;),
 tiddler.modifier,
 tiddler.modified.toLocaleString(),
 tiddler.created.toLocaleString()
 ]);
 //saveFile(PublishFolder + tiddler.created.formatString(&quot;YYYY0MM0DD&quot;) + &quot;.html&quot;, HTML);
 saveFile(PublishFolder + tiddler.title.filenameEncode() + &quot;.html&quot;, HTML);
 indexFile += &quot;&lt;li&gt;&lt;a href=\&quot;&quot; + tiddler.title.filenameEncode() + &quot;.html&quot; + &quot;\&quot; class=\&quot;tiddlyLink tiddlyLinkExisting\&quot;&gt;&quot; + tiddler.title + &quot;&lt;/a&gt;&lt;/li&gt;\n&quot;;
 story.closeTiddler(tiddler.title);
 }
 }
 indexFileTemplate = '&lt;html&gt;\n\&lt;head&gt;\n' + HTMLTemplateHead + '\n&lt;/head&gt;\n&lt;body&gt;\n' + indexFileTemplate + '\n&lt;/body&gt;\n&lt;/html&gt;';
 indexFileTemplate = indexFileTemplate.format([wikifyPlain(&quot;SiteTitle&quot;).htmlEncode(), wikifyPlain(&quot;SiteSubtitle&quot;).htmlEncode(), &quot;%2&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, (new Date()).toLocaleString()])

 indexFile = indexFileTemplate.replace(&quot;%2&quot;, indexFile)
 indexFile = wiki2Web(indexFile);
 saveFile(PublishFolder + &quot;index.html&quot;, indexFile)
 saveFile(PublishFolder + &quot;style.css&quot;, store.getTiddlerText(&quot;StyleSheet&quot;) + store.getTiddlerText(&quot;StyleSheetLayout&quot;) + store.getTiddlerText(&quot;StyleSheetColors&quot;))
 var indexWin = window.open(&quot;file://&quot; + PublishFolder.replace(/\\/g, &quot;/&quot;) + &quot;index.html&quot;, null); indexWin.focus();
}

function renderTemplate(html) {
 var result = document.createElement(&quot;div&quot;);
 result.innerHTML = html;
 applyHtmlMacros(result,null);
 var temp = result.innerHTML;
 //result.parentNode.removeChild(result);
 return temp;
}

// Convert wikified text to html
function wiki2Web(wikiHTML) {
 var regexpLinks = new RegExp(&quot;&lt;a .*?tiddlylink=.*?&lt;/a&gt;&quot;,&quot;img&quot;);
 var result = wikiHTML.match(regexpLinks);
 if (result) {
 for(i = 0; i &lt; result.length; i++) {
 var className = result[i].match(/ class=&quot;(.*?)&quot;/i)?result[i].match(/ class=&quot;(.*?)&quot;/i)[1]:&quot;&quot;;
 var tiddlerName = result[i].match(/ tiddlylink=&quot;(.*?)&quot;/i)[1];
 var url = tiddlerName.htmlDecode().filenameEncode() + &quot;.html&quot;;
 //var url = tiddler.created.formatString(&quot;YYYY0MM0DD&quot;) + &quot;.html&quot;;
 if (!className.match(/tiddlyLinkNonExisting/i))
 wikiHTML = wikiHTML.myReplace(result[i], &quot;&lt;a class=\&quot;&quot; + className + &quot;\&quot; href=\&quot;&quot; + url + &quot;\&quot;&gt;&quot; + tiddlerName + &quot;&lt;/a&gt;&quot;);
 else
 wikiHTML = wikiHTML.myReplace(result[i], &quot;&lt;a class=\&quot;&quot; + className + &quot;\&quot; title=\&quot;Page does not exist\&quot; href=\&quot;#\&quot;&gt;&quot; + tiddlerName + &quot;&lt;/a&gt;&quot;);
 }
 wikiHTML = wikiHTML.replace(/ href=&quot;http:\/\//gi, &quot; target=\&quot;_blank\&quot; href=\&quot;http://&quot;);
 }
 return wikiHTML
}
function getWikiPath(folderName) {
 var originalPath = document.location.toString();
 if(originalPath.substr(0,5) != 'file:') {
 alert(config.messages.notFileUrlError);
 if(store.tiddlerExists(config.messages.saveInstructions))
 story.displayTiddler(null,config.messages.saveInstructions);
 return;
 }
 var localPath = getLocalPath(originalPath);
 var backSlash = localPath.lastIndexOf('\\') == -1 ? '/' : '\\';
 var dirPathPos = localPath.lastIndexOf('\\')!=-1?localPath.lastIndexOf('\\'):localPath.lastIndexOf('/');
 var subPath = localPath.substr(0,dirPathPos) + backSlash + (folderName ? folderName + backSlash : '');
 return subPath;
}

// Replace without regex
String.prototype.myReplace = function(sea, rep) {
 var t1 = this.indexOf(sea);
 var t2 = parseInt(this.indexOf(sea)) + parseInt(sea.length);
 var t3 = this.length;
 return this.substring(0, t1) + rep + this.substring(t2, t3)
}
// Convert illegal characters to underscores
String.prototype.filenameEncode = function()
{
 return(this.toLowerCase().replace(/[^a-z0-9_-]/g ,&quot;_&quot;));
}
//}}}</pre>
</div>
<div title="Purple and gold color scheme" modifier="GiffMex" created="200612100532" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200612100532">
<pre>Background: #FFcc00
Foreground: #000
PrimaryPale: #FF8C69
PrimaryLight: #cc66ff
PrimaryMid: #440044
PrimaryDark: #410
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #440044
TertiaryPale: #ffff99
TertiaryLight: #EEC591
TertiaryMid: #440044
TertiaryDark: #8B7355</pre>
</div>
<div title="SSL Certificate" modifier="Joseph" modified="201001251309" created="201001181308" changecount="21">
<pre>When the browser changes to secure mode (using HTTPS), data send from your browser to the server will be encrypted by Public Key Encryption. The method of encryption is specified in a ''SSL Certificate'', which contains the public key. Most SSL Certificates nowadays use the RSA scheme.

Your browser either obtain these SSL Certificates on-the-fly, or cache them to save downloading them every time. Most browsers allow you to view these SSL Certificates. ''Warning'' - Don't click the wrong button! Always click &quot;Cancel&quot; or &quot;Close&quot; just to read, no modify or delete or clear!

!How to view Public Keys in SSL Certificate in Microsoft IE
Tools &gt; Internet Options, click &quot;Contents&quot; tab.
In Certificates click &quot;Certificates&quot;
click through the tabs, should find some.
click on a row (it becomes highlighted), then click &quot;view&quot;.
go to the &quot;Details&quot; tab, scroll and find the Public Key.

!How to view Public Keys in SSL Certificate in Mozilla ~FireFox
Tools &gt; Options &gt; Advanced, click &quot;Encryptions&quot; tab.
In Certificates click &quot;View List&quot;, select one, click &quot;View&quot;, examine &quot;Details&quot; tab to find the Public Key.

!An Example of RSA Public Key
The RSA Public Key includes both the modulus and exponent (clear in ~FireFox, not-so-clear in IE).

|!RSA Public Key in IE|!RSA Public Key in ~FireFox|
|30 81 89 02 81 81 00|Modulus (1024 bits):|
|e5 19 bf 6d a3 56 61 2d 99 48 71 f6 67 de b9 8d|e5 19 bf 6d a3 56 61 2d 99 48 71 f6 67 de b9 8d|
|eb b7 9e 86 80 0a 91 0e fa 38 25 af 46 88 82 e5|eb b7 9e 86 80 0a 91 0e fa 38 25 af 46 88 82 e5|
|73 a8 a0 9b 24 5d 0d 1f cc 65 6e 0c b0 d0 56 84|73 a8 a0 9b 24 5d 0d 1f cc 65 6e 0c b0 d0 56 84|
|18 87 9a 06 9b 10 a1 73 df b4 58 39 6b 6e c1 f6|18 87 9a 06 9b 10 a1 73 df b4 58 39 6b 6e c1 f6|
|15 d5 a8 a8 3f aa 12 06 8d 31 ac 7f b0 34 d7 8f|15 d5 a8 a8 3f aa 12 06 8d 31 ac 7f b0 34 d7 8f|
|34 67 88 09 cd 14 11 e2 4e 45 56 69 1f 78 02 80|34 67 88 09 cd 14 11 e2 4e 45 56 69 1f 78 02 80|
|da dc 47 91 29 bb 36 c9 63 5c c5 e0 d7 2d 87 7b|da dc 47 91 29 bb 36 c9 63 5c c5 e0 d7 2d 87 7b|
|a1 b7 32 b0 7b 30 ba 2a 2f 31 aa ee a3 67 da db|a1 b7 32 b0 7b 30 ba 2a 2f 31 aa ee a3 67 da db|
|02 03|Exponent (24 bits):|
|01 00 01|01 00 01|
|''Verisign Class 1 Public Primary Certification Authority''|c

In this example, the exponent: ''e'' = 10001 binary = 16^^4^^+1=2^^&lt;html&gt;2&lt;sup&gt;4&lt;/sup&gt;&lt;/html&gt;^^+1=65537=''F~~4~~'', the largest known Fermat prime. 

Most SSL Certificates choose a Fermat prime for the exponent ''e''. This is because a (small) prime ''e'' will be relatively prime to the bi-prime modulus ''n'', and the structure of Fermat prime allows efficient use of ''repeating squaring'' for exponentiation. In this example of ''e'' = F~~4~~, repeating squaring 16 times will raise data x to an exponent 2^^16^^=65536 already.</pre>
</div>
<div title="Simple Machines" modifier="Joseph" modified="201001230337" created="201001180948" changecount="65">
<pre>!Machine and States
Another way to produce periodic sequences is to use a cyclic machine: different states of the machine can be mapped to different numbers, and if the machine goes through all its states in a cycle, the numbers will be periodic.

In computer science, a ''machine'' can be very simple: all the light-switches in your home is a simple ''switching-machine''. If the total number of light switches is n, this machine has 2^^n^^ states: depending on whether a light is switched on (1) or off (0). For example, if there are 5 switches in total, a ''state'' can be denoted by 00101, a binary number corresponding to decimal 5. When you go to the kitchen the state will change to 00111, which is decimal 7.  This 5-switch machine has 2^^5^^ = 32 states. This light-switch machine is manual: you need to flip the switches to change its state. However, in a similar fashion, the twinkling-lights decorating the Christmas tree is an n-bit machine, and it cycles through its 2^^n^^ states automatically.

Note that the idea of ''binary bits'' and total count of states (''2^^n^^'') arise from the (only) even prime number: ''2''. Nowadays all digital information is based on binary bits -- this can be regarded as an application of the special prime number ''2''.

!Linear Feedback Shift Register (LFSR)
In daily life, if we want to make a choice (e.g. who play first), we flip a coin. Can we flip a digital coin? It turns out that the answer is &quot;yes&quot;, using a simple machine called a Linear Feedback Shift Register (LFSR).

An LFSR consists of n-bits, with an initial state being nonzero (not all bits 0), and a clock that ticks. A 4-bit LFSR looks like this (counting bits as b1, b2, b3, b4; b1 = lowest, b4=highest):

|!4-bit LFSR|!b1|!b2|!b3|!b4|!Comment|
||1|1|0|0||

This 4-bit LFSR has initial state b1=1, b2=1, b3=0, b4=0, which can be taken as (b4,b3,b2,b1) 0011 in binary = 3 in decimal.

As the clock ticks, the bits of the state shifts from low to high:

|!4-bit LFSR|!b1|!b2|!b3|!b4|!Comment|
||1|1|0|0||
|shift| |\|\|\|\|
||?|1|1|0|carry = 0|

b4 becomes the carry (the flip bit, 0 or 1), b3 goes to b4, b2 goes to b3, b1 goes to b2. So what is the lowest bit b1 now?

|!4-bit LFSR|!b1|!b2|!b3|!b4|!Comment|
||1|1|0|0||
||^| |\|/|taps: 3,4|
|feedback|&gt;|0 &lt;-|&gt;|xor||

This is where the taps come in. For this 4-bit LFSR, the taps are at bit-3 and bit-4, denoted as taps 3,4. Before the clock ticks, the tap bits (can be more than 2) are combined by the logical operator XOR (exclusive or), to produce the lowest bit b1 after the tick:

|!4-bit LFSR|!b1|!b2|!b3|!b4|!Comment|
||1|1|0|0||
||||\|/|taps: 3,4|
|feedback|&gt;|0 &lt;-|&gt;|xor||
|shift|v|\|\|\|\|
||0|1|1|0|carry = 0|

The states of this 4-bit LFSR change as the clock keeps on ticking:

[img[4-bit LFSR|LFSR-F4.gif][http://en.wikipedia.org/wiki/Linear_feedback_shift_register]]

Note that an LFSR will die if it reaches a state with all bits zero. Therefore ''n-bit LFSR'' only has ''2^^n^^-1'' nonzero states.

You can [[Try Your Own LFSR]], and see how the even prime ''2'' and the concept of polynomials lurks in the math behind LFSR.</pre>
</div>
<div title="SiteSubtitle" modifier="Joseph" modified="201001170531" created="200706080835" changecount="8">
<pre>Math Topics</pre>
</div>
<div title="SiteTitle" modifier="Joseph" modified="201001170529" created="200706080834" changecount="7">
<pre>JCQ</pre>
</div>
<div title="StyleSheet" modifier="Joseph" modified="200706111015" created="200706091238" changecount="7">
<pre>/*{{{*/
/* horizontal main menu */

#displayArea { margin: 1em 15.5em 0em 1em; } /* use the full horizontal width */

#topMenu { background: [[ColorPalette::PrimaryMid]]; color: [[ColorPalette::PrimaryPale]]; padding: 0.2em 0.2em 0.2em 0.5em; border-bottom: 2px solid #000000; }

#topMenu br { display: none; }

#topMenu .button, #topMenu .tiddlyLink, #topMenu a { margin-left: 0.25em; margin-right: 0.25em; padding-left: 0.5em; padding-right: 0.5em; color: [[ColorPalette::PrimaryPale]]; font-size: 1.15em; }

#topMenu .button:hover, #topMenu .tiddlyLink:hover { background: [[ColorPalette::PrimaryDark]]; }

/* GIFFMEX TWEAKS TO STYLESHEETPRINT (so that nothing but tiddler title and text are printed) */


@media print {#mainMenu {display: none ! important;}}
@media print {#topMenu {display: none ! important;}}
@media print {#sidebar {display: none ! important;}}
@media print {#messageArea {display: none ! important;}}
@media print {#toolbar {display: none ! important;}}
@media print {.header {display: none ! important;}}
@media print {.tiddler .subtitle {display: none ! important;}}
@media print {.tiddler .toolbar {display; none ! important; }}
@media print {.tiddler .tagging {display; none ! important; }}
@media print {.tiddler .tagged {display; none ! important; }}
@media print {#displayArea {margin: 1em 1em 0em 1em;}}
@media print {.pageBreak {page-break-before: always;}}

a.button{
 border: 0;

}

/*Color changes*/


#sidebarOptions input {
  border: 1px solid [[ColorPalette::TertiaryPale]];
}

#sidebarOptions .sliderPanel {
    background: [[ColorPalette::TertiaryPale]];
}

#sidebarOptions .sliderPanel a {
    border: none;
 color: [[ColorPalette::PrimaryMid]];
}

#sidebarOptions .sliderPanel a:hover {
 color: [[ColorPalette::Background]];
  background: [[ColorPalette::TertiaryPale]];
}

#sidebarOptions .sliderPanel a:active {
 color: [[ColorPalette::PrimaryMid]];
  background: [[ColorPalette::TertiaryPale]];
}

/*Makes sliders bold - or not (seems no effect)*/

.tuduSlider .button{font-weight: bold;}

/* (2) Adjusts the color for all headlines so they are both readable and match my color schemes. */

h1,h2,h3,h4,h5 {
 color: #000;
 background: [[ColorPalette::TertiaryPale]];
}

table {border:2px solid [[ColorPalette::TertiaryDark]];}
th, thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:#000;}
td, tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.title {
color: [[ColorPalette::PrimaryMid]];
}

/* (2) Makes text verdana or georgia. */

body {
 font-family: verdana;
 font-size: 9pt;
}

/* (4) Allows for Greek - one way */

   .greek {
      font-family: Palatino Linotype;
      font-style: normal;
      font-size: 150%;
   }

/* (5) Shortens the height of the Header */

.headerShadow {
 padding: 1.5em 0em 1em 1em;
}

.headerForeground {
 padding: 2em 0em 1em 1em;
}

/* (8) Makes ordered and unordered lists double-spaced between items but single-spaced within items. -- or not (has effect) */
/*
.viewer li {
   padding-top: 0.5em;
   padding-bottom: 0.5em;
}
*/
/*Makes block quotes line-less -- or not (has effect)*/
/*
.viewer blockquote {
border-left: 0px;
margin-top:0em;
margin-bottom:0em;
}
*/
/* Cosmetic fixes that probably should be included in a future TW... */

.viewer .listTitle { list-style-type:none; margin-left:-2em; }
.editorFooter .button { padding-top: 0px; padding-bottom:0px; }

/*Important stuff. See TagglyTaggingStyles and HorizontalMainMenuStyles*/

[[Styles TagglyTagging]]
[[Styles HorizontalMainMenu]]

/*Just colours, fonts, tweaks etc. See MessageTopRight and SideBarWhiteAndGrey*/

body {
  background: #eee; }
.headerForeground a {
  color: #6fc;}
.headerShadow {
  left: 2px;
  top: 2px; }
.siteSubtitle {
  padding-left: 1.5em; }

.shadow .title {
  color: #999; }

.viewer pre {
  background-color: #f8f8ff;
  border-color: #ddf }

/*Shape of Tiddler display*/
.tiddler {
  border-top:    1px solid #ccc;
  border-left:   1px solid #ccc;
  border-bottom: 3px solid #ccc;
  border-right:  3px solid #ccc;
  margin: 0.5em;
  background:#fff;
  padding: 0.5em;
  -moz-border-radius: 1em; }

#messageArea {
  background-color: #eee;
  border-color: #8ab;
  border-width: 4px;
  border-style: dotted;
  font-size: 90%;
  padding: 0.5em;
  -moz-border-radius: 1em; }

#messageArea .button { text-decoration:none; font-weight:bold; background:transparent; border:0px; }

#messageArea .button:hover {background: #acd; }

.editorFooter .button {
  padding-top: 0px;
  padding-bottom:0px;
  background: #fff;
  color: #000;
  border-top:    1px solid #ccc;
  border-left:   1px solid #ccc;
  border-bottom: 2px solid #ccc;
  border-right:  2px solid #ccc;
  margin-left: 3px;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px; }

.editorFooter .button:hover {
  border-top:    2px solid #ccc;
  border-left:   2px solid #ccc;
  border-bottom: 1px solid #ccc;
  border-right:  1px solid #ccc;
  margin-left: 3px;
  padding-top: 1px;
  padding-bottom: 1px;
  padding-left: 5px;
  padding-right: 5px; }

/*The Tag Box*/
.tagged {
  padding: 0.5em;
  background-color: #eee;
  border-top:    1px solid #ccc;
  border-left:   1px solid #ccc;
  border-bottom: 3px solid #ccc;
  border-right:  3px solid #ccc;
  -moz-border-radius: 1em; }

.selected .tagged {
  padding: 0.5em;
  background-color: #eee;
  border-top:    1px solid #ccc;
  border-left:   1px solid #ccc;
  border-bottom: 3px solid #ccc;
  border-right:  3px solid #ccc;
  -moz-border-radius: 1em; }

Clint's fix for weird IE behaviour
body {position:static;}
.tagClear{margin-top:1em;clear:both;}


/*}}}*/

/*{{{*/

/* text alignments */
.left
 { display:block;text-align:left; }
.center
   { display:block;text-align:center; }
.right
  { display:block;text-align:right; }
.justify
 { display:block;text-align:justify; }
.indent
    { margin:0;padding:0;border:0;margin-left:2em; }
.floatleft
  { float:left; }
.floatright
  { float:right; }
.clear
  { clear:both; }
.wrap
    { white-space:normal; }
.nowrap
  { white-space:nowrap; }
.hidden
  { display:none; }
.span
  { display:span; }
.block
 { display:blockquote; }

/* font sizes */
.big
 { font-size:14pt;line-height:120% }
.medium
  { font-size:12pt;line-height:120% }
.normal
  { font-size:9pt;line-height:120% }
.small
    { font-size:8pt;line-height:120% }
.fine
 { font-size:7pt;line-height:120% }
.tiny
 { font-size:6pt;line-height:120% }
.larger
   { font-size:120%; }
.smaller
 { font-size:80%; }

/* font styles */
.bold
    { font-weight:bold; }
.italics
   { font-style:italics; }
.underline
   { text-decoration:underline; }

/* multi-column tiddler content (not supported in Internet Explorer) */
.twocolumns
    { display:block; -moz-column-count:2; -moz-column-gap:1em; -moz-column-width:50%;}
.threecolumns
 { display:block; -moz-column-count:3; -moz-column-gap:1em; -moz-column-width:33%}
.fourcolumns
   { display:block; -moz-column-count:4; -moz-column-gap:1em; -moz-column-width:25%}

/* borderless tables */
.borderless, .borderless table, .borderless td, .borderless tr, .borderless th, .borderless tbody
   { border:0 !important; margin:0 !important; padding:0 !important; }

/* thumbnail images (fixed-sized scaled images) */
.thumbnail img { height:5em !important; }

/* grouped content */
.outline
   { display:block; padding:1em; -moz-border-radius:1em; border:1px solid; }
.menubox
   { display:block; padding:1em; -moz-border-radius:1em; border:1px solid; background:#ccccff; color:#000; }
.menubox .button, .menubox .tiddlyLinkExisting, .menubox .tiddlyLinkNonExisting
    { color:#009 !important; }
.groupbox
 { display:block; padding:1em; -moz-border-radius:1em; border:1px solid; background:#ffe; color:#000; }
.groupbox a, .groupbox .button, .groupbox .tiddlyLinkExisting, .groupbox .tiddlyLinkNonExisting
   { color:#009 !important; }
.groupbox code
    { color:#333 !important; }
.borderleft
   { margin:0;padding:0;border:0;margin-left:1em; border-left:1px dotted; padding-left:.5em; }
.borderright
 { margin:0;padding:0;border:0;margin-right:1em; border-right:1px dotted; padding-right:.5em; }
.borderbottom
 { margin:0;padding:1px 0;border:0;border-bottom:1px dotted; margin-bottom:1px; padding-bottom:1px; }
.bordertop
  { margin:0;padding:0;border:0;border-top:1px dotted; margin-top:1px; padding-top:1px; }

/* compact form */
.smallform
 { white-space:nowrap; }
.smallform input, .smallform textarea, .smallform button, .smallform checkbox, .smallform radio, .smallform select
   { font-size:8pt; }

/* colors */
.green { color:#6f6 !important }
.red { color:#f66 !important }
.blue { color:#99f !important }

/*}}}*/</pre>
</div>
<div title="TiddlyWikiSyntax" modifier="Joseph" modified="201001180339" created="200706081139" tags="gift" changecount="5">
<pre>Can we see a table?

|!Table header|!Column Two|
|&gt;| colspan |
| rowspan |left aligned|
|~| right aligned|
|bgcolor(#DC1A1A):colored| centered |
||*lists&lt;br&gt;*within&lt;br&gt;*tables&lt;br&gt;&lt;br&gt;and double-spaced too|
|table caption|c

&lt;&lt;&lt;
      This is how things should appear ~HaHaHa
      This is how things should say, ~HoHoHo
&lt;&lt;&lt;

Link to [[TiddlyWiki Tutorial|file:///C:/jc/www/wiki/tiddly/twfortherestofus.html]]

This is a ''sparkline'' of primes: &lt;&lt;sparkline 2 3 5 7 11 13 17 19 23 29 31&gt;&gt;</pre>
</div>
<div title="TiddlyWikiSyntax 2" modifier="Joseph" modified="201001180010" created="200706081126" tags="gift" changecount="1">
<pre>Ruby On Rails has the following:
* Use of Ruby
* Use of Framework
** topic for all
** topic for some
** topic for others
* Use of Rails
* Use of Web applications

| &lt;&lt;gradient vert #ffffff #ffdddd #ff8888&gt;&gt;Colors&gt;&gt; | &lt;&lt;gradient vert #ffffff #ddffdd #88ff88&gt;&gt;Interestng&gt;&gt; | &lt;&lt;gradient vert #ffffff #ddddff #8888ff&gt;&gt;CCS is really powerful&gt;&gt; |
&lt;&lt;gradient vert #000000 #660000 #aa2222&gt;&gt;color:#ffffff;font-size:22pt;Cool Color Scheme&gt;&gt;

Link to other documents
# [[Pencil|my docs/my pencil.doc]]
# [[PSS Tax|my docs/my psstax.pdf]]
# [[Proverbs|my docs/Chinese proverb.pps]]</pre>
</div>
<div title="ToggleRightSidebar" modifier="Joseph" modified="200711211114" created="200607182328" tags="script includeNew MenuPackage" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200706041426" changecount="4">
<pre>/%
|Name|ToggleRightSidebar|
|Source|http://www.TiddlyTools.com/#ToggleRightSidebar|
|Version|0.0.0|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;&lt;br&gt;&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|script|
|Requires||
|Overrides||
|Description||
%/&lt;script label=&quot;show/hide right sidebar&quot;&gt;
 var show=document.getElementById('sidebar').style.display=='none';
 if (!show) {
 document.getElementById('sidebar').style.display='none';
 var margin='1em';
 }
 else {
 document.getElementById('sidebar').style.display='block';
 var margin=config.options.txtDisplayAreaRightMargin?config.options.txtDisplayAreaRightMargin:&quot;&quot;;
 }
 place.innerHTML=(show?&quot;Need More Room?&quot;:&quot;Need the Sidebar?&quot;); // SET LINK TEXT
 place.title=show?&quot;hide sidebar&quot;:&quot;show sidebar&quot;; // SET TOOLTIP
 document.getElementById('displayArea').style.marginRight=margin;
 config.options.chkShowRightSidebar=show;
 saveOptionCookie('chkShowRightSidebar');
 var sm=document.getElementById(&quot;storyMenu&quot;); if (sm) config.refreshers.content(sm);
 return false;
&lt;/script&gt;&lt;script&gt;
 if (config.options.chkShowRightSidebar==undefined)
 config.options.chkShowRightSidebar=true;
 if (!config.options.txtDisplayAreaRightMargin||!config.options.txtDisplayAreaRightMargin.length)
 config.options.txtDisplayAreaRightMargin=&quot;15em&quot;;
 var show=config.options.chkShowRightSidebar;
 document.getElementById('sidebar').style.display=show?&quot;block&quot;:&quot;none&quot;;
 document.getElementById('displayArea').style.marginRight=show?config.options.txtDisplayAreaRightMargin:&quot;1em&quot;;
 place.lastChild.innerHTML=(show?&quot;Hide Sidebar&quot;:&quot;Show Sidebar&quot;); // SET LINK TEXT
 place.lastChild.title=show?&quot;hide sidebar&quot;:&quot;show sidebar&quot;; // SET TOOLTIP
 place.lastChild.style.fontWeight=&quot;normal&quot;;
&lt;/script&gt;</pre>
</div>
<div title="Try Your Own Hashing" modifier="Joseph" modified="201003070141" created="201003020537" changecount="58">
<pre>We shall get our hands on the nuts-and-bolts of ''Hash Functions'' -- how to throw darts by computation. 

For these examples, the input key is a String (in Unicode, so it is multilingual), and the result is an integer, i.e. ''hash'': String -&gt; Integer.

The number of Strings is infinite (or at least a very large number if you restrict to Strings up to a certain length), but the number of Integers is finite from modulo arithmetic, hence collisions will occur. We shall take a look at how these ''hash collisions'' relate to primes or non-primes.
!Hashing with Computation (Primes or not)
An example of a real-life ''hash function'', in which prime numbers play a role, is the ''hashCode()'' function for ''Strings'' in the ''Java'' programming language.
Basically, the idea is that every String in Java can be mapped to a signed integer from -2^^31^^ to 2^^31^^-1, or -2147483648 to 2147483647.

As explained in [[Java String HashCode]], the algorithm is documented, which involves using the prime ''31'' as the multiplier. Click the ''Go!'' button below to find out how Java gives the hashCode for 3 names:

&lt;html&gt;
&lt;form&gt;
&lt;table width=&quot;80%&quot; border=&quot;3&quot; bgcolor=&quot;#F2DFCB&quot;&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       &lt;b&gt;Java HashCode for String s&lt;/b&gt;: s[0]*m&lt;sup&gt;(n-1)&lt;/sup&gt; + s[1]*m&lt;sup&gt;(n-2)&lt;/sup&gt; + ... + s[n-1] where s[i] is the character at position index i.&lt;br&gt;
       &lt;b&gt;Java HashCode for String s&lt;/b&gt;: (...((s[0]*m + s[1])*m + ....)*m + s[n-1]) where s[i] is the character at position index i.&lt;br&gt;
       Multiplier m: &lt;INPUT name=&quot;m&quot; type=&quot;text&quot; size=&quot;5%&quot; value=&quot;31&quot;&gt;
       String Data: &lt;INPUT id=&quot;hash.data&quot; name=&quot;data&quot; type=&quot;text&quot; size=&quot;72%&quot; value=&quot;Joe Miller,Anna Miller,Zebadiah Miller&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
               onClick=&quot;Logger.set('hash.logger');new HashCode(parseInt(m.value)).run(data.value);&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot;&gt;Result:&lt;br&gt;&lt;textarea id=&quot;hash.logger&quot; cols=&quot;100%&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       &lt;b&gt;My Hash Function&lt;/b&gt;&lt;br&gt;
       Code: &lt;textarea id=&quot;hash.code&quot; name=&quot;code&quot; cols=&quot;80%&quot; rows=&quot;8&quot;&gt;
// Example of a Simple Hash Function (can be bad)
function hash(s) {                     // s = input String
    var h = 0;                         // initiate hash value
    for (var j=0; j &lt; s.length; j++) { // loop through chars in s
        var c = s.charCodeAt(j);       // get character code
        h = (h + c) % 100;             // add code, keep last 2 digits
    }
    return h;                          // return hash value: 0..99
}
       &lt;/textarea&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;My Hash!&quot; height=&quot;50&quot;
               onClick=&quot;Logger.set('hash.logger');new HashCode(-1).apply(code.value, data.value);&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/html&gt;
You can change the value of multiplier ''m'', say from ''31'' (a prime) to ''32'' (a power of 2), and see the effect on hashing the names.

You can type in your String data, separated by comma, to experiment with hashing your Strings. Try different values for the multiplier m. Even with ''m=31'', there will be collisions, see if you can easily find some examples. An example is already given.

For those with a bit of Javascript programming experience, you can type your own ''hash function'' in the ''Code'' input, and press ''My Hash!'' to see how your own hash function works on the String data.
!Hashing without Computation (almost)
Everyone has his/her favorite tunes. How many songs can you recognize? Probably a fairly large number. How can we easily recognize (i.e. data retrieval of) so many songs? Believe it or not, we all do this by ''Hashing'' -- and easily as no computation is involved!.

We can all recognize a tune by its first few notes, e.g. high-doh, ti, la, so, fa, me, ray, doh (for &quot;Joy to the world, the Lord is come.&quot;), which is 17654321 (use 1=doh, etc. Different octaves count as same note, as in modulo arithmetic). The origin of this 7-notes scale of Western music (or the 5-sounds of Chinese: 五聲「宮、商、角、徵、羽」) is lost in antiquity. If we take the first 8 notes, as in this example, the result will be an 8-digit number in base 7 (digit 0=7). There will be 7^^8^^ hash values, or 5,764,801 tunes, more than 5 millions songs! ''Hash collision'' in this case is almost none -- do you recall any two songs starting with the same 8 notes?

This page cannot simulate this wonderful ''tune-hashing'' of our brains -- we can't load .mp3 files to hash. So I'll try something different, but based on the same idea. Instead of musical songs, I'll use textual strings: poems. Like the songs, we can recall a Chinese poem by its first sentence. But instead of 7 (or 5) musical notes, we have 3,000+ Chinese characters -- not practical for fast computation. So I'll twist the idea a bit: scanning the successive character codes, they either increase or decrease. We shall put a 1 for increase, 0 for decrease, like so:

|!Character|!Unicode|!Increase?|!Bit (Binary Digit)|!Hash value (so far)|
|床| 24202| -| -| -|
|前| 21069| no| 0|0|
|明| 26126| yes| 1|01|
|月| 26376| yes| 1|011|
|光| 20809| no| 0|0110 |
|''Hashing'' poem by first sentence, ''hash value'' = 0110 binary = 6 decimal.|c

Click &lt;html&gt;&lt;a href=&quot;javascript:Logger.set('hash.logger');new HashCode(0).poem(5);&quot;&gt;五言詩 Hash&lt;/a&gt;&lt;/html&gt;, and scroll to display above. As there are only 2^^(5-1)^^=2^^4^^=16 hash values, it is all too easy to get a collision with 8 poems.
Click &lt;html&gt;&lt;a href=&quot;javascript:Logger.set('hash.logger');new HashCode(0).poem(7);&quot;&gt;七言詩 Hash&lt;/a&gt;&lt;/html&gt;, and scroll to display above. As there are 2^^(7-1)^^=2^^6^^=64 hash values, you'll need more than 8 poems to encounter some collision.

This hashing algorithm uses only binary decisions, no computations -- the last conversion of binary to decimal is done for us: machines prefer just binary, and our brains can store musical notes &quot;as is&quot;. These examples illustrate how effective the ''tune-hashing'' by leading notes is, inside our heads!</pre>
</div>
<div title="Try Your Own Interleaving" modifier="Joseph" modified="201003081329" created="201003030537" changecount="11">
<pre>We shall see the effect of interleaving on sequences.

First, interleaving is applied to a periodic sequence 1,2,3,...,p,1,2,3,... with ''period'' p.
Then interleaving is applied to the (aperiodic) sequence 1,2,3,4,.... of all natural numbers.
!Finite Interleaving
Click the top button ''Go!'' below to generate Interleave sequences with ''order'' d (0 &lt; d &lt; p) where p is the ''period'' of the finite periodic sequence.
&lt;html&gt;
&lt;form&gt;
&lt;table width=&quot;80%&quot; border=&quot;3&quot; bgcolor=&quot;#F1D7F7&quot;&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       &lt;b&gt;Finite Interleaving (Periodic)&lt;/b&gt;&lt;br&gt;
       Period p: &lt;input name=&quot;p&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;17&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
               onClick=&quot;Logger.set('interleave.logger');new Interleave(true, parseInt(p.value)).run();&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot;&gt;Result:&lt;br&gt;&lt;textarea id=&quot;interleave.logger&quot; cols=&quot;100%&quot; rows=&quot;20&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       &lt;b&gt;Infinite Interleaving (Aperiodic)&lt;/b&gt;&lt;br&gt;
       Parts p: &lt;input name=&quot;n&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;7&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
               onClick=&quot;Logger.set('interleave.logger');new Interleave(false, parseInt(n.value)).run();&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/html&gt;
Change the ''period'' to other values, say 18, and find out what interleave sequences are generated.

For composite periods, some interleave sequence will have shorter periods. Can you predict what these shorter periods are?
To understand the math behind the scene, read [[Finite Interleaving]].
!Infinite Interleaving
Click the bottom button ''Go!'' above to find out the distribution of ''multiples'' k when the infinite sequence 1,2,3,... is divided into ''p'' parts.

Change the number of ''parts'' to see how the distribution of ''multiples'' is affected.

For composite number of parts, the distribution of some multiples will not be over all parts. Can you predict how many parts for such multiples?
To understand the math behind the scene, read [[Infinite Interleaving]].</pre>
</div>
<div title="Try Your Own LFSR" modifier="Joseph" modified="201001210147" created="201001200618" changecount="20">
<pre>You can design your own n-bit LFSR with taps and seed. The 4-bit LFSR example can be tested by: n=4, taps: 3,4 and seed=3.

!LFSR Simulation
Can you build an ''n-bit LFSR'' to go through all the ''2^^n^^-1'' nonzero states in no particular pattern?

&lt;html&gt;
&lt;form&gt;
&lt;table width=&quot;80%&quot; border=&quot;3&quot; bgcolor=&quot;#F5FD33&quot;&gt;
&lt;tr&gt;
    &lt;td align=&quot;left&quot;&gt;
       bits n: &lt;INPUT name=&quot;bits&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;4&quot;&gt;
       taps a,b,c (1-based): &lt;INPUT name=&quot;taps&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;3,4&quot;&gt;
       seed: &lt;INPUT name=&quot;seed&quot; type=&quot;text&quot; size=&quot;10%&quot; value=&quot;3&quot;&gt;
    &lt;/td&gt;
    &lt;td&gt;&lt;input type=&quot;button&quot; value=&quot;Go!&quot; height=&quot;50&quot;
               onClick=&quot;Logger.set('lfsr.logger'); new LFSR(toBits(parseInt(seed.value), parseInt(bits.value)), taps.value.split(',')).run();&quot;&gt;
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td colspan=&quot;2&quot;&gt;&lt;textarea id=&quot;lfsr.logger&quot; cols=&quot;100%&quot; rows=&quot;10&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/form&gt;
&lt;/html&gt;

Typical results are (any nonzero seed will do, e.g. seed = 3 in decimal):

|!n = Number of bits|!taps (1-based)|!Number of states reached|!Total number of nonzero states|!Comment|
|4|3,4|15|15|all states reached|
|4|1,4|15|15|all states reached|
|4|1,2|4|15||
|4|1,3|7|15||
|4|2,3|8|15||
|5|2,3|9|31||
|5|2,5|31|31|all states reached|
|5|1,3,5|15|31||
|6|1,3,5|15|63||
|6|1,5|21|63||
|6|1,6|63|63|all states reached|
|7|1,7|127|127|all states reached|

These results show that, for a given n, only very specific taps will give an LFSR reaching all nonzero states. In these cases, the carry bit of LFSR flips through 0 and 1, in a pattern that only repeats after 2^^n^^-1 ticks.

!LFSR Taps
Where should the taps of an ''n-bit LFSR'' be placed so that it will change through all its ''2^^n^^-1'' nonzero states? Is this always possible for every n? These are studied in a deep math theory (Galois fields) involving the (only) even prime: ''2''.

In math (abstract algebra), a ''Field'' is a system in which you can add, subtract, multiply and divide consistently. For example, all the fractions (numbers of the form n/m) is an example of a field, which is infinite. The 19th century math genius &amp;Eacute;variste Galois discovered that, corresponding to each power ''n'' of a prime ''p'', there is a finite field with ''p^^n^^'' elements, now called Galois Field ''GF(p^^n^^)''. Moreover, each such finite field has its associated [[Primitive Polynomials]] that are of fundamental importance. They are related to LFSR due to the following result:

For the even prime ''2'', a ''primitive polynomials'' of degree ''n'' for the Galois field ''GF(2^^n^^)'' gives the taps for the n-bit LFSR reaching all ''2^^n^^-1'' nonzero states.

|!degree n|!primitive polynomials of degree n in GF(2^^n^^)|!n-bit LFSR|!(1-based) taps for n-bit LFSR|
|1|1+x|1|taps: 1|
|2|1+x+x^^2^^|2|taps: 1,2|
|3|1+x+x^^3^^|3|taps: 1,3|
|3|1+x^^2^^+x^^3^^|3|taps: 2,3|
|4|1+x+x^^4^^|4|taps: 1,4|
|4|1+x^^3^^+x^^4^^|4|taps: 3,4|
|5|1+x^^2^^+x^^5^^|5|taps: 2,5|
|5|1+x+x^^2^^+x^^3^^+x^^5^^|5|taps: 1,2,3,5|
|5|1+x^^3^^+x^^5^^|5|taps: 3,5|
|5|1+x+x^^3^^+x^^4^^+x^^5^^|5|taps: 1,3,4,5|
|5|1+x^^2^^+x^^3^^+x^^4^^+x^^5^^|5|taps: 2,3,4,5|
|5|1+x+x^^2^^+x^^4^^+x^^5^^|5|taps: 1,2,4,5|
|''Primitive Polynomials of GF(2^^n^^)''|c

Can you see how the taps are related to the term-exponents in the primitive polynomial?

Taking the carry bit from LFSR as output, it looks like a random flip of a coin: 1=head, 0=tail. With start-of-art technology in micro-electronics, it is routine to implement a 32-bit LFSR, with period 2^^32^^-1 = 4294967295.</pre>
</div>
<div title="Ulam Spiral" modifier="Joseph" modified="201002010510" created="201001311308" changecount="10">
<pre>!~Two-Dimensional Pattern
In 1963, the mathematician Stanislaw Ulam, while he was doodling on scratch paper at a boring scientific meeting, wrote down a regular rectangular grid of numbers, starting with 1 at the center, and spiraling out like this:

[img[IntegerSpiral.gif]] 

Idly he marked out the primes along this wrapped number line: 

[img[UlamSpiralNumeric.gif]]

This is a 2D picture of the prime distribution -- now called the [[Ulam Spiral|http://en.wikipedia.org/wiki/Ulam_spiral]] . Can you spot any patterns?

!Pattern In Spiral
If the applet below is not shown properly, please click [[here|ulam.html]].

&lt;html&gt;
&lt;applet code=&quot;ulam.class&quot; archive=&quot;ulam.jar&quot; width=600 height=350&gt;&lt;/applet&gt;
&lt;/html&gt;

Since all squares in the Ulam spiral are numbered, you can choose which square to be at the center of the picture. The number of the center square is shown on the left -- you can type the square number yourself, or use the directional keys to shift the center.

The Ulam spiral need not start with 1 -- any number ''n'' will do, the spiral just continues to be ''n+1'', ''n+2'', etc. The starting number ''n'' is shown on the right -- you can type another starting number yourself, or use the up/down triangle keys to increment/decrement the starting number.

You can also zoom in/out of the picture via the magnifying keys.

For more information about this applet, check [[http://www.alpertron.com.ar/ULAM.HTM|ulam.htm]].
</pre>
</div>
<div title="ViewTemplate" modifier="Joseph" created="200706101008" changecount="1">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date [[DD MMM YYYY]]'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date [[DD MMM YYYY]]'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="WikiWord" modifier="GiffMex" modified="200703071349" created="200612031340" server.type="file" server.host="file://C:\sjc\swww\swiki\stiddly\stwfortherestofus.html" server.page.revision="200703071349">
<pre>A WikiWord is a word that combines upper and lowercase letters. Examples: ~WikiWord, ~GiffMex, ~MainMenu, ~AbrahamLincoln, etc.</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->
<!--POST-BODY-END-->
<script type="text/javascript">
//<![CDATA[
//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
    numRssItems: 20, // Number of items in the RSS feed
    animDuration: 400, // Duration of UI animations in milliseconds
    cascadeFast: 20, // Speed for cascade animations (higher == slower)
    cascadeSlow: 60, // Speed for EasterEgg cascade animations
    cascadeDepth: 5 // Depth of cascade animation
};

// Adaptors
config.adaptors = {};

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
    messageClose: {},
    dates: {},
    tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
    chkRegExpSearch: false,
    chkCaseSensitiveSearch: false,
    chkAnimate: true,
    chkSaveBackups: true,
    chkAutoSave: false,
    chkGenerateAnRssFeed: false,
    chkSaveEmptyTemplate: false,
    chkOpenInNewWindow: true,
    chkToggleLinks: false,
    chkHttpReadOnly: true,
    chkForceMinorUpdate: false,
    chkConfirmDelete: true,
    chkInsertTabs: false,
    chkUsePreForStorage: true, // Whether to use <pre> format for storage
    chkDisplayStartupTime: false,
    txtBackupFolder: "",
    txtMainTab: "tabTimeline",
    txtMoreTab: "moreTabAll",
    txtMaxEditRows: "30",
    txtFileSystemCharSet: "UTF-8"
    };
config.optionsDesc = {};

// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
    {name: "StyleSheetLayout", notify: refreshStyles},
    {name: "StyleSheetColors", notify: refreshStyles},
    {name: "StyleSheet", notify: refreshStyles},
    {name: "StyleSheetPrint", notify: refreshStyles},
    {name: "PageTemplate", notify: refreshPageTemplate},
    {name: "SiteTitle", notify: refreshPageTitle},
    {name: "SiteSubtitle", notify: refreshPageTitle},
    {name: "ColorPalette", notify: refreshColorPalette},
    {name: null, notify: refreshDisplay}
];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
    1: "ViewTemplate",
    2: "EditTemplate"
};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
    wikified: {
        tag: {}
    },
    editor: {
        tagChooser: {}
    }
};

// Backstage tasks
config.backstageTasks = ["save","sync","importTask","tweak","plugins"];

// Macros; each has a 'handler' member that is inserted later
config.macros = {
    today: {},
    version: {},
    search: {sizeTextbox: 15},
    tiddler: {},
    tag: {},
    tags: {},
    tagging: {},
    timeline: {},
    allTags: {},
    list: {
        all: {},
        missing: {},
        orphans: {},
        shadowed: {},
        touched: {}
    },
    closeAll: {},
    permaview: {},
    saveChanges: {},
    slider: {},
    option: {},
    options: {},
    newTiddler: {},
    newJournal: {},
    sparkline: {},
    tabs: {},
    gradient: {},
    message: {},
    view: {},
    edit: {},
    tagChooser: {},
    toolbar: {},
    br: {},
    plugins: {},
    refreshDisplay: {},
    importTiddlers: {},
    sync: {},
    annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
    closeTiddler: {},
    closeOthers: {},
    editTiddler: {},
    saveTiddler: {hideReadOnly: true},
    cancelTiddler: {},
    deleteTiddler: {hideReadOnly: true},
    permalink: {},
    references: {type: "popup"},
    jump: {type: "popup"},
    syncing: {type: "popup"},
    fields: {type: "popup"}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
    isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
    isGecko: config.userAgent.indexOf("gecko") != -1,
    ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
    isSafari: config.userAgent.indexOf("applewebkit") != -1,
    isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
    firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
    isOpera: config.userAgent.indexOf("opera") != -1,
    isLinux: config.userAgent.indexOf("linux") != -1,
    isUnix: config.userAgent.indexOf("x11") != -1,
    isMac: config.userAgent.indexOf("mac") != -1,
    isWindows: config.userAgent.indexOf("win") != -1
};

// Basic regular expressions
config.textPrimitives = {
    upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
    lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
    anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
    anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
    config.textPrimitives = {
        upperLetter: "[A-Z\u00c0-\u00de]",
        lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
        anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
        anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
    };
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.urlPattern = "[a-z]{3,8}:[^\\s:'\"][^\\s'\"]*(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
    config.textPrimitives.lowerLetter + "+" +
    config.textPrimitives.upperLetter +
    config.textPrimitives.anyLetter + "*)|(?:" +
    config.textPrimitives.upperLetter + "{2,}" +
    config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
    config.textPrimitives.brackettedLink + ")|(?:" +
    config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
    config.textPrimitives.titledBrackettedLink + ")|(?:" +
    config.textPrimitives.brackettedLink + ")|(?:" +
    config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
    browsers: [
        function() {return config.browser.isIE;},
        function() {return true}
    ],
    currBrowser: null,
    codes: {
        downTriangle: ["\u25BC","\u25BE"],
        downArrow: ["\u2193","\u2193"],
        bentArrowLeft: ["\u2190","\u21A9"],
        bentArrowRight: ["\u2192","\u21AA"]
    }
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
    StyleSheet: "",
    MarkupPreHead: "<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->",
    MarkupPostHead: "",
    MarkupPreBody: "",
    MarkupPostBody: "",
    TabTimeline: '<<timeline>>',
    TabAll: '<<list all>>',
    TabTags: '<<allTags excludeLists>>',
    TabMoreMissing: '<<list missing>>',
    TabMoreOrphans: '<<list orphans>>',
    TabMoreShadowed: '<<list shadowed>>',
    AdvancedOptions: '<<options>>',
    PluginManager: '<<plugins>>',
    ImportTiddlers: '<<importTiddlers>>'
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
    txtUserName: "YourName"});

merge(config.tasks,{
    save: {text: "save", tooltip: "Save your changes to this TiddlyWiki", action: saveChanges},
    sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
    importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
    tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
    plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
    txtUserName: "Username for signing your edits",
    chkRegExpSearch: "Enable regular expressions for searches",
    chkCaseSensitiveSearch: "Case-sensitive searching",
    chkAnimate: "Enable animations",
    chkSaveBackups: "Keep backup file when saving changes",
    chkAutoSave: "Automatically save changes",
    chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
    chkSaveEmptyTemplate: "Generate an empty template when saving changes",
    chkOpenInNewWindow: "Open external links in a new window",
    chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
    chkHttpReadOnly: "Hide editing features when viewed over HTTP",
    chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
    chkConfirmDelete: "Require confirmation before deleting tiddlers",
    chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
    txtBackupFolder: "Name of folder to use for backups",
    txtMaxEditRows: "Maximum number of rows in edit boxes",
    txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
    customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
    pluginError: "Error: %0",
    pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
    pluginForced: "Executed because forced via 'systemConfigForce' tag",
    pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
    nothingSelected: "Nothing is selected. You must select one or more items first",
    savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
    subtitleUnknown: "(unknown)",
    undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
    shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
    tiddlerLinkTooltip: "%0 - %1, %2",
    externalLinkTooltip: "External link to %0",
    noTags: "There are no tagged tiddlers",
    notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
    cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
    invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
    backupSaved: "Backup saved",
    backupFailed: "Failed to save backup file",
    rssSaved: "RSS feed saved",
    rssFailed: "Failed to save RSS feed file",
    emptySaved: "Empty template saved",
    emptyFailed: "Failed to save empty template file",
    mainSaved: "Main TiddlyWiki file saved",
    mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
    macroError: "Error in macro <<\%0>>",
    macroErrorDetails: "Error while executing macro <<\%0>>:\n%1",
    missingMacro: "No such macro",
    overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
    unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
    confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
    saveInstructions: "SaveChanges",
    unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
    tiddlerSaveError: "Error when saving tiddler '%0'",
    tiddlerLoadError: "Error when loading tiddler '%0'",
    wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
    invalidFieldName: "Invalid field name %0",
    fieldCannotBeChanged: "Field '%0' cannot be changed",
    loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'"});

merge(config.messages.messageClose,{
    text: "close",
    tooltip: "close this message area"});

config.messages.backstage = {
    open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
    close: {text: "close", tooltip: "Close the backstage area"},
    prompt: "backstage: ",
    decal: {
        edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
    }
};

config.messages.listView = {
    tiddlerTooltip: "Click for the full text of this tiddler",
    previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
        "th","th","th","th","th","th","th","th","th","th",
        "st","nd","rd","th","th","th","th","th","th","th",
        "st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
    });

merge(config.views.wikified.tag,{
    labelNoTags: "no tags",
    labelTags: "tags: ",
    openTag: "Open tag '%0'",
    tooltip: "Show tiddlers tagged with '%0'",
    openAllText: "Open all",
    openAllTooltip: "Open all of these tiddlers",
    popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
    defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
    defaultModifier: "(missing)",
    shadowModifier: "(built-in shadow tiddler)",
    dateFormat: "DD MMM YYYY",
    createdPrompt: "created"});

merge(config.views.editor,{
    tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
    defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
    text: "tags",
    tooltip: "Choose existing tags to add to this tiddler",
    popupNone: "There are no tags defined",
    tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
    sizeTemplates:
        [
        {unit: 1024*1024*1024, template: "%0\u00a0GB"},
        {unit: 1024*1024, template: "%0\u00a0MB"},
        {unit: 1024, template: "%0\u00a0KB"},
        {unit: 1, template: "%0\u00a0B"}
        ]});

merge(config.macros.search,{
    label: "search",
    prompt: "Search this TiddlyWiki",
    accessKey: "F",
    successMsg: "%0 tiddlers found matching %1",
    failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
    label: "tagging: ",
    labelNotTag: "not tagging",
    tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
    dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
    tooltip: "Show tiddlers tagged with '%0'",
    noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
    label: "close all",
    prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
    label: "permaview",
    prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
    label: "save changes",
    prompt: "Save all tiddlers to create a new TiddlyWiki",
    accessKey: "S"});

merge(config.macros.newTiddler,{
    label: "new tiddler",
    prompt: "Create a new tiddler",
    title: "New Tiddler",
    accessKey: "N"});

merge(config.macros.newJournal,{
    label: "new journal",
    prompt: "Create a new tiddler from the current date and time",
    accessKey: "J"});

merge(config.macros.options,{
    wizardTitle: "Tweak advanced options",
    step1Title: "These options are saved in cookies in your browser",
    step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
    unknownDescription: "//(unknown)//",
    listViewTemplate: {
        columns: [
            {name: 'Option', field: 'option', title: "Option", type: 'String'},
            {name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
            {name: 'Name', field: 'name', title: "Name", type: 'String'}
            ],
        rowClasses: [
            {className: 'lowlight', field: 'lowlight'}
            ]}
    });

merge(config.macros.plugins,{
    wizardTitle: "Manage plugins",
    step1Title: "Currently loaded plugins",
    step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
    skippedText: "(This plugin has not been executed because it was added since startup)",
    noPluginText: "There are no plugins installed",
    confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
    removeLabel: "remove systemConfig tag",
    removePrompt: "Remove systemConfig tag",
    deleteLabel: "delete",
    deletePrompt: "Delete these tiddlers forever",
    listViewTemplate: {
        columns: [
            {name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
            {name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
            {name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
            {name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
            {name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
            {name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
            {name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
            {name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
            {name: 'Log', field: 'log', title: "Log", type: 'StringList'}
            ],
        rowClasses: [
            {className: 'error', field: 'error'},
            {className: 'warning', field: 'warning'}
            ]}
    });

merge(config.macros.toolbar,{
    moreLabel: "more",
    morePrompt: "Reveal further commands"
    });

merge(config.macros.refreshDisplay,{
    label: "refresh",
    prompt: "Redraw the entire TiddlyWiki display"
    });

merge(config.macros.importTiddlers,{
    readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
    wizardTitle: "Import tiddlers from another file or server",
    step1Title: "Step 1: Locate the server or TiddlyWiki file",
    step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
    openLabel: "open",
    openPrompt: "Open the connection to this file or server",
    openError: "There were problems fetching the tiddlywiki file",
    statusOpenHost: "Opening the host",
    statusGetWorkspaceList: "Getting the list of available workspaces",
    step2Title: "Step 2: Choose the workspace",
    step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
    cancelLabel: "cancel",
    cancelPrompt: "Cancel this import",
    statusOpenWorkspace: "Opening the workspace",
    statusGetTiddlerList: "Getting the list of available tiddlers",
    step3Title: "Step 3: Choose the tiddlers to import",
    step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
    importLabel: "import",
    importPrompt: "Import these tiddlers",
    confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
    step4Title: "Step 4: Importing %0 tiddler(s)",
    step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
    doneLabel: "done",
    donePrompt: "Close this wizard",
    statusDoingImport: "Importing tiddlers",
    statusDoneImport: "All tiddlers imported",
    systemServerNamePattern: "%2 on %1",
    systemServerNamePatternNoWorkspace: "%1",
    confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
    serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
    serverSaveModifier: "(System)",
    listViewTemplate: {
        columns: [
            {name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
            {name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
            {name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
            {name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
            ],
        rowClasses: [
            ]}
    });

merge(config.macros.sync,{
    listViewTemplate: {
        columns: [
            {name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
            {name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
            {name: 'Server Type', field: 'serverType', title: "Server type", type: 'String'},
            {name: 'Server Host', field: 'serverHost', title: "Server host", type: 'String'},
            {name: 'Server Workspace', field: 'serverWorkspace', title: "Server workspace", type: 'String'},
            {name: 'Status', field: 'status', title: "Synchronisation status", type: 'String'},
            {name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
            ],
        rowClasses: [
            ],
        buttons: [
            {caption: "Sync these tiddlers", name: 'sync'}
            ]},
    wizardTitle: "Synchronize with external servers and files",
    step1Title: "Choose the tiddlers you want to synchronize",
    step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
    syncLabel: "sync",
    syncPrompt: "Sync these tiddlers",
    hasChanged: "Changed while unplugged",
    hasNotChanged: "Unchanged while unplugged",
    syncStatusList: {
        none: {text: "...", color: "none"},
        changedServer: {text: "Changed on server", color: '#80ff80'},
        changedLocally: {text: "Changed while unplugged", color: '#80ff80'},
        changedBoth: {text: "Changed while unplugged and on server", color: '#ff8080'},
        notFound: {text: "Not found on server", color: '#ffff80'},
        putToServer: {text: "Saved update on server", color: '#ff80ff'},
        gotFromServer: {text: "Retrieved update from server", color: '#80ffff'}
        }
    });

merge(config.macros.annotations,{
    });

merge(config.commands.closeTiddler,{
    text: "close",
    tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
    text: "close others",
    tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
    text: "edit",
    tooltip: "Edit this tiddler",
    readOnlyText: "view",
    readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
    text: "done",
    tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
    text: "cancel",
    tooltip: "Undo changes to this tiddler",
    warning: "Are you sure you want to abandon your changes to '%0'?",
    readOnlyText: "done",
    readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
    text: "delete",
    tooltip: "Delete this tiddler",
    warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
    text: "permalink",
    tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
    text: "references",
    tooltip: "Show tiddlers that link to this one",
    popupNone: "No references"});

merge(config.commands.jump,{
    text: "jump",
    tooltip: "Jump to another open tiddler"});

merge(config.commands.syncing,{
    text: "syncing",
    tooltip: "Control synchronisation of this tiddler with a server or external file",
    currentlySyncing: "<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</"+"div><div>host: <span class='popupHighlight'>%1</span></"+"div><div>workspace: <span class='popupHighlight'>%2</span></"+"div>", // Note escaping of closing <div> tag
    notCurrentlySyncing: "Not currently syncing",
    captionUnSync: "Stop synchronising this tiddler",
    chooseServer: "Synchronise this tiddler with another server:",
    currServerMarker: "\u25cf ",
    notCurrServerMarker: "  "});

merge(config.commands.fields,{
    text: "fields",
    tooltip: "Show the extended fields of this tiddler",
    emptyText: "There are no extended fields for this tiddler",
    listViewTemplate: {
        columns: [
            {name: 'Field', field: 'field', title: "Field", type: 'String'},
            {name: 'Value', field: 'value', title: "Value", type: 'String'}
            ],
        rowClasses: [
            ],
        buttons: [
            ]}});

merge(config.shadowTiddlers,{
    DefaultTiddlers: "GettingStarted",
    MainMenu: "GettingStarted",
    SiteTitle: "My TiddlyWiki",
    SiteSubtitle: "a reusable non-linear personal web notebook",
    SiteUrl: "http://www.tiddlywiki.com/",
    SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options ?" "Change TiddlyWiki advanced options">>',    SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
    TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'});

merge(config.annotations,{
    AdvancedOptions: "This shadow tiddler provides access to several advanced options",
    ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
    DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
    EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
    GettingStarted: "This shadow tiddler provides basic usage instructions",
    ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
    MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
    MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
    MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
    MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
    MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately before the script block",
    OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
    PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
    PluginManager: "This shadow tiddler provides access to the plugin manager",
    SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
    SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
    SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
    SiteTitle: "This shadow tiddler is used as the first part of the page title",
    SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
    StyleSheetColours: "This shadow tiddler contains CSS definitions related to the color of page elements",
    StyleSheet: "This tiddler can contain custom CSS definitions",
    StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements",
    StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
    StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
    TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
    TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
    TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
    TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
    TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
    TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
    TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
    ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
    });

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
config.parsers = {}; // Hashmap of alternative parsers for the wikifier
var anim = new Animator(); // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = config.browser.isSafari || config.browser.isOpera;

// Starting up
function main()
{
    var t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
    startingUp = true;
    window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
    params = getParameters();
    if(params)
        params = params.parseParams("open",null,false);
    store = new TiddlyWiki();
    invokeParamifier(params,"oninit");
    story = new Story("tiddlerDisplay","tiddler");
    addEvent(document,"click",Popup.onDocumentClick);
    saveTest();
    loadOptionsCookie();
    for(var s=0; s<config.notifyTiddlers.length; s++)
        store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
    t1 = new Date();
    store.loadFromDiv("storeArea","store",true);
    t2 = new Date();
    loadShadowTiddlers();
    t3 = new Date();
    invokeParamifier(params,"onload");
    t4 = new Date();
    readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
    var pluginProblem = loadPlugins();
    t5 = new Date();
    formatter = new Formatter(config.formatters);
    invokeParamifier(params,"onconfig");
    t6 = new Date();
    store.notifyAll();
    t7 = new Date();
    restart();
    t8 = new Date();
    if(pluginProblem) {
        story.displayTiddler(null,"PluginManager");
        displayMessage(config.messages.customConfigError);
    }
    for(var m in config.macros) {
        if(config.macros[m].init)
            config.macros[m].init();
    }
    if(!readOnly)
        backstage.init();
    t9 = new Date();
    if(config.options.chkDisplayStartupTime) {
        displayMessage("Load in " + (t2-t1) + " ms");
        displayMessage("Loadshadows in " + (t3-t2) + " ms");
        displayMessage("Loadplugins in " + (t5-t4) + " ms");
        displayMessage("Notify in " + (t7-t6) + " ms");
        displayMessage("Restart in " + (t8-t7) + " ms");
        displayMessage("Total startup in " + (t9-t0) + " ms");
    }
    startingUp = false;
}

// Restarting
function restart()
{
    invokeParamifier(params,"onstart");
    if(story.isEmpty()) {
        var defaultParams = store.getTiddlerText("DefaultTiddlers").parseParams("open",null,false);
        invokeParamifier(defaultParams,"onstart");
    }
    window.scrollTo(0,0);
}

function saveTest()
{
    var s = document.getElementById("saveTest");
    if(s.hasChildNodes())
        alert(config.messages.savedSnapshotError);
    s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
    var shadows = new TiddlyWiki();
    shadows.loadFromDiv("shadowArea","shadows",true);
    shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
    delete shadows;
}

function loadPlugins()
{
    if(safeMode)
        return false;
    var tiddlers = store.getTaggedTiddlers("systemConfig");
    var toLoad = [];
    var nLoaded = 0;
    var map = {};
    var nPlugins = tiddlers.length;
    installedPlugins = [];
    for(var i=0; i<nPlugins; i++) {
        var p = getPluginInfo(tiddlers[i]);
        installedPlugins[i] = p;
        var n = p.Name;
        if(n)
            map[n] = p;
        if(n = p.Source)
            map[n] = p;
    }
    var visit = function(p) {
        if(!p || p.done)
            return;
        p.done = 1;
        var reqs = p.Requires;
        if(reqs) {
            reqs = reqs.readBracketedList();
            for(var i=0; i<reqs.length; i++)
                visit(map[reqs[i]]);
        }
        toLoad.push(p);
    };
    for(i=0; i<nPlugins; i++)
        visit(installedPlugins[i]);
    for(i=0; i<toLoad.length; i++) {
        p = toLoad[i];
        pluginInfo = p;
        tiddler = p.tiddler;
        if(isPluginExecutable(p)) {
            if(isPluginEnabled(p)) {
                p.executed = true;
                var startTime = new Date();
                try {
                    if(tiddler.text)
                        window.eval(tiddler.text);
                    nLoaded++;
                } catch(ex) {
                    p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
                    p.error = true;
                }
                pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
            } else {
                nPlugins--;
            }
        } else {
            p.warning = true;
        }
    }
    return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
    var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
    p.tiddler = tiddler;
    p.title = tiddler.title;
    p.log = [];
    return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
    if(plugin.tiddler.isTagged("systemConfigForce"))
        return verifyTail(plugin,true,config.messages.pluginForced);
    if(plugin["CoreVersion"]) {
        var coreVersion = plugin["CoreVersion"].split(".");
        var w = parseInt(coreVersion[0]) - version.major;
        if(w == 0 && coreVersion[1])
            w = parseInt(coreVersion[1]) - version.minor;
        if(w == 0 && coreVersion[2])
            w = parseInt(coreVersion[2]) - version.revision;
        if(w > 0)
            return verifyTail(plugin,false,config.messages.pluginVersionError);
        }
    return true;
}

function isPluginEnabled(plugin)
{
    if(plugin.tiddler.isTagged("systemConfigDisable"))
        return verifyTail(plugin,false,config.messages.pluginDisabled);
    return true;
}

function verifyTail(plugin,result,message)
{
    plugin.log.push(message);
    return result;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
    try {
        var m = config.macros[macro];
        if(m && m.handler)
            m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
        else
            createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
    } catch(ex) {
        createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
    }
}

//--
//-- Paramifiers
//--

function getParameters()
{
    var p = null;
    if(window.location.hash) {
        p = decodeURI(window.location.hash.substr(1));
        if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
            p = convertUTF8ToUnicode(p);
    }
    return p;
}

function invokeParamifier(params,handler)
{
    if(!params || params.length == undefined || params.length <= 1)
        return;
    for(var t=1; t<params.length; t++) {
        var p = config.paramifiers[params[t].name];
        if(p && p[handler] instanceof Function)
            p[handler](params[t].value);
    }
}

config.paramifiers = {};

config.paramifiers.start = {
    oninit: function(v) {
        safeMode = v.toLowerCase() == "safe";
    }
};

config.paramifiers.open = {
    onstart: function(v) {
        story.displayTiddler("bottom",v,null,false,null);
    }
};

config.paramifiers.story = {
    onstart: function(v) {
        var list = store.getTiddlerText(v,"").parseParams("open",null,false);
        invokeParamifier(list,"onstart");
    }
};

config.paramifiers.search = {
    onstart: function(v) {
        story.search(v,false,false);
    }
};

config.paramifiers.searchRegExp = {
    onstart: function(v) {
        story.prototype.search(v,false,true);
    }
};

config.paramifiers.tag = {
    onstart: function(v) {
        var tagged = store.getTaggedTiddlers(v,"title");
        for(var t=0; t<tagged.length; t++)
            story.displayTiddler("bottom",tagged[t].title,null,false,null);
    }
};

config.paramifiers.newTiddler = {
    onstart: function(v) {
        if(!readOnly) {
            story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
            story.focusTiddler(v,"text");
        }
    }
};

config.paramifiers.newJournal = {
    onstart: function(v) {
        if(!readOnly) {
            var now = new Date();
            var title = now.formatString(v.trim());
            story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
            story.focusTiddler(title,"text");
        }
    }
};

config.paramifiers.readOnly = {
    onconfig: function(v) {
        var p = v.toLowerCase();
        readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
    }
};

//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
    this.formatters = [];
    var pattern = [];
    for(var n=0; n<formatters.length; n++) {
        pattern.push("(" + formatters[n].match + ")");
        this.formatters.push(formatters[n]);
    }
    this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

    createElementAndWikify: function(w)
    {
        w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
    },

    inlineCssHelper: function(w)
    {
        var styles = [];
        config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
        var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
        while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
            var s,v;
            if(lookaheadMatch[1]) {
                s = lookaheadMatch[1].unDash();
                v = lookaheadMatch[2];
            } else {
                s = lookaheadMatch[3].unDash();
                v = lookaheadMatch[4];
            }
            if (s=="bgcolor")
                s = "backgroundColor";
            styles.push({style: s, value: v});
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
            config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
            lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
        }
        return styles;
    },

    applyCssHelper: function(e,styles)
    {
        for(var t=0; t< styles.length; t++) {
            try {
                e.style[styles[t].style] = styles[t].value;
            } catch (ex) {
            }
        }
    },

    enclosedTextHelper: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var text = lookaheadMatch[1];
            if(config.browser.isIE)
                text = text.replace(/\n/g,"\r");
            createTiddlyElement(w.output,this.element,null,null,text);
            w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
        }
    },

    isExternalLink: function(link)
    {
        if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
            return false;
        }
        var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
        if(urlRegExp.exec(link)) {
            return true;
        }
        if (link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1){
            return true;
        }
        return false;
    }

};

//--
//-- Standard formatters
//--

config.formatters = [
{
    name: "table",
    match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
    lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
    rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
    cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
    cellTermRegExp: /((?:\x20*)\|)/mg,
    rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},

    handler: function(w)
    {
        var table = createTiddlyElement(w.output,"table");
        var prevColumns = [];
        var currRowType = null;
        var rowContainer;
        var rowCount = 0;
        w.nextMatch = w.matchStart;
        this.lookaheadRegExp.lastIndex = w.nextMatch;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
            var nextRowType = lookaheadMatch[2];
            if(nextRowType == "k") {
                table.className = lookaheadMatch[1];
                w.nextMatch += lookaheadMatch[0].length+1;
            } else {
                if(nextRowType != currRowType) {
                    rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
                    currRowType = nextRowType;
                }
                if(currRowType == "c") {
                    // Caption
                    w.nextMatch++;
                    if(rowContainer != table.firstChild)
                        table.insertBefore(rowContainer,table.firstChild);
                    rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
                    w.subWikifyTerm(rowContainer,this.rowTermRegExp);
                } else {
                    this.rowHandler(w,createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow"),prevColumns);
                    rowCount++;
                }
            }
            this.lookaheadRegExp.lastIndex = w.nextMatch;
            lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        }
    },
    rowHandler: function(w,e,prevColumns)
    {
        var col = 0;
        var colSpanCount = 1;
        var prevCell = null;
        this.cellRegExp.lastIndex = w.nextMatch;
        var cellMatch = this.cellRegExp.exec(w.source);
        while(cellMatch && cellMatch.index == w.nextMatch) {
            if(cellMatch[1] == "~") {
                // Rowspan
                var last = prevColumns[col];
                if(last) {
                    last.rowSpanCount++;
                    last.element.setAttribute("rowspan",last.rowSpanCount);
                    last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
                    last.element.valign = "center";
                }
                w.nextMatch = this.cellRegExp.lastIndex-1;
            } else if(cellMatch[1] == ">") {
                // Colspan
                colSpanCount++;
                w.nextMatch = this.cellRegExp.lastIndex-1;
            } else if(cellMatch[2]) {
                // End of row
                if(prevCell && colSpanCount > 1) {
                    prevCell.setAttribute("colspan",colSpanCount);
                    prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
                }
                w.nextMatch = this.cellRegExp.lastIndex;
                break;
            } else {
                // Cell
                w.nextMatch++;
                var styles = config.formatterHelpers.inlineCssHelper(w);
                var spaceLeft = false;
                var chr = w.source.substr(w.nextMatch,1);
                while(chr == " ") {
                    spaceLeft = true;
                    w.nextMatch++;
                    chr = w.source.substr(w.nextMatch,1);
                }
                var cell;
                if(chr == "!") {
                    cell = createTiddlyElement(e,"th");
                    w.nextMatch++;
                } else {
                    cell = createTiddlyElement(e,"td");
                }
                prevCell = cell;
                prevColumns[col] = {rowSpanCount:1,element:cell};
                if(colSpanCount > 1) {
                    cell.setAttribute("colspan",colSpanCount);
                    cell.setAttribute("colSpan",colSpanCount); // Needed for IE
                    colSpanCount = 1;
                }
                config.formatterHelpers.applyCssHelper(cell,styles);
                w.subWikifyTerm(cell,this.cellTermRegExp);
                if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
                    cell.align = spaceLeft ? "center" : "left";
                else if(spaceLeft)
                    cell.align = "right";
                w.nextMatch--;
            }
            col++;
            this.cellRegExp.lastIndex = w.nextMatch;
            cellMatch = this.cellRegExp.exec(w.source);
        }
    }
},

{
    name: "heading",
    match: "^!{1,6}",
    termRegExp: /(\n)/mg,
    handler: function(w)
    {
        w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
    }
},

{
    name: "list",
    match: "^(?:[\\*#;:]+)",
    lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
    termRegExp: /(\n)/mg,
    handler: function(w)
    {
        var stack = [w.output];
        var currLevel = 0, currType = null;
        var listLevel, listType, itemType;
        w.nextMatch = w.matchStart;
        this.lookaheadRegExp.lastIndex = w.nextMatch;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
            if(lookaheadMatch[1]) {
                listType = "ul";
                itemType = "li";
            } else if(lookaheadMatch[2]) {
                listType = "ol";
                itemType = "li";
            } else if(lookaheadMatch[3]) {
                listType = "dl";
                itemType = "dt";
            } else if(lookaheadMatch[4]) {
                listType = "dl";
                itemType = "dd";
            }
            listLevel = lookaheadMatch[0].length;
            w.nextMatch += lookaheadMatch[0].length;
            var t;
            if(listLevel > currLevel) {
                for(t=currLevel; t<listLevel; t++)
                    stack.push(createTiddlyElement(stack[stack.length-1],listType));
            } else if(listLevel < currLevel) {
                for(t=currLevel; t>listLevel; t--)
                    stack.pop();
            } else if(listLevel == currLevel && listType != currType) {
                stack.pop();
                stack.push(createTiddlyElement(stack[stack.length-1],listType));
            }
            currLevel = listLevel;
            currType = listType;
            var e = createTiddlyElement(stack[stack.length-1],itemType);
            w.subWikifyTerm(e,this.termRegExp);
            this.lookaheadRegExp.lastIndex = w.nextMatch;
            lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        }
    }
},

{
    name: "quoteByBlock",
    match: "^<<<\\n",
    termRegExp: /(^<<<(\n|$))/mg,
    element: "blockquote",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "quoteByLine",
    match: "^>+",
    lookaheadRegExp: /^>+/mg,
    termRegExp: /(\n)/mg,
    element: "blockquote",
    handler: function(w)
    {
        var stack = [w.output];
        var currLevel = 0;
        var newLevel = w.matchLength;
        var t;
        do {
            if(newLevel > currLevel) {
                for(t=currLevel; t<newLevel; t++)
                    stack.push(createTiddlyElement(stack[stack.length-1],this.element));
            } else if(newLevel < currLevel) {
                for(t=currLevel; t>newLevel; t--)
                    stack.pop();
            }
            currLevel = newLevel;
            w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
            createTiddlyElement(stack[stack.length-1],"br");
            this.lookaheadRegExp.lastIndex = w.nextMatch;
            var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
            var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
            if(matched) {
                newLevel = lookaheadMatch[0].length;
                w.nextMatch += lookaheadMatch[0].length;
            }
        } while(matched);
    }
},

{
    name: "rule",
    match: "^----+$\\n?",
    handler: function(w)
    {
        createTiddlyElement(w.output,"hr");
    }
},

{
    name: "monospacedByLine",
    match: "^\\{\\{\\{\\n",
    lookaheadRegExp: /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg,
    element: "pre",
    handler: config.formatterHelpers.enclosedTextHelper
},

{
    name: "monospacedByLineForCSS",
    match: "^/\\*\\{\\{\\{\\*/\\n",
    lookaheadRegExp: /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*\}\}\}\*\/$\n?)/mg,
    element: "pre",
    handler: config.formatterHelpers.enclosedTextHelper
},

{
    name: "monospacedByLineForPlugin",
    match: "^//\\{\\{\\{\\n",
    lookaheadRegExp: /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg,
    element: "pre",
    handler: config.formatterHelpers.enclosedTextHelper
},

{
    name: "monospacedByLineForTemplate",
    match: "^<!--\\{\\{\\{-->\\n",
    lookaheadRegExp: /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^<!--\}\}\}-->$\n?)/mg,
    element: "pre",
    handler: config.formatterHelpers.enclosedTextHelper
},

{
    name: "wikifyCommentForPlugin",
    match: "^/\\*\\*\\*\\n",
    termRegExp: /(^\*\*\*\/\n)/mg,
    handler: function(w)
    {
        w.subWikifyTerm(w.output,this.termRegExp);
    }
},

{
    name: "wikifyCommentForTemplate",
    match: "^<!---\\n",
    termRegExp: /(^--->\n)/mg,
    handler: function(w)
    {
        w.subWikifyTerm(w.output,this.termRegExp);
    }
},

{
    name: "macro",
    match: "<<",
    lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
            w.nextMatch = this.lookaheadRegExp.lastIndex;
            invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
        }
    }
},

{
    name: "prettyLink",
    match: "\\[\\[",
    lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var e;
            var text = lookaheadMatch[1];
            if(lookaheadMatch[3]) {
                // Pretty bracketted link
                var link = lookaheadMatch[3];
                e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
                        createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
            } else {
                // Simple bracketted link
                e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
            }
            createTiddlyText(e,text);
            w.nextMatch = this.lookaheadRegExp.lastIndex;
        }
    }
},

{
    name: "unWikiLink",
    match: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,
    handler: function(w)
    {
        w.outputText(w.output,w.matchStart+1,w.nextMatch);
    }
},

{
    name: "wikiLink",
    match: config.textPrimitives.wikiLink,
    handler: function(w)
    {
        if(w.matchStart > 0) {
            var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
            preRegExp.lastIndex = w.matchStart-1;
            var preMatch = preRegExp.exec(w.source);
            if(preMatch.index == w.matchStart-1) {
                w.outputText(w.output,w.matchStart,w.nextMatch);
                return;
            }
        }
        if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {
            var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
            w.outputText(link,w.matchStart,w.nextMatch);
        } else {
            w.outputText(w.output,w.matchStart,w.nextMatch);
        }
    }
},

{
    name: "urlLink",
    match: config.textPrimitives.urlPattern,
    handler: function(w)
    {
        w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
    }
},

{
    name: "image",
    match: "\\[[<>]?[Ii][Mm][Gg]\\[",
    lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            var e = w.output;
            if(lookaheadMatch[5]) {
                var link = lookaheadMatch[5];
                e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
                addClass(e,"imageLink");
            }
            var img = createTiddlyElement(e,"img");
            if(lookaheadMatch[1])
                img.align = "left";
            else if(lookaheadMatch[2])
                img.align = "right";
            if(lookaheadMatch[3])
                img.title = lookaheadMatch[3];
            img.src = lookaheadMatch[4];
            w.nextMatch = this.lookaheadRegExp.lastIndex;
        }
    }
},

{
    name: "html",
    match: "<[Hh][Tt][Mm][Ll]>",
    lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
            w.nextMatch = this.lookaheadRegExp.lastIndex;
        }
    }
},

{
    name: "commentByBlock",
    match: "/%",
    lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
            w.nextMatch = this.lookaheadRegExp.lastIndex;
    }
},

{
    name: "boldByChar",
    match: "''",
    termRegExp: /('')/mg,
    element: "strong",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "italicByChar",
    match: "//",
    termRegExp: /(\/\/)/mg,
    element: "em",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "underlineByChar",
    match: "__",
    termRegExp: /(__)/mg,
    element: "u",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "strikeByChar",
    match: "--(?!\\s|$)",
    termRegExp: /((?!\s)--|(?=\n\n))/mg,
    element: "strike",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "superscriptByChar",
    match: "\\^\\^",
    termRegExp: /(\^\^)/mg,
    element: "sup",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "subscriptByChar",
    match: "~~",
    termRegExp: /(~~)/mg,
    element: "sub",
    handler: config.formatterHelpers.createElementAndWikify
},

{
    name: "monospacedByChar",
    match: "\\{\\{\\{",
    lookaheadRegExp: /\{\{\{((?:.|\n)*?)\}\}\}/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
            w.nextMatch = this.lookaheadRegExp.lastIndex;
        }
    }
},

{
    name: "styleByChar",
    match: "@@",
    termRegExp: /(@@)/mg,
    handler: function(w)
    {
        var e = createTiddlyElement(w.output,"span");
        var styles = config.formatterHelpers.inlineCssHelper(w);
        if(styles.length == 0)
            e.className = "marked";
        else
            config.formatterHelpers.applyCssHelper(e,styles);
        w.subWikifyTerm(e,this.termRegExp);
    }
},

{
    name: "lineBreak",
    match: "\\n|<br ?/?>",
    handler: function(w)
    {
        createTiddlyElement(w.output,"br");
    }
},

{
    name: "rawText",
    match: "\\\"{3}|<nowiki>",
    lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
            createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
            w.nextMatch = this.lookaheadRegExp.lastIndex;
        }
    }
},

{
    name: "mdash",
    match: "--",
    handler: function(w)
    {
        createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
    }
},

{
    name: "htmlEntitiesEncoding",
    match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
    handler: function(w)
    {
        createTiddlyElement(w.output,"span").innerHTML = w.matchText;
    }
},

{
    name: "customClasses",
    match: "\\{\\{",
    termRegExp: /(\}\}\})/mg,
    lookaheadRegExp: /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg,
    handler: function(w)
    {
        this.lookaheadRegExp.lastIndex = w.matchStart;
        var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
        if(lookaheadMatch) {
            var e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
            w.nextMatch = this.lookaheadRegExp.lastIndex;
            w.subWikifyTerm(e,this.termRegExp);
        }
    }
}

];

//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
    if(tiddler) {
        if(!format)
            format = tiddler.fields["wikiformat"];
        if(format) {
            for(var i in config.parsers) {
                if(format == config.parsers[i].format)
                    return config.parsers[i];
            }
        } else {
            for(var i in config.parsers) {
                if(tiddler.isTagged(config.parsers[i].formatTag))
                    return config.parsers[i];
            }
        }
    }
    return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
    if(source && source != "") {
        var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
        wikifier.subWikifyUnterm(output);
    }
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
    var e = createTiddlyElement(document.body,"div");
    e.style.display = "none";
    var html = "";
    if(source && source != "") {
        var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
        wikifier.isStatic = true;
        wikifier.subWikifyUnterm(e);
        html = e.innerHTML;
        removeNode(e);
    }
    return html;
}

function wikifyPlain(title,theStore,limit)
{
    if(!theStore)
        theStore = store;
    if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
        return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
    } else {
        return "";
    }
}

function wikifyPlainText(text,limit,tiddler)
{
    if(limit > 0)
        text = text.substr(0,limit);
    var wikifier = new Wikifier(text,formatter,null,tiddler);
    return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
    if(source && source != "") {
        var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
        wikifier.outputText(output,0,source.length);
    }
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
    this.source = source;
    this.output = null;
    this.formatter = formatter;
    this.nextMatch = 0;
    this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
    this.highlightRegExp = highlightRegExp;
    this.highlightMatch = null;
    this.isStatic = false;
    if(highlightRegExp) {
        highlightRegExp.lastIndex = 0;
        this.highlightMatch = highlightRegExp.exec(source);
    }
    this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
    var e = createTiddlyElement(document.body,"div");
    this.subWikify(e);
    var text = getPlainText(e);
    removeNode(e);
    return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
    if(terminator)
        this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
    else
        this.subWikifyUnterm(output);
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
    // subWikify() can be indirectly recursive, so we need to save the old output pointer
    var oldOutput = this.output;
    this.output = output;
    this.formatter.formatterRegExp.lastIndex = this.nextMatch;
    var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
    while(formatterMatch) {
        // Output any text before the match
        if(formatterMatch.index > this.nextMatch)
            this.outputText(this.output,this.nextMatch,formatterMatch.index);
        // Set the match parameters for the handler
        this.matchStart = formatterMatch.index;
        this.matchLength = formatterMatch[0].length;
        this.matchText = formatterMatch[0];
        this.nextMatch = this.formatter.formatterRegExp.lastIndex;
        for(var t=1; t<formatterMatch.length; t++) {
            if(formatterMatch[t]) {
                this.formatter.formatters[t-1].handler(this);
                this.formatter.formatterRegExp.lastIndex = this.nextMatch;
                break;
            }
        }
        formatterMatch = this.formatter.formatterRegExp.exec(this.source);
    }
    if(this.nextMatch < this.source.length) {
        this.outputText(this.output,this.nextMatch,this.source.length);
        this.nextMatch = this.source.length;
    }
    this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
    // subWikify() can be indirectly recursive, so we need to save the old output pointer
    var oldOutput = this.output;
    this.output = output;
    // Get the first matches for the formatter and terminator RegExps
    terminatorRegExp.lastIndex = this.nextMatch;
    var terminatorMatch = terminatorRegExp.exec(this.source);
    this.formatter.formatterRegExp.lastIndex = this.nextMatch;
    var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
    while(terminatorMatch || formatterMatch) {
        if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
            if(terminatorMatch.index > this.nextMatch)
                this.outputText(this.output,this.nextMatch,terminatorMatch.index);
            this.matchText = terminatorMatch[1];
            this.matchLength = terminatorMatch[1].length;
            this.matchStart = terminatorMatch.index;
            this.nextMatch = this.matchStart + this.matchLength;
            this.output = oldOutput;
            return;
        }
        if(formatterMatch.index > this.nextMatch)
            this.outputText(this.output,this.nextMatch,formatterMatch.index);
        this.matchStart = formatterMatch.index;
        this.matchLength = formatterMatch[0].length;
        this.matchText = formatterMatch[0];
        this.nextMatch = this.formatter.formatterRegExp.lastIndex;
        for(var t=1; t<formatterMatch.length; t++) {
            if(formatterMatch[t]) {
                this.formatter.formatters[t-1].handler(this);
                this.formatter.formatterRegExp.lastIndex = this.nextMatch;
                break;
            }
        }
        terminatorRegExp.lastIndex = this.nextMatch;
        terminatorMatch = terminatorRegExp.exec(this.source);
        formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
    }
    if(this.nextMatch < this.source.length) {
        this.outputText(this.output,this.nextMatch,this.source.length);
        this.nextMatch = this.source.length;
    }
    this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
    while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
        if(this.highlightMatch.index > startPos) {
            createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
            startPos = this.highlightMatch.index;
        }
        var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
        var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
        startPos = highlightEnd;
        if(startPos >= this.highlightRegExp.lastIndex)
            this.highlightMatch = this.highlightRegExp.exec(this.source);
    }
    if(startPos < endPos) {
        createTiddlyText(place,this.source.substring(startPos,endPos));
    }
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
    var now = new Date();
    var text;
    if(params[0])
        text = now.formatString(params[0].trim());
    else
        text = now.toLocaleString();
    createTiddlyElement(place,"span",null,null,text);
};

config.macros.version.handler = function(place)
{
    createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
};

config.macros.list.handler = function(place,macroName,params)
{
    var type = params[0] ? params[0] : "all";
    var list = document.createElement("ul");
    place.appendChild(list);
    if(this[type].prompt)
        createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
    var results;
    if(this[type].handler)
        results = this[type].handler(params);
    for(var t = 0; t < results.length; t++) {
        var li = document.createElement("li");
        list.appendChild(li);
        createTiddlyLink(li,typeof results[t] == "string" ? results[t] : results[t].title,true);
    }
};

config.macros.list.all.handler = function(params)
{
    return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
    return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
    return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
    return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
    return store.getTouched();
};

config.macros.allTags.handler = function(place,macroName,params)
{
    var tags = store.getTags(params[0]);
    var ul = createTiddlyElement(place,"ul");
    if(tags.length == 0)
        createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
    for(var t=0; t<tags.length; t++) {
        var title = tags[t][0];
        var info = getTiddlyLinkInfo(title);
        var li =createTiddlyElement(ul,"li");
        var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
        btn.setAttribute("tag",title);
        btn.setAttribute("refresh","link");
        btn.setAttribute("tiddlyLink",title);
    }
};

config.macros.timeline.handler = function(place,macroName,params)
{
    var field = params[0] ? params[0] : "modified";
    var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
    var lastDay = "";
    var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
    for(var t=tiddlers.length-1; t>=last; t--) {
        var tiddler = tiddlers[t];
        var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
        if(theDay != lastDay) {
            var theDateList = document.createElement("ul");
            place.appendChild(theDateList);
            createTiddlyElement(theDateList,"li",null,"listTitle",tiddler[field].formatString(this.dateFormat));
            lastDay = theDay;
        }
        var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink");
        theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
    }
};

config.macros.search.handler = function(place,macroName,params)
{
    var searchTimeout = null;
    var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);
    var txt = createTiddlyElement(place,"input",null,"txtOptionInput");
    if(params[0])
        txt.value = params[0];
    txt.onkeyup = this.onKeyPress;
    txt.onfocus = this.onFocus;
    txt.setAttribute("size",this.sizeTextbox);
    txt.setAttribute("accessKey",this.accessKey);
    txt.setAttribute("autocomplete","off");
    txt.setAttribute("lastSearchText","");
    if(config.browser.isSafari) {
        txt.setAttribute("type","search");
        txt.setAttribute("results","5");
    } else {
        txt.setAttribute("type","text");
    }
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
    if(txt.value.length > 0) {
        story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
        txt.setAttribute("lastSearchText",txt.value);
    }
};

config.macros.search.onClick = function(e)
{
    config.macros.search.doSearch(this.nextSibling);
    return false;
};

config.macros.search.onKeyPress = function(e)
{
    if(!e) var e = window.event;
    switch(e.keyCode) {
        case 13: // Ctrl-Enter
        case 10: // Ctrl-Enter on IE PC
            config.macros.search.doSearch(this);
            break;
        case 27: // Escape
            this.value = "";
            clearMessage();
            break;
    }
    if(this.value.length > 2) {
        if(this.value != this.getAttribute("lastSearchText")) {
            if(config.macros.search.timeout)
                clearTimeout(config.macros.search.timeout);
            var txt = this;
            config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
        }
    } else {
        if(config.macros.search.timeout)
            clearTimeout(config.macros.search.timeout);
    }
};

config.macros.search.onFocus = function(e)
{
    this.select();
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    params = paramString.parseParams("name",null,true,false,true);
    var names = params[0]["name"];
    var tiddlerName = names[0];
    var className = names[1] ? names[1] : null;
    var args = params[0]["with"];
    var wrapper = createTiddlyElement(place,"span",null,className);
    if(!args) {
        wrapper.setAttribute("refresh","content");
        wrapper.setAttribute("tiddler",tiddlerName);
    }
    var text = store.getTiddlerText(tiddlerName);
    if(text) {
        var stack = config.macros.tiddler.tiddlerStack;
        if(stack.indexOf(tiddlerName) !== -1)
            return;
        stack.push(tiddlerName);
        try {
            var n = args ? Math.min(args.length,9) : 0;
            for(var i=0; i<n; i++) {
                var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
                text = text.replace(placeholderRE,args[i]);
            }
            config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
        } finally {
            stack.pop();
        }
    }
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params)
{
    wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
    createTagButton(place,params[0]);
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    params = paramString.parseParams("anon",null,true,false,false);
    var theList = createTiddlyElement(place,"ul");
    var title = getParam(params,"anon","");
    if(title && store.tiddlerExists(title))
        tiddler = store.getTiddler(title);
    var sep = getParam(params,"sep"," ");
    var lingo = config.views.wikified.tag;
    var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
    createTiddlyElement(theList,"li",null,"listTitle",prompt.format([tiddler.title]));
    for(var t=0; t<tiddler.tags.length; t++) {
        createTagButton(createTiddlyElement(theList,"li"),tiddler.tags[t],tiddler.title);
        if(t<tiddler.tags.length-1)
            createTiddlyText(theList,sep);
    }
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    params = paramString.parseParams("anon",null,true,false,false);
    var theList = createTiddlyElement(place,"ul");
    var title = getParam(params,"anon","");
    if(title == "" && tiddler instanceof Tiddler)
        title = tiddler.title;
    var sep = getParam(params,"sep"," ");
    theList.setAttribute("title",this.tooltip.format([title]));
    var tagged = store.getTaggedTiddlers(title);
    var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
    createTiddlyElement(theList,"li",null,"listTitle",prompt.format([title,tagged.length]));
    for(var t=0; t<tagged.length; t++) {
        createTiddlyLink(createTiddlyElement(theList,"li"),tagged[t].title,true);
        if(t<tagged.length-1)
            createTiddlyText(theList,sep);
    }
};

config.macros.closeAll.handler = function(place)
{
    createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
    story.closeAllTiddlers();
    return false;
};

config.macros.permaview.handler = function(place)
{
    createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
    story.permaView();
    return false;
};

config.macros.saveChanges.handler = function(place)
{
    if(!readOnly)
        createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
    saveChanges();
    return false;
};

config.macros.slider.onClickSlider = function(e)
{
    if(!e) var e = window.event;
    var n = this.nextSibling;
    var cookie = n.getAttribute("cookie");
    var isOpen = n.style.display != "none";
    if(config.options.chkAnimate && anim && typeof Slider == "function")
        anim.startAnimating(new Slider(n,!isOpen,null,"none"));
    else
        n.style.display = isOpen ? "none" : "block";
    config.options[cookie] = !isOpen;
    saveOptionCookie(cookie);
    return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
    var cookie = cookie ? cookie : "";
    var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
    var panel = createTiddlyElement(null,"div",null,"sliderPanel");
    panel.setAttribute("cookie",cookie);
    panel.style.display = config.options[cookie] ? "block" : "none";
    place.appendChild(panel);
    return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
    var panel = this.createSlider(place,params[0],params[2],params[3]);
    var text = store.getTiddlerText(params[1]);
    panel.setAttribute("refresh","content");
    panel.setAttribute("tiddler",params[1]);
    if(text)
        wikify(text,panel,null,store.getTiddler(params[1]));
};

config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
    var typeInfo = config.macros.option.types[type];
    var c = document.createElement(typeInfo.elementType);
    if(typeInfo.typeValue)
        c.setAttribute("type",typeInfo.typeValue);
    c[typeInfo.eventName] = typeInfo.onChange;
    c.setAttribute("option",opt);
    if(className)
        c.className = className;
    else
        c.className = typeInfo.className;
    if(config.optionsDesc[opt])
        c.setAttribute("title",config.optionsDesc[opt]);
    place.appendChild(c);
    if(desc != "no")
        createTiddlyText(place,config.optionsDesc[opt] ? config.optionsDesc[opt] : opt);
    c[typeInfo.valueField] = config.options[opt];
    return c;
};

config.macros.option.genericOnChange = function(e)
{
    var opt = this.getAttribute("option");
    if(opt) {
        var optType = opt.substr(0,3);
        var handler = config.macros.option.types[optType];
        if (handler.elementType && handler.valueField)
            config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType);
        }
    return true;
};

config.macros.option.types = {
    'txt': {
        elementType: "input",
        valueField: "value",
        eventName: "onkeyup",
        className: "txtOptionInput",
        create: config.macros.option.genericCreate,
        onChange: config.macros.option.genericOnChange
    },
    'chk': {
        elementType: "input",
        valueField: "checked",
        eventName: "onclick",
        className: "chkOptionInput",
        typeValue: "checkbox",
        create: config.macros.option.genericCreate,
        onChange: config.macros.option.genericOnChange
    }
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType)
{
    config.options[opt] = value;
    saveOptionCookie(opt);
    var nodes = document.getElementsByTagName(elementType);
    for(var t=0; t<nodes.length; t++) {
        var optNode = nodes[t].getAttribute("option");
        if(opt == optNode)
            nodes[t][valueField] = value;
        }
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    params = paramString.parseParams("anon",null,true,false,false);
    var opt = (params[1] && params[1].name == "anon") ? params[1].value : getParam(params,"name",null);
    var className = (params[2] && params[2].name == "anon") ? params[2].value : getParam(params,"class",null);
    var desc = getParam(params,"desc","no");
    var type = opt.substr(0,3);
    var h = config.macros.option.types[type];
    if (h && h.create)
        h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    params = paramString.parseParams("anon",null,true,false,false);
    var showUnknown = getParam(params,"showUnknown","no");
    var wizard = new Wizard();
    wizard.createWizard(place,this.wizardTitle);
    wizard.addStep(this.step1Title,this.step1Html);
    var markList = wizard.getElement("markList");
    var chkUnknown = wizard.getElement("chkUnknown");
    chkUnknown.checked = showUnknown == "yes";
    chkUnknown.onchange = this.onChangeUnknown;
    var listWrapper = document.createElement("div");
    markList.parentNode.insertBefore(listWrapper,markList);
    wizard.setValue("listWrapper",listWrapper);
    this.refreshOptions(listWrapper,showUnknown == "yes");
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
    var opts = [];
    for(var n in config.options) {
        var opt = {};
        opt.option = "";
        opt.name = n;
        opt.lowlight = !config.optionsDesc[n];
        opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
        if(!opt.lowlight || showUnknown)
            opts.push(opt);
    }
    opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
    var listview = ListView.create(listWrapper,opts,this.listViewTemplate);
    for(n=0; n<opts.length; n++) {
        var type = opts[n].name.substr(0,3);
        var h = config.macros.option.types[type];
        if (h && h.create) {
            h.create(opts[n].colElements['option'],type,opts[n].name,null,"no");
        }
    }
};

config.macros.options.onChangeUnknown = function(e)
{
    var wizard = new Wizard(this);
    var listWrapper = wizard.getValue("listWrapper");
    removeChildren(listWrapper);
    config.macros.options.refreshOptions(listWrapper,this.checked);
    return false;
};

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
    var tags = [];
    for(var t=1; t<params.length; t++) {
        if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
            tags.push(params[t].value);
    }
    label = getParam(params,"label",label);
    prompt = getParam(params,"prompt",prompt);
    accessKey = getParam(params,"accessKey",accessKey);
    newFocus = getParam(params,"focus",newFocus);
    var customFields = getParam(params,"fields");
    if(!customFields && !store.isShadowTiddler(title))
        customFields = String.encodeHashMap(config.defaultCustomFields);
    var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
    btn.setAttribute("newTitle",title);
    btn.setAttribute("isJournal",isJournal ? "true" : "false");
    btn.setAttribute("params",tags.join("|"));
    btn.setAttribute("newFocus",newFocus);
    btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
    btn.setAttribute("customFields",customFields);
    var text = getParam(params,"text");
    if(text !== undefined)
        btn.setAttribute("newText",text);
    return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
    var title = this.getAttribute("newTitle");
    if(this.getAttribute("isJournal") == "true") {
        var now = new Date();
        title = now.formatString(title.trim());
    }
    var params = this.getAttribute("params").split("|");
    var focus = this.getAttribute("newFocus");
    var template = this.getAttribute("newTemplate");
    var customFields = this.getAttribute("customFields");
    story.displayTiddler(null,title,template,false,null,customFields);
    var text = this.getAttribute("newText");
    if(typeof text == "string")
        story.getTiddlerField(title,"text").value = text.format([title]);
    for(var t=0;t<params.length;t++)
        story.setTiddlerTag(title,params[t],+1);
    story.focusTiddler(title,focus);
    return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if(!readOnly) {
        params = paramString.parseParams("anon",null,true,false,false);
        var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
        title = getParam(params,"title",title);
        this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
    }
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if(!readOnly) {
        params = paramString.parseParams("anon",null,true,false,false);
        var title = params[1] && params[1].name == "anon" ? params[1].value : "";
        title = getParam(params,"title",title);
        config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
    }
};

config.macros.sparkline.handler = function(place,macroName,params)
{
    var data = [];
    var min = 0;
    var max = 0;
    for(var t=0; t<params.length; t++) {
        var v = parseInt(params[t]);
        if(v < min)
            min = v;
        if(v > max)
            max = v;
        data.push(v);
    }
    if(data.length < 1)
        return;
    var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
    box.title = data.join(",");
    var w = box.offsetWidth;
    var h = box.offsetHeight;
    box.style.paddingRight = (data.length * 2 - w) + "px";
    box.style.position = "relative";
    for(var d=0; d<data.length; d++) {
        var tick = document.createElement("img");
        tick.border = 0;
        tick.className = "sparktick";
        tick.style.position = "absolute";
        tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
        tick.style.left = d*2 + "px";
        tick.style.width = "2px";
        var v = Math.floor(((data[d] - min)/(max-min)) * h);
        tick.style.top = (h-v) + "px";
        tick.style.height = v + "px";
        box.appendChild(tick);
    }
};

config.macros.tabs.handler = function(place,macroName,params)
{
    var cookie = params[0];
    var numTabs = (params.length-1)/3;
    var wrapper = createTiddlyElement(null,"div",null,cookie);
    var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
    tabset.setAttribute("cookie",cookie);
    var validTab = false;
    for(var t=0; t<numTabs; t++) {
        var label = params[t*3+1];
        var prompt = params[t*3+2];
        var content = params[t*3+3];
        var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
        tab.setAttribute("tab",label);
        tab.setAttribute("content",content);
        tab.title = prompt;
        if(config.options[cookie] == label)
            validTab = true;
    }
    if(!validTab)
        config.options[cookie] = params[1];
    place.appendChild(wrapper);
    this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
    config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
    return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
    var cookie = tabset.getAttribute("cookie");
    var theTab = null;
    var nodes = tabset.childNodes;
    for(var t=0; t<nodes.length; t++) {
        if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
            theTab = nodes[t];
            theTab.className = "tab tabSelected";
        } else {
            nodes[t].className = "tab tabUnselected";
        }
    }
    if(theTab) {
        if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
            removeNode(tabset.nextSibling);
        var tabContent = createTiddlyElement(null,"div",null,"tabContents");
        tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
        var contentTitle = theTab.getAttribute("content");
        wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
        if(cookie) {
            config.options[cookie] = tab;
            saveOptionCookie(cookie);
        }
    }
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier)
{
    var terminator = ">>";
    var panel;
    if(wikifier)
        panel = createTiddlyElement(place,"div",null,"gradient");
    else
        panel = place;
    panel.style.position = "relative";
    panel.style.overflow = "hidden";
    panel.style.zIndex = "0";
    var t;
    if(wikifier) {
        var styles = config.formatterHelpers.inlineCssHelper(wikifier);
        config.formatterHelpers.applyCssHelper(panel,styles);
    }
    var colours = [];
    for(t=1; t<params.length; t++) {
        var c = new RGB(params[t]);
        if(c)
            colours.push(c);
    }
    drawGradient(panel,params[0] != "vert",colours);
    if(wikifier)
        wikifier.subWikify(panel,terminator);
    if(document.all) {
        panel.style.height = "100%";
        panel.style.width = "100%";
    }
};

config.macros.message.handler = function(place,macroName,params)
{
    if(params[0]) {
        var m = config;
        var p = params[0].split(".");
        for(var t=0; t<p.length; t++) {
            if(p[t] in m)
                m = m[p[t]];
            else
                break;
        }
        createTiddlyText(place,m.toString().format(params.splice(1)));
    }
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if((tiddler instanceof Tiddler) && params[0]) {
        var value = store.getValue(tiddler,params[0]);
        if(value != undefined) {
            switch(params[1]) {
                case undefined:
                    highlightify(value,place,highlightHack,tiddler);
                    break;
                case "link":
                    createTiddlyLink(place,value,true);
                    break;
                case "wikified":
                    wikify(value,place,highlightHack,tiddler);
                    break;
                case "date":
                    value = Date.convertFromYYYYMMDDHHMM(value);
                    createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
                    break;
            }
        }
    }
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    var field = params[0];
    var rows = params[1];
    if((tiddler instanceof Tiddler) && field) {
        story.setDirty(tiddler.title,true);
        if(field != "text" && !rows) {
            var e = createTiddlyElement(null,"input");
            if(tiddler.isReadOnly())
                e.setAttribute("readOnly","readOnly");
            e.setAttribute("edit",field);
            e.setAttribute("type","text");
            var v = store.getValue(tiddler,field);
            if(!v)
                v = "";
            e.value = v;
            e.setAttribute("size","40");
            e.setAttribute("autocomplete","off");
            place.appendChild(e);
        } else {
            var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
            var wrapper2 = createTiddlyElement(wrapper1,"div");
            var e = createTiddlyElement(wrapper2,"textarea");
            if(tiddler.isReadOnly())
                e.setAttribute("readOnly","readOnly");
            var v = store.getValue(tiddler,field);
            if(!v)
                v = "";
            e.value = v;
            var rows = rows ? rows : 10;
            var lines = v.match(/\n/mg);
            var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
            if(lines != null && lines.length > rows)
                rows = lines.length + 5;
            rows = Math.min(rows,maxLines);
            e.setAttribute("rows",rows);
            e.setAttribute("edit",field);
            place.appendChild(wrapper1);
        }
    }
};

config.macros.tagChooser.onClick = function(e)
{
    if(!e) var e = window.event;
    var lingo = config.views.editor.tagChooser;
    var popup = Popup.create(this);
    var tags = store.getTags();
    if(tags.length == 0)
        createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
    for(var t=0; t<tags.length; t++) {
        var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
        theTag.setAttribute("tag",tags[t][0]);
        theTag.setAttribute("tiddler",this.getAttribute("tiddler"));
    }
    Popup.show();
    e.cancelBubble = true;
    if(e.stopPropagation) e.stopPropagation();
    return false;
};

config.macros.tagChooser.onTagClick = function(e)
{
    if(!e) var e = window.event;
    var tag = this.getAttribute("tag");
    var title = this.getAttribute("tiddler");
    if(!readOnly)
        story.setTiddlerTag(title,tag,0);
    return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if(tiddler instanceof Tiddler) {
        var title = tiddler.title;
        var lingo = config.views.editor.tagChooser;
        var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
        btn.setAttribute("tiddler",title);
    }
};

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)
{
    if(typeof commandName != "string") {
        var c = null;
        for(var t in config.commands) {
            if(config.commands[t] == commandName)
                c = t;
        }
        commandName = c;
    }
    if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
        var command = config.commands[commandName];
        if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
            var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
            var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
            var cmd;
            switch(command.type) {
                case "popup":
                    cmd = this.onClickPopup;
                    break;
                case "command":
                default:
                    cmd = this.onClickCommand;
                    break;
            }
            var btn = createTiddlyButton(null,text,tooltip,cmd);
            btn.setAttribute("commandName",commandName);
            btn.setAttribute("tiddler",tiddler.title);
            if(theClass)
                addClass(btn,theClass);
            place.appendChild(btn);
        }
    }
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
    var title = tiddler.title;
    var ro = tiddler.isReadOnly();
    var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
    return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
    return tiddler.isReadOnly() && command.readOnlyText ? command.readOnlyText : command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
    return tiddler.isReadOnly() && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
};

config.macros.toolbar.onClickCommand = function(e)
{
    if(!e) var e = window.event;
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    var command = config.commands[this.getAttribute("commandName")];
    return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(e)
{
    if(!e) var e = window.event;
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    var popup = Popup.create(this);
    var command = config.commands[this.getAttribute("commandName")];
    var title = this.getAttribute("tiddler");
    var tiddler = store.fetchTiddler(title);
    popup.setAttribute("tiddler",title);
    command.handlePopup(popup,title);
    Popup.show();
    return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,theClass,event)
{
    var children = place.getElementsByTagName("a");
    for(var t=0; t<children.length; t++) {
        var c = children[t];
        if(hasClass(c,theClass) && c.getAttribute && c.getAttribute("commandName")) {
            if(c.onclick instanceof Function)
                c.onclick.call(c,event);
            break;
        }
    }
};

config.macros.toolbar.onClickMore = function(e)
{
    var e = this.nextSibling;
    e.style.display = "inline";
    removeNode(this);
    return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    for(var t=0; t<params.length; t++) {
        var c = params[t];
        switch(c) {
            case '>':
                var btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
                addClass(btn,"moreCommand");
                var e = createTiddlyElement(place,"span",null,"moreCommand");
                e.style.display = "none";
                place = e;
                break;
            default:
                var theClass = "";
                switch(c.substr(0,1)) {
                    case "+":
                        theClass = "defaultCommand";
                        c = c.substr(1);
                        break;
                    case "-":
                        theClass = "cancelCommand";
                        c = c.substr(1);
                        break;
                }
                if(c in config.commands)
                    this.createCommand(place,c,tiddler,theClass);
                break;
        }
    }
};

config.macros.refreshDisplay.handler = function(place)
{
    createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
    refreshAll();
    return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    var title = tiddler ? tiddler.title : null;
    var a = title ? config.annotations[title] : null;
    if(!tiddler || !title || !a)
        return;
    var text = a.format([title]);
    wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
    story.closeTiddler(title,true);
    return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
    story.closeAllTiddlers(title);
    return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
    clearMessage();
    var tiddlerElem = document.getElementById(story.idPrefix + title);
    var fields = tiddlerElem.getAttribute("tiddlyFields");
    story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
    story.focusTiddler(title,"text");
    return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
    var newTitle = story.saveTiddler(title,event.shiftKey);
    if(newTitle)
        story.displayTiddler(null,newTitle);
    return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
    if(story.hasChanges(title) && !readOnly) {
        if(!confirm(this.warning.format([title])))
            return false;
    }
    story.setDirty(title,false);
    story.displayTiddler(null,title);
    return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
    var deleteIt = true;
    if (config.options.chkConfirmDelete)
        deleteIt = confirm(this.warning.format([title]));
    if (deleteIt) {
        store.removeTiddler(title);
        story.closeTiddler(title,true);
        autoSaveChanges();
    }
    return false;
};

config.commands.permalink.handler = function(event,src,title)
{
    var t = encodeURIComponent(String.encodeTiddlyLink(title));
    if(window.location.hash != t)
        window.location.hash = t;
    return false;
};

config.commands.references.handlePopup = function(popup,title)
{
    var references = store.getReferringTiddlers(title);
    var c = false;
    for(var r=0; r<references.length; r++) {
        if(references[r].title != title && !references[r].isTagged("excludeLists")) {
            createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
            c = true;
        }
    }
    if(!c)
        createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
    story.forEachTiddler(function(title,element) {
        createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
        });
};

config.commands.syncing.handlePopup = function(popup,title)
{
    var tiddler = store.fetchTiddler(title);
    if(!tiddler)
        return;
    var serverType = tiddler.getServerType();
    var serverHost = tiddler.fields['server.host'];
    var serverWorkspace = tiddler.fields['server.workspace'];
    if(!serverWorkspace)
        serverWorkspace = "";
    if(serverType) {
        var e = createTiddlyElement(popup,"li",null,"popupMessage");
        e.innerHTML = config.commands.syncing.currentlySyncing.format([serverType,serverHost,serverWorkspace]);
    } else {
        createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.notCurrentlySyncing);
    }
    if(serverType) {
        createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
        var btn = createTiddlyButton(createTiddlyElement(popup,"li"),this.captionUnSync,null,config.commands.syncing.onChooseServer);
        btn.setAttribute("tiddler",title);
        btn.setAttribute("server.type","");
    }
    createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
    createTiddlyElement(popup,"li",null,"popupMessage",config.commands.syncing.chooseServer);
    var feeds = store.getTaggedTiddlers("systemServer","title");
    for(var t=0; t<feeds.length; t++) {
        var f = feeds[t];
        var feedServerType = store.getTiddlerSlice(f.title,"Type");
        if(!feedServerType)
            feedServerType = "file";
        var feedServerHost = store.getTiddlerSlice(f.title,"URL");
        if(!feedServerHost)
            feedServerHost = "";
        var feedServerWorkspace = store.getTiddlerSlice(f.title,"Workspace");
        if(!feedServerWorkspace)
            feedServerWorkspace = "";
        var caption = f.title;
        if(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {
            caption = config.commands.syncing.currServerMarker + caption;
        } else {
            caption = config.commands.syncing.notCurrServerMarker + caption;
        }
        btn = createTiddlyButton(createTiddlyElement(popup,"li"),caption,null,config.commands.syncing.onChooseServer);
        btn.setAttribute("tiddler",title);
        btn.setAttribute("server.type",feedServerType);
        btn.setAttribute("server.host",feedServerHost);
        btn.setAttribute("server.workspace",feedServerWorkspace);
    }
};

config.commands.syncing.onChooseServer = function(e)
{
    var tiddler = this.getAttribute("tiddler");
    var serverType = this.getAttribute("server.type");
    if(serverType) {
        store.addTiddlerFields(tiddler,{
            'server.type': serverType,
            'server.host': this.getAttribute("server.host"),
            'server.workspace': this.getAttribute("server.workspace")
            });
    } else {
        store.setValue(tiddler,'server',null);
    }
    return false;
};

config.commands.fields.handlePopup = function(popup,title)
{
    var tiddler = store.fetchTiddler(title);
    if(!tiddler)
        return;
    var fields = {};
    store.forEachField(tiddler,function(tiddler,fieldName,value) {fields[fieldName] = value;},true);
    var items = [];
    for(var t in fields) {
        items.push({field: t,value: fields[t]});
    }
    items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
    if(items.length > 0)
        ListView.create(popup,items,this.listViewTemplate);
    else
        createTiddlyElement(popup,"div",null,null,this.emptyText);
};

//--
//-- Tiddler() object
//--

function Tiddler(title)
{
    this.title = title;
    this.text = null;
    this.modifier = null;
    this.modified = new Date();
    this.created = new Date();
    this.links = [];
    this.linksUpdated = false;
    this.tags = [];
    this.fields = {};
    return this;
}

Tiddler.prototype.getLinks = function()
{
    if(this.linksUpdated==false)
        this.changed();
    return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
    var f = {};
    for(i in this.fields) {
        if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
            f[i] = this.fields[i];
        }
    }
    return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
    var c = this.fields['changecount'];
    c = c ? parseInt(c) : 0;
    this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
    if(this.fields['changecount']) {
        delete this.fields['changecount'];
    }
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
    var changeCount = this.fields['changecount'];
    if(changeCount === undefined)
        changeCount = 0;
    return changeCount > 0;
};

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
    var s = [];
    s.push("<item>");
    s.push("<title" + ">" + this.title.htmlEncode() + "</title" + ">");
    s.push("<description>" + wikifyStatic(this.text,null,this).htmlEncode() + "</description>");
    for(var t=0; t<this.tags.length; t++)
        s.push("<category>" + this.tags[t] + "</category>");
    s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
    s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
    s.push("</item>");
    return s.join("\n");
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
    this.assign(title,text,modifier,modified,tags,created,fields);
    this.changed();
    return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
    if(title != undefined)
        this.title = title;
    if(text != undefined)
        this.text = text;
    if(modifier != undefined)
        this.modifier = modifier;
    if(modified != undefined)
        this.modified = modified;
    if(created != undefined)
        this.created = created;
    if(fields != undefined)
        this.fields = fields;
    if(tags != undefined)
        this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
    else if(this.tags == undefined)
        this.tags = [];
    return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
    return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
    return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
    return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
    return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
    this.links = [];
    var t = this.autoLinkWikiWords() ? 0 : 1;
    var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
    tiddlerLinkRegExp.lastIndex = 0;
    var formatMatch = tiddlerLinkRegExp.exec(this.text);
    while(formatMatch) {
        var lastIndex = tiddlerLinkRegExp.lastIndex;
        if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
            // wikiWordLink
            if(formatMatch.index > 0) {
                var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
                preRegExp.lastIndex = formatMatch.index-1;
                var preMatch = preRegExp.exec(this.text);
                if(preMatch.index != formatMatch.index-1)
                    this.links.pushUnique(formatMatch[1]);
            } else {
                this.links.pushUnique(formatMatch[1]);
            }
        }
        else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
            this.links.pushUnique(formatMatch[3-t]);
        else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
            this.links.pushUnique(formatMatch[4-t]);
        tiddlerLinkRegExp.lastIndex = lastIndex;
        formatMatch = tiddlerLinkRegExp.exec(this.text);
    }
    this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
    var theModifier = this.modifier;
    if(!theModifier)
        theModifier = config.messages.subtitleUnknown;
    var theModified = this.modified;
    if(theModified)
        theModified = theModified.toLocaleString();
    else
        theModified = config.messages.subtitleUnknown;
    return config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]);
};

Tiddler.prototype.isReadOnly = function()
{
    return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
    return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.generateFingerprint = function()
{
    return "0x" + Crypto.hexSha1Str(this.text);
};

Tiddler.prototype.getServerType = function()
{
    var serverType = null;
    if(this.fields && this.fields['server.type'])
        serverType = this.fields['server.type'];
    if(!serverType)
        serverType = this.fields['wikiformat'];
    if(serverType && !config.adaptors[serverType])
        serverType = null;
    return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
    var serverType = this.getServerType();
    if(serverType)
        return new config.adaptors[serverType];
    else
        return null;
};

//--
//-- TiddlyWiki() object contains Tiddler()s
//--

function TiddlyWiki()
{
    var tiddlers = {}; // Hashmap by name of tiddlers
    this.tiddlersUpdated = false;
    this.namedNotifications = []; // Array of {name:,notify:} of notification functions
    this.notificationLevel = 0;
    this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
    this.clear = function() {
        tiddlers = {};
        this.setDirty(false);
    };
    this.fetchTiddler = function(title) {
        return tiddlers[title];
    };
    this.deleteTiddler = function(title) {
        delete this.slices[title];
        delete tiddlers[title];
    };
    this.addTiddler = function(tiddler) {
        delete this.slices[tiddler.title];
        tiddlers[tiddler.title] = tiddler;
    };
    this.forEachTiddler = function(callback) {
        for(var t in tiddlers) {
            var tiddler = tiddlers[t];
            if(tiddler instanceof Tiddler)
                callback.call(this,t,tiddler);
        }
    };
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
    this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
    return this.dirty;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
    this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
    this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
    if(!this.notificationLevel) {
        for(var t=0; t<this.namedNotifications.length; t++) {
            var n = this.namedNotifications[t];
            if((n.name == null && doBlanket) || (n.name == title))
                n.notify(title);
        }
    }
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
    if(!this.notificationLevel) {
        for(var t=0; t<this.namedNotifications.length; t++) {
            var n = this.namedNotifications[t];
            if(n.name)
                n.notify(n.name);
        }
    }
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
    for(var i=0; i<this.namedNotifications.length; i++) {
        if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
            return this;
    }
    this.namedNotifications.push({name: title, notify: fn});
    return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler) {
        this.deleteTiddler(title);
        this.notify(title,true);
        this.setDirty(true);
    }
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
    var t = this.fetchTiddler(title);
    return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
    return typeof config.shadowTiddlers[title] == "string";
};

TiddlyWiki.prototype.getTiddler = function(title)
{
    var t = this.fetchTiddler(title);
    if(t != undefined)
        return t;
    else
        return null;
};

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler)
        return tiddler.text;
    if(!title)
        return defaultText;
    var pos = title.indexOf(config.textPrimitives.sliceSeparator);
    if(pos != -1) {
        var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
        if(slice)
            return slice;
    }
    if(this.isShadowTiddler(title))
        return config.shadowTiddlers[title];
    if(defaultText != undefined)
        return defaultText;
    return null;
};

TiddlyWiki.prototype.slicesRE = /(?:[\'\/]*~?([\.\w]+)[\'\/]*\:[\'\/]*\s*(.*?)\s*$)|(?:\|[\'\/]*~?([\.\w]+)\:?[\'\/]*\|\s*(.*?)\s*\|)/gm;

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
    var slices = {};
    var text = this.getTiddlerText(title,"");
    this.slicesRE.lastIndex = 0;
    do {
        var m = this.slicesRE.exec(text);
        if(m) {
            if(m[1])
                slices[m[1]] = m[2];
            else
                slices[m[3]] = m[4];
        }
    } while(m);
    return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
    var slices = this.slices[title];
    if(!slices) {
        slices = this.calcAllSlices(title);
        this.slices[title] = slices;
    }
    return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
    var r = {};
    for(var t=0; t<sliceNames.length; t++) {
        var slice = this.getTiddlerSlice(title,sliceNames[t]);
        if(slice)
            r[sliceNames[t]] = slice;
    }
    return r;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
    var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
    var text = this.getTiddlerText(title,null);
    if(text == null)
        return defaultText;
    var textOut = [];
    var lastPos = 0;
    do {
        var match = bracketRegExp.exec(text);
        if(match) {
            textOut.push(text.substr(lastPos,match.index-lastPos));
            if(match[1]) {
                if(depth <= 0)
                    textOut.push(match[1]);
                else
                    textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
            }
            lastPos = match.index + match[0].length;
        } else {
            textOut.push(text.substr(lastPos));
        }
    } while(match);
    return textOut.join("");
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler) {
        var t = tiddler.tags.indexOf(tag);
        if(t != -1)
            tiddler.tags.splice(t,1);
        if(status)
            tiddler.tags.push(tag);
        tiddler.changed();
        this.incChangeCount(title);
        this.notify(title,true);
        this.setDirty(true);
    }
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
    var tiddler = this.fetchTiddler(title);
    if(!tiddler)
        return;
    merge(tiddler.fields,fields);
    tiddler.changed();
    this.incChangeCount(title);
    this.notify(title,true);
    this.setDirty(true);
};

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler) {
        created = created ? created : tiddler.created; // Preserve created date
        this.deleteTiddler(title);
    } else {
        created = created ? created : modified;
        tiddler = new Tiddler();
    }
    tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
    this.addTiddler(tiddler);
    if(clearChangeCount)
        tiddler.clearChangeCount();
    else
        tiddler.incChangeCount();
    if(title != newTitle)
        this.notify(title,true);
    this.notify(newTitle,true);
    this.setDirty(true);
    return tiddler;
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler) {
        tiddler.clearChangeCount();
        this.notify(title,true);
        this.setDirty(true);
    }
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
    var tiddler = this.fetchTiddler(title);
    if(tiddler)
        tiddler.incChangeCount();
};

TiddlyWiki.prototype.createTiddler = function(title)
{
    var tiddler = this.fetchTiddler(title);
    if(!tiddler) {
        tiddler = new Tiddler();
        tiddler.title = title;
        this.addTiddler(tiddler);
        this.setDirty(true);
    }
    return tiddler;
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
    this.idPrefix = idPrefix;
    var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
    if(!storeElem)
        return;
    var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
    this.setDirty(false);
    if(!noUpdate) {
        for(var i = 0;i<tiddlers.length; i++)
            tiddlers[i].changed();
    }
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
    var posDiv = locateStoreArea(text);
    if(!posDiv)
        return null;
    var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
    // Create the iframe
    var iframe = document.createElement("iframe");
    iframe.style.display = "none";
    document.body.appendChild(iframe);
    var doc = iframe.document;
    if(iframe.contentDocument)
        doc = iframe.contentDocument; // For NS6
    else if(iframe.contentWindow)
        doc = iframe.contentWindow.document; // For IE5.5 and IE6
    // Put the content in the iframe
    doc.open();
    doc.writeln(content);
    doc.close();
    // Load the content into a TiddlyWiki() object
    var storeArea = doc.getElementById("storeArea");
    this.loadFromDiv(storeArea,"store");
    // Get rid of the iframe
    iframe.parentNode.removeChild(iframe);
    return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
    this.tiddlersUpdated = true;
    this.forEachTiddler(function(title,tiddler) {
        tiddler.changed();
    });
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
    return store.getSaver().externalize(store);
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)
{
    var candidates = this.reverseLookup("tags",excludeTag,false);
    var results = [];
    for(var t=0; t<candidates.length; t++) {
        if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
            results.push(candidates[t]);
    }
    if(!sortField)
        sortField = "title";
    results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
    return results;
};

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
    var results = [];
    this.forEachTiddler(function(title,tiddler) {
        for(var g=0; g<tiddler.tags.length; g++) {
            var tag = tiddler.tags[g];
            if(excludeTag) {
                var t = store.fetchTiddler(tag);
                if(t && t.isTagged(excludeTag))
                    return false;
            }
            var f = false;
            for(var c=0; c<results.length; c++) {
                if(results[c][0] == tag) {
                    f = true;
                    results[c][1]++;
                }
            }
            if(!f)
                results.push([tag,1]);
        }
    });
    results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
    return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
    return this.reverseLookup("tags",tag,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
    if(!this.tiddlersUpdated)
        this.updateTiddlers();
    return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
    var results = [];
    this.forEachTiddler(function(title,tiddler) {
        var f = !lookupMatch;
        for(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {
            if(tiddler[lookupField][lookup] == lookupValue)
                f = lookupMatch;
        }
        if(f)
            results.push(tiddler);
    });
    if(!sortField)
        sortField = "title";
    results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
    return results;
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
    var results = [];
    this.forEachTiddler(function(title,tiddler) {
        if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
            results.push(tiddler);
    });
    if(field)
        results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
    return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
    if(!this.tiddlersUpdated)
        this.updateTiddlers();
    var results = [];
    this.forEachTiddler(function (title,tiddler) {
        if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
            return;
        for(var n=0; n<tiddler.links.length;n++) {
            var link = tiddler.links[n];
            if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
                results.pushUnique(link);
        }
    });
    results.sort();
    return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
    var results = [];
    this.forEachTiddler(function (title,tiddler) {
        if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
            results.push(title);
    });
    results.sort();
    return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
    var results = [];
    for(var t in config.shadowTiddlers) {
        if(typeof config.shadowTiddlers[t] == "string")
            results.push(t);
    }
    results.sort();
    return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
    var results = [];
    this.forEachTiddler(function(title,tiddler) {
        if(tiddler.isTouched())
            results.push(tiddler);
        });
    results.sort();
    return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
    var t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;
    return t instanceof Tiddler ? t : null;
};

TiddlyWiki.prototype.getLoader = function()
{
    if(!this.loader)
        this.loader = new TW21Loader();
    return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
    if(!this.saver)
        this.saver = new TW21Saver();
    return this.saver;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by '.'
TiddlyWiki.isValidFieldName = function(name)
{
    var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
    return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
    if(!TiddlyWiki.isValidFieldName(name))
        throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
    this.set = readOnly ?
            function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
            function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
    this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
    this.set = function(t,v) {
        var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
        if(d != t[n]) {
            t[n] = d; return true;
        }
    };
    this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
    this.set = function(t,v) {
        var s = (typeof v == "string") ? v.readBracketedList() : v;
        if(s.toString() != t[n].toString()) {
            t[n] = s; return true;
        }
    };
    this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
    // The set functions return true when setting the data has changed the value.
    "title":    new StringFieldAccess("title",true),
    // Handle the "tiddler" field name as the title
    "tiddler":  new StringFieldAccess("title",true),
    "text":     new StringFieldAccess("text"),
    "modifier": new StringFieldAccess("modifier"),
    "modified": new DateFieldAccess("modified"),
    "created":  new DateFieldAccess("created"),
    "tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
    return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
    TiddlyWiki.checkFieldName(fieldName);
    var t = this.resolveTiddler(tiddler);
    if(!t)
        return;
    fieldName = fieldName.toLowerCase();
    var isRemove = (value === undefined) || (value === null);
    var accessor = TiddlyWiki.standardFieldAccess[fieldName];
    if(accessor) {
        if(isRemove)
            // don't remove StandardFields
            return;
        var h = TiddlyWiki.standardFieldAccess[fieldName];
        if(!h.set(t,value))
            return;
    } else {
        var oldValue = t.fields[fieldName];
        if(isRemove) {
            if(oldValue !== undefined) {
                // deletes a single field
                delete t.fields[fieldName];
            } else {
                // no concrete value is defined for the fieldName
                // so we guess this is a namespace path.
                // delete all fields in a namespace
                var re = new RegExp('^'+fieldName+'\\.');
                var dirty = false;
                for(var n in t.fields) {
                    if(n.match(re)) {
                        delete t.fields[n];
                        dirty = true;
                    }
                }
                if(!dirty)
                    return;
            }
        } else {
            // the "normal" set case. value is defined (not null/undefined)
            // For convenience provide a nicer conversion Date->String
            value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
            if(oldValue == value)
                return;
            t.fields[fieldName] = value;
        }
    }
    // When we are here the tiddler/store really was changed.
    this.notify(t.title,true);
    if(!fieldName.match(/^temp\./))
        this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
    var t = this.resolveTiddler(tiddler);
    if(!t)
        return undefined;
    fieldName = fieldName.toLowerCase();
    var accessor = TiddlyWiki.standardFieldAccess[fieldName];
    if(accessor) {
        return accessor.get(t);
    }
    return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
    var t = this.resolveTiddler(tiddler);
    if(!t)
        return undefined;
    for(var n in t.fields) {
        var result = callback(t,n,t.fields[n]);
        if(result)
            return result;
        }
    if(onlyExtendedFields)
        return undefined;
    for(var n in TiddlyWiki.standardFieldAccess) {
        if(n == "tiddler")
            // even though the "title" field can also be referenced through the name "tiddler"
            // we only visit this field once.
            continue;
        var result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
        if(result)
            return result;
    }
    return undefined;
};

//--
//-- Story functions
//--

function Story(container,idPrefix)
{
    this.container = container;
    this.idPrefix = idPrefix;
    this.highlightRegExp = null;
}

Story.prototype.forEachTiddler = function(fn)
{
    var place = document.getElementById(this.container);
    if(!place)
        return;
    var e = place.firstChild;
    while(e) {
        var n = e.nextSibling;
        var title = e.getAttribute("tiddler");
        fn.call(this,title,e);
        e = n;
    }
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
    for(var t = titles.length-1;t>=0;t--)
        this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,title,template,animate,unused,customFields,toggle)
{
    var place = document.getElementById(this.container);
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem) {
        if(toggle)
            this.closeTiddler(title,true);
        else
            this.refreshTiddler(title,template,false,customFields);
    } else {
        var before = this.positionTiddler(srcElement);
        tiddlerElem = this.createTiddler(place,before,title,template,customFields);
    }
    if(srcElement && typeof srcElement !== "string") {
        if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
            anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
        else
            window.scrollTo(0,ensureVisible(tiddlerElem));
    }
};

Story.prototype.positionTiddler = function(srcElement)
{
    var place = document.getElementById(this.container);
    var before = null;
    if(typeof srcElement == "string") {
        switch(srcElement) {
            case "top":
                before = place.firstChild;
                break;
            case "bottom":
                before = null;
                break;
        }
    } else {
        var after = this.findContainingTiddler(srcElement);
        if(after == null) {
            before = place.firstChild;
        } else if(after.nextSibling) {
            before = after.nextSibling;
            if(before.nodeType != 1)
                before = null;
        }
    }
    return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
    var tiddlerElem = createTiddlyElement(null,"div",this.idPrefix + title,"tiddler");
    tiddlerElem.setAttribute("refresh","tiddler");
    if(customFields)
        tiddlerElem.setAttribute("tiddlyFields",customFields);
    place.insertBefore(tiddlerElem,before);
    var defaultText = null;
    if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
        defaultText = this.loadMissingTiddler(title,customFields,tiddlerElem);
    this.refreshTiddler(title,template,false,customFields,defaultText);
    return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,tiddlerElem)
{
    var tiddler = new Tiddler(title);
    tiddler.fields = typeof fields == "string" ?  fields.decodeHashMap() : (fields ? fields : {});
    var serverType = tiddler.getServerType();
    var host = tiddler.fields['server.host'];
    var workspace = tiddler.fields['server.workspace'];
    if(!serverType | !host)
        return null;
    var sm = new SyncMachine(serverType,{
            start: function() {
                return this.openHost(host,"openWorkspace");
            },
            openWorkspace: function() {
                return this.openWorkspace(workspace,"getTiddler");
            },
            getTiddler: function() {
                return this.getTiddler(title,"gotTiddler");
            },
            gotTiddler: function(tiddler) {
                if(tiddler && tiddler.text) {
                    var downloaded = new Date();
                    if(!tiddler.created)
                        tiddler.created = downloaded;
                    if(!tiddler.modified)
                        tiddler.modified = tiddler.created;
                    store.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);
                    autoSaveChanges();
                }
                delete this;
                return true;
            },
            error: function(message) {
                displayMessage("Error loading missing tiddler from %0: %1".format([host,message]));
            }
        });
    sm.go();
    return config.messages.loadingMissingTiddler.format([title,serverType,host,workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
    if(!template)
        template = DEFAULT_VIEW_TEMPLATE;
    if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
        template = config.tiddlerTemplates[template];
    return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
    return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem) {
        if(tiddlerElem.getAttribute("dirty") == "true" && !force)
            return tiddlerElem;
        template = this.chooseTemplateForTiddler(title,template);
        var currTemplate = tiddlerElem.getAttribute("template");
        if((template != currTemplate) || force) {
            var tiddler = store.getTiddler(title);
            if(!tiddler) {
                tiddler = new Tiddler();
                if(store.isShadowTiddler(title)) {
                    tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
                } else {
                    var text = template=="EditTemplate" ?
                                config.views.editor.defaultText.format([title]) :
                                config.views.wikified.defaultText.format([title]);
                    text = defaultText ? defaultText : text;
                    var fields = customFields ? customFields.decodeHashMap() : null;
                    tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
                }
            }
            tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
            tiddlerElem.setAttribute("tiddler",title);
            tiddlerElem.setAttribute("template",template);
            var me = this;
            tiddlerElem.onmouseover = this.onTiddlerMouseOver;
            tiddlerElem.onmouseout = this.onTiddlerMouseOut;
            tiddlerElem.ondblclick = this.onTiddlerDblClick;
            tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
            var html = this.getTemplateForTiddler(title,template,tiddler);
            tiddlerElem.innerHTML = html;
            applyHtmlMacros(tiddlerElem,tiddler);
            if(store.getTaggedTiddlers(title).length > 0)
                addClass(tiddlerElem,"isTag");
            else
                removeClass(tiddlerElem,"isTag");
            if(!store.tiddlerExists(title)) {
                if(store.isShadowTiddler(title))
                    addClass(tiddlerElem,"shadow");
                else
                    addClass(tiddlerElem,"missing");
            } else {
                removeClass(tiddlerElem,"shadow");
                removeClass(tiddlerElem,"missing");
            }
            if(customFields)
                this.addCustomFields(tiddlerElem,customFields);
            forceReflow();
        }
    }
    return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
    var fields = customFields.decodeHashMap();
    var w = document.createElement("div");
    w.style.display = "none";
    place.appendChild(w);
    for(var t in fields) {
        var e = document.createElement("input");
        e.setAttribute("type","text");
        e.setAttribute("value",fields[t]);
        w.appendChild(e);
        e.setAttribute("edit",t);
    }
};

Story.prototype.refreshAllTiddlers = function()
{
    var place = document.getElementById(this.container);
    var e = place.firstChild;
    if(!e)
        return;
    this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
    while((e = e.nextSibling) != null)
        this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
};

Story.prototype.onTiddlerMouseOver = function(e)
{
    if(window.addClass instanceof Function)
        addClass(this,"selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
    if(window.removeClass instanceof Function)
        removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(e)
{
    if(!e) var e = window.event;
    var theTarget = resolveTarget(e);
    if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea") {
        if(document.selection && document.selection.empty)
            document.selection.empty();
        config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
        e.cancelBubble = true;
        if(e.stopPropagation) e.stopPropagation();
        return true;
    } else {
        return false;
    }
};

Story.prototype.onTiddlerKeyPress = function(e)
{
    if(!e) var e = window.event;
    clearMessage();
    var consume = false;
    var title = this.getAttribute("tiddler");
    var target = resolveTarget(e);
    switch(e.keyCode) {
        case 9: // Tab
            if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
                replaceSelection(target,String.fromCharCode(9));
                consume = true;
            }
            if(config.isOpera) {
                target.onblur = function() {
                    this.focus();
                    this.onblur = null;
                };
            }
            break;
        case 13: // Ctrl-Enter
        case 10: // Ctrl-Enter on IE PC
        case 77: // Ctrl-Enter is "M" on some platforms
            if(e.ctrlKey) {
                blurElement(this);
                config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
                consume = true;
            }
            break;
        case 27: // Escape
            blurElement(this);
            config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
            consume = true;
            break;
    }
    e.cancelBubble = consume;
    if(consume) {
        if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
        e.returnValue = true; // Cancel The Event in IE
        if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
    }
    return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    var e = null;
    if(tiddlerElem != null) {
        var children = tiddlerElem.getElementsByTagName("*");
        for(var t=0; t<children.length; t++) {
            var c = children[t];
            if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
                if(!e)
                    e = c;
                if(c.getAttribute("edit") == field)
                    e = c;
            }
        }
    }
    return e;
};

Story.prototype.focusTiddler = function(title,field)
{
    var e = this.getTiddlerField(title,field);
    if(e) {
        e.focus();
        e.select();
    }
};

Story.prototype.blurTiddler = function(title)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur) {
        tiddlerElem.focus();
        tiddlerElem.blur();
    }
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
    var c = story.getTiddlerField(title,field);

    var tags = c.value.readBracketedList();
    tags.setItem(tag,mode);
    c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
    Story.prototype.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem != null) {
        clearMessage();
        this.scrubTiddler(tiddlerElem);
        if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
            anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
        else {
            removeNode(tiddlerElem);
            forceReflow();
        }
    }
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
    tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem != null)
        tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem != null)
        return tiddlerElem.getAttribute("dirty") == "true";
    return null;
};

Story.prototype.areAnyDirty = function()
{
    var r = false;
    this.forEachTiddler(function(title,element) {
        if(this.isDirty(title))
            r = true;
    });
    return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
    clearMessage();
    this.forEachTiddler(function(title,element) {
        if((title != exclude) && element.getAttribute("dirty") != "true")
            this.closeTiddler(title);
    });
    window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
    var place = document.getElementById(this.container);
    return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
    this.closeAllTiddlers();
    highlightHack = new RegExp(useRegExp ?   text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
    var matches = store.search(highlightHack,"title","excludeSearch");
    var titles = [];
    for(var t=0;t<matches.length;t++)
        titles.push(matches[t].title);
    this.displayTiddlers(null,titles);
    highlightHack = null;
    var q = useRegExp ? "/" : "'";
    if(matches.length > 0)
        displayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));
    else
        displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
    while(e && !hasClass(e,"tiddler"))
        e = e.parentNode;
    return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
    if(e && e.getAttribute) {
        var f = e.getAttribute("edit");
        if(f)
            fields[f] = e.value.replace(/\r/mg,"");
        if(e.hasChildNodes()) {
            var c = e.childNodes;
            for(var t=0; t<c.length; t++)
                this.gatherSaveFields(c[t],fields);
        }
    }
};

Story.prototype.hasChanges = function(title)
{
    var e = document.getElementById(this.idPrefix + title);
    if(e != null) {
        var fields = {};
        this.gatherSaveFields(e,fields);
        var tiddler = store.fetchTiddler(title);
        if(!tiddler)
            return false;
        for(var n in fields) {
            if(store.getValue(title,n) != fields[n])
                return true;
        }
    }
    return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
    var tiddlerElem = document.getElementById(this.idPrefix + title);
    if(tiddlerElem != null) {
        var fields = {};
        this.gatherSaveFields(tiddlerElem,fields);
        var newTitle = fields.title ? fields.title : title;
        if(store.tiddlerExists(newTitle) && newTitle != title) {
            if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
                return null;
        }
        if(newTitle != title)
            this.closeTiddler(newTitle,false);
        tiddlerElem.id = this.idPrefix + newTitle;
        tiddlerElem.setAttribute("tiddler",newTitle);
        tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
        tiddlerElem.setAttribute("dirty","false");
        if(config.options.chkForceMinorUpdate)
            minorUpdate = !minorUpdate;
        if(!store.tiddlerExists(newTitle))
            minorUpdate = false;
        var newDate = new Date();
        var extendedFields = store.tiddlerExists(newTitle) ? store.fetchTiddler(newTitle).fields : {};
        for(var n in fields) {
            if(!TiddlyWiki.isStandardField(n))
                extendedFields[n] = fields[n];
            }
        var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields);
        autoSaveChanges(null,[tiddler]);
        return newTitle;
    }
    return null;
};

Story.prototype.permaView = function()
{
    var links = [];
    this.forEachTiddler(function(title,element) {
        links.push(String.encodeTiddlyLink(title));
    });
    var t = encodeURIComponent(links.join(" "));
    if(t == "")
        t = "#";
    if(window.location.hash != t)
        window.location.hash = t;
};

//--
//-- Backstage
//--

var backstage = {
    area: null,
    toolbar: null,
    button: null,
    showButton: null,
    hideButton: null,
    cloak: null,
    panel: null,
    panelBody: null,
    panelFooter: null,
    currTabName: null,
    currTabElem: null,
    content: null,

    init: function() {
        var cmb = config.messages.backstage;
        this.area = document.getElementById("backstageArea");
        this.toolbar = document.getElementById("backstageToolbar");
        this.button = document.getElementById("backstageButton");
        this.button.style.display = "block";
        var t = cmb.open.text + " " + glyph("bentArrowLeft");
        this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
                        function (e) {backstage.show(); return false;},null,"backstageShow");
        t = glyph("bentArrowRight") + " " + cmb.close.text;
        this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
                        function (e) {backstage.hide(); return false;},null,"backstageHide");
        this.cloak = document.getElementById("backstageCloak");
        this.panel = document.getElementById("backstagePanel");
        this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
        this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
        this.cloak.onmousedown = function(e) {
            backstage.switchTab(null);
        };
        createTiddlyText(this.toolbar,cmb.prompt);
        for(t=0; t<config.backstageTasks.length; t++) {
            var taskName = config.backstageTasks[t];
            var task = config.tasks[taskName];
            var handler = task.action ? this.onClickCommand : this.onClickTab;
            var text = task.text + (task.action ? "" : glyph("downTriangle"));
            var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
            btn.setAttribute("task",taskName);
            addClass(btn,task.action ? "backstageAction" : "backstageTask");
            }
        this.content = document.getElementById("contentWrapper");
        if(config.options.chkBackstage)
            this.show();
        else
            this.hide();
    },

    isVisible: function () {
        return this.area ? this.area.style.display == "block" : false;
    },

    show: function() {
        this.area.style.display = "block";
        if(anim && config.options.chkAnimate) {
            backstage.toolbar.style.left = findWindowWidth() + "px";
            var p = [
                {style: "left", start: findWindowWidth(), end: 0, template: "%0px"}
            ];
            anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
        } else {
            backstage.area.style.left = "0px";
        }
        this.showButton.style.display = "none";
        this.hideButton.style.display = "block";
        config.options.chkBackstage = true;
        saveOptionCookie("chkBackstage");
        addClass(this.content,"backstageVisible");
    },

    hide: function() {
        if(this.currTabElem) {
            this.switchTab(null);
        } else {
            backstage.toolbar.style.left = "0px";
            if(anim && config.options.chkAnimate) {
                var p = [
                    {style: "left", start: 0, end: findWindowWidth(), template: "%0px"}
                ];
                var c = function(element,properties) {backstage.area.style.display = "none";};
                anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
            } else {
                this.area.style.display = "none";
            }
            this.showButton.style.display = "block";
            this.hideButton.style.display = "none";
            config.options.chkBackstage = false;
            saveOptionCookie("chkBackstage");
            removeClass(this.content,"backstageVisible");
        }
    },

    onClickCommand: function(e) {
        var task = config.tasks[this.getAttribute("task")];
        displayMessage(task);
        if(task.action) {
            backstage.switchTab(null);
            task.action();
        }
        return false;
    },

    onClickTab: function(e) {
        backstage.switchTab(this.getAttribute("task"));
        return false;
    },

    // Switch to a given tab, or none if null is passed
    switchTab: function(tabName) {
        var tabElem = null;
        var e = this.toolbar.firstChild;
        while(e)
            {
            if(e.getAttribute && e.getAttribute("task") == tabName)
                tabElem = e;
            e = e.nextSibling;
            }
        if(tabName == backstage.currTabName)
            return;
        if(backstage.currTabElem) {
            removeClass(this.currTabElem,"backstageSelTab");
        }
        if(tabElem && tabName) {
            backstage.preparePanel();
            addClass(tabElem,"backstageSelTab");
            var task = config.tasks[tabName];
            wikify(task.content,backstage.panelBody,null,null);
            backstage.showPanel();
        } else if(backstage.currTabElem) {
            backstage.hidePanel();
        }
        backstage.currTabName = tabName;
        backstage.currTabElem = tabElem;
    },

    isPanelVisible: function() {
        return backstage.panel ? backstage.panel.style.display == "block" : false;
    },

    preparePanel: function() {
        backstage.cloak.style.height = findWindowHeight() + "px";
        backstage.cloak.style.display = "block";
        removeChildren(backstage.panelBody);
        return backstage.panelBody;
    },

    showPanel: function() {
        backstage.panel.style.display = "block";
        if(anim && config.options.chkAnimate) {
            backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
            var p = [
                {style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}
            ];
            anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
        } else {
            backstage.panel.style.top = "0px";
        }
        return backstage.panelBody;
    },

    hidePanel: function() {
        backstage.currTabName = null;
        backstage.currTabElem = null;
        if(anim && config.options.chkAnimate) {
            var p = [
                {style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
                {style: "display", atEnd: "none"}
            ];
            var c = function(element,properties) {backstage.cloak.style.display = "none";};
            anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
         } else {
            backstage.panel.style.display = "none";
            backstage.cloak.style.display = "none";
        }
    }
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    var backstageTask = config.tasks[params[0]];
    if(backstageTask)
        createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};

//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if(readOnly) {
        createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
        return;
    }
    var w = new Wizard();
    w.createWizard(place,this.wizardTitle);
    this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
    var wizard = new Wizard(this);
    var place = wizard.clear();
    config.macros.importTiddlers.restart(wizard);
    return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
    wizard.addStep(this.step1Title,this.step1Html);
    var s = wizard.getElement("selTypes");
    for(var t in config.adaptors) {
        var e = createTiddlyElement(s,"option",null,null,t);
        e.value = t;
    }
    s = wizard.getElement("selFeeds");
    var feeds = this.getFeeds();
    for(t in feeds) {
        e = createTiddlyElement(s,"option",null,null,t);
        e.value = t;
    }
    wizard.setValue("feeds",feeds);
    s.onchange = config.macros.importTiddlers.onFeedChange;
    var fileInput = wizard.getElement("txtBrowse");
    fileInput.onchange = config.macros.importTiddlers.onBrowseChange;
    fileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;
    wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: config.macros.importTiddlers.onOpen}]);
};

config.macros.importTiddlers.getFeeds = function()
{
    var feeds = {};
    var tagged = store.getTaggedTiddlers("systemServer","title");
    for(var t=0; t<tagged.length; t++) {
        var title = tagged[t].title;
        var serverType = store.getTiddlerSlice(title,"Type");
        if(!serverType)
            serverType = "file";
        feeds[title] = {title: title,
                        url: store.getTiddlerSlice(title,"URL"),
                        workspace: store.getTiddlerSlice(title,"Workspace"),
                        workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
                        tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
                        serverType: serverType,
                        description: store.getTiddlerSlice(title,"Description")};
    }
    return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
    var wizard = new Wizard(this);
    var selTypes = wizard.getElement("selTypes");
    var fileInput = wizard.getElement("txtPath");
    var feeds = wizard.getValue("feeds");
    var f = feeds[this.value];
    if(f) {
        selTypes.value = f.serverType;
        fileInput.value = f.url;
        this.selectedIndex = 0;
        wizard.setValue("feedName",f.serverType);
        wizard.setValue("feedHost",f.url);
        wizard.setValue("feedWorkspace",f.workspace);
        wizard.setValue("feedWorkspaceList",f.workspaceList);
        wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
    }
    return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
    var wizard = new Wizard(this);
    var fileInput = wizard.getElement("txtPath");
    fileInput.value = "file://" + this.value;
    return false;
};

config.macros.importTiddlers.onOpen = function(e)
{
    var wizard = new Wizard(this);
    var fileInput = wizard.getElement("txtPath");
    var url = fileInput.value;
    var serverType = wizard.getElement("selTypes").value;
    var adaptor = new config.adaptors[serverType];
    wizard.setValue("adaptor",adaptor);
    wizard.setValue("serverType",serverType);
    wizard.setValue("host",url);
    var context = {};
    var ret = adaptor.openHost(url,context,wizard,config.macros.importTiddlers.onOpenHost);
    if(ret !== true)
        displayMessage(ret);
    wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenHost);
    return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
    var adaptor = wizard.getValue("adaptor");
    if(context.status !== true)
        displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
    var ret = adaptor.getWorkspaceList(context,wizard,config.macros.importTiddlers.onGetWorkspaceList);
    if(ret !== true)
        displayMessage(ret);
    wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
    if(context.status !== true)
        displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
    wizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);
    var s = wizard.getElement("selWorkspace");
    s.onchange = config.macros.importTiddlers.onWorkspaceChange;
    for(var t=0; t<context.workspaces.length; t++) {
        var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
        e.value = context.workspaces[t].title;
    }
    var workspaceList = wizard.getValue("feedWorkspaceList");
    if(workspaceList) {
        var list = workspaceList.parseParams("workspace",null,false,true);
        for(var n=1; n<list.length; n++) {
            if(context.workspaces.findByField("title",list[n].value) == null) {
                e = createTiddlyElement(s,"option",null,null,list[n].value);
                e.value = list[n].value;
            }
        }
    }
    var workspace = wizard.getValue("feedWorkspace");
    if(workspace) {
        t = wizard.getElement("txtWorkspace");
        t.value = workspace;
    }
    wizard.setButtons([{caption: config.macros.importTiddlers.openLabel, tooltip: config.macros.importTiddlers.openPrompt, onClick: config.macros.importTiddlers.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
    var wizard = new Wizard(this);
    var t = wizard.getElement("txtWorkspace");
    t.value  = this.value;
    this.selectedIndex = 0;
    return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
    var wizard = new Wizard(this);
    var adaptor = wizard.getValue("adaptor");
    var workspace = wizard.getElement("txtWorkspace").value;
    wizard.setValue("workspace",workspace);
    var context = {};
    var ret = adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);
    if(ret !== true)
        displayMessage(ret);
    wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);
    return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
    if(context.status !== true)
        displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
    var adaptor = wizard.getValue("adaptor");
    var ret = adaptor.getTiddlerList(context,wizard,config.macros.importTiddlers.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
    if(ret !== true)
        displayMessage(ret);
    wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
    if(context.status !== true)
        displayMessage("Error in importTiddlers.onGetTiddlerList: " + context.statusText);
    // Extract data for the listview
    var listedTiddlers = [];
    if(context.tiddlers) {
        for(var n=0; n<context.tiddlers.length; n++) {
            var tiddler = context.tiddlers[n];
            listedTiddlers.push({
                title: tiddler.title,
                modified: tiddler.modified,
                modifier: tiddler.modifier,
                text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
                tags: tiddler.tags,
                size: tiddler.text ? tiddler.text.length : 0,
                tiddler: tiddler
            });
        }
    }
    listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
    // Display the listview
    wizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);
    var markList = wizard.getElement("markList");
    var listWrapper = document.createElement("div");
    markList.parentNode.insertBefore(listWrapper,markList);
    var listView = ListView.create(listWrapper,listedTiddlers,config.macros.importTiddlers.listViewTemplate);
    wizard.setValue("listView",listView);
    var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
    txtSaveTiddler.value = config.macros.importTiddlers.generateSystemServerName(wizard);
    wizard.setButtons([
            {caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},
            {caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick:  config.macros.importTiddlers.doImport}
        ]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
    var serverType = wizard.getValue("serverType");
    var host = wizard.getValue("host");
    var workspace = wizard.getValue("workspace");
    var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
    return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
    var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
    if(store.tiddlerExists(txtSaveTiddler)) {
        if(!confirm(config.macros.importTiddlers.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
            return;
        store.suspendNotifications();
        store.removeTiddler(txtSaveTiddler);
        store.resumeNotifications();
    }
    var serverType = wizard.getValue("serverType");
    var host = wizard.getValue("host");
    var workspace = wizard.getValue("workspace");
    var text = config.macros.importTiddlers.serverSaveTemplate.format([serverType,host,workspace]);
    store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,config.macros.importTiddlers.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
    var wizard = new Wizard(this);
    if(wizard.getElement("chkSave").checked)
        config.macros.importTiddlers.saveServerTiddler(wizard);
    var chkSync = wizard.getElement("chkSync").checked;
    wizard.setValue("sync",chkSync);
    var listView = wizard.getValue("listView");
    var rowNames = ListView.getSelectedRows(listView);
    var adaptor = wizard.getValue("adaptor");
    var overwrite = new Array();
    var t;
    for(t=0; t<rowNames.length; t++) {
        if(store.tiddlerExists(rowNames[t]))
            overwrite.push(rowNames[t]);
    }
    if(overwrite.length > 0) {
        if(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(", ")])))
            return false;
    }
    wizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);
    for(t=0; t<rowNames.length; t++) {
        var link = document.createElement("div");
        createTiddlyLink(link,rowNames[t],true);
        var place = wizard.getElement("markReport");
        place.parentNode.insertBefore(link,place);
    }
    wizard.setValue("remainingImports",rowNames.length);
    wizard.setButtons([
            {caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}
        ],config.macros.importTiddlers.statusDoingImport);
    for(t=0; t<rowNames.length; t++) {
        var context = {};
        context.allowSynchronous = true;
        var inbound = adaptor.getTiddler(rowNames[t],context,wizard,config.macros.importTiddlers.onGetTiddler);
    }
    return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
    if(!context.status)
        displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
    var tiddler = context.tiddler;
    store.suspendNotifications();
    store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
    if(!wizard.getValue("sync")) {
        store.setValue(tiddler.title,'server',null);
    }
    store.resumeNotifications();
    if(!context.isSynchronous)
        store.notify(tiddler.title,true);
    var remainingImports = wizard.getValue("remainingImports")-1;
    wizard.setValue("remainingImports",remainingImports);
    if(remainingImports == 0) {
        if(context.isSynchronous) {
            store.notifyAll();
            refreshDisplay();
        }
        wizard.setButtons([
                {caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onCancel}
            ],config.macros.importTiddlers.statusDoneImport);
        autoSaveChanges();
    }
};

//--
//-- Sync macro
//--

// Synchronisation handlers
config.syncers = {};

// Sync state.
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if(!wikifier.isStatic)
        this.startSync(place);
};

config.macros.sync.startSync = function(place)
{
    if(currSync)
        config.macros.sync.cancelSync();
    currSync = {};
    currSync.syncList = this.getSyncableTiddlers();
    this.createSyncTasks();
    this.preProcessSyncableTiddlers();
    var wizard = new Wizard();
    currSync.wizard = wizard;
    wizard.createWizard(place,this.wizardTitle);
    wizard.addStep(this.step1Title,this.step1Html);
    var markList = wizard.getElement("markList");
    var listWrapper = document.createElement("div");
    markList.parentNode.insertBefore(listWrapper,markList);
    currSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
    this.processSyncableTiddlers();
    wizard.setButtons([
            {caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}
        ]);
};

config.macros.sync.getSyncableTiddlers = function ()
{
    var list = [];
    store.forEachTiddler(function(title,tiddler) {
        var syncItem = {};
        syncItem.serverType = tiddler.getServerType();
        syncItem.serverHost = tiddler.fields['server.host'];
        syncItem.serverWorkspace = tiddler.fields['server.workspace'];
        syncItem.tiddler = tiddler;
        syncItem.title = tiddler.title;
        syncItem.isTouched = tiddler.isTouched();
        syncItem.selected = syncItem.isTouched;
        syncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? "changedLocally" : "none"];
        syncItem.status = syncItem.syncStatus.text;
        if(syncItem.serverType && syncItem.serverHost)
            list.push(syncItem);
        });
    list.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
    return list;
};

config.macros.sync.preProcessSyncableTiddlers = function()
{
    for(var t=0; t<currSync.syncList.length; t++) {
        si = currSync.syncList[t];
        var ti = si.syncTask.syncMachine.generateTiddlerInfo(si.tiddler);
        si.serverUrl = ti.uri;
    }
};

config.macros.sync.processSyncableTiddlers = function()
{
    for(var t=0; t<currSync.syncList.length; t++) {
        si = currSync.syncList[t];
        si.rowElement.style.backgroundColor = si.syncStatus.color;
    }
};

config.macros.sync.createSyncTasks = function()
{
    currSync.syncTasks = [];
    for(var t=0; t<currSync.syncList.length; t++) {
        var si = currSync.syncList[t];
        var r = null;
        for(var st=0; st<currSync.syncTasks.length; st++) {
            var cst = currSync.syncTasks[st];
            if(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)
                r = cst;
        }
        if(r == null) {
            si.syncTask = this.createSyncTask(si);
            currSync.syncTasks.push(si.syncTask);
        } else {
            si.syncTask = r;
            r.syncItems.push(si);
        }
    }
};

config.macros.sync.createSyncTask = function(syncItem)
{
    var st = {};
    st.serverType = syncItem.serverType;
    st.serverHost = syncItem.serverHost;
    st.serverWorkspace = syncItem.serverWorkspace;
    st.syncItems = [syncItem];
    st.syncMachine = new SyncMachine(st.serverType,{
        start: function() {
            return this.openHost(st.serverHost,"openWorkspace");
        },
        openWorkspace: function() {
            return this.openWorkspace(st.serverWorkspace,"getTiddlerList");
        },
        getTiddlerList: function() {
            return this.getTiddlerList("gotTiddlerList");
        },
        gotTiddlerList: function(tiddlers) {
            for(var t=0; t<st.syncItems.length; t++) {
                var si = st.syncItems[t];
                var f = tiddlers.findByField("title",si.title);
                if(f !== null) {
                    if(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {
                        si.syncStatus = config.macros.sync.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];
                    }
                } else {
                    si.syncStatus = config.macros.sync.syncStatusList.notFound;
                }
                config.macros.sync.updateSyncStatus(si);
            }
        },
        getTiddler: function(title) {
            return this.getTiddler(title,"onGetTiddler");
        },
        onGetTiddler: function(tiddler) {
            var syncItem = st.syncItems.findByField("title",tiddler.title);
            if(syncItem !== null) {
                syncItem = st.syncItems[syncItem];
                store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
                syncItem.syncStatus = config.macros.sync.syncStatusList.gotFromServer;
                config.macros.sync.updateSyncStatus(syncItem);
            }
        },
        putTiddler: function(tiddler) {
            return this.putTiddler(tiddler,"onPutTiddler");
        },
        onPutTiddler: function(tiddler) {
            var syncItem = st.syncItems.findByField("title",tiddler.title);
            if(syncItem !== null) {
                syncItem = st.syncItems[syncItem];
                store.resetTiddler(tiddler.title);
                syncItem.syncStatus = config.macros.sync.syncStatusList.putToServer;
                config.macros.sync.updateSyncStatus(syncItem);
            }
        }
    });
    st.syncMachine.go();
    return st;
};

config.macros.sync.updateSyncStatus = function(syncItem)
{
    var e = syncItem.colElements["status"];
    removeChildren(e);
    createTiddlyText(e,syncItem.syncStatus.text);
    syncItem.rowElement.style.backgroundColor = syncItem.syncStatus.color;
};

config.macros.sync.doSync = function(e)
{
    var rowNames = ListView.getSelectedRows(currSync.listView);
    for(var t=0; t<currSync.syncList.length; t++) {
        var si = currSync.syncList[t];
        if(rowNames.indexOf(si.title) != -1) {
            config.macros.sync.doSyncItem(si);
        }
    }
    return false;
};

config.macros.sync.doSyncItem = function(syncItem)
{
    var r = true;
    var sl = config.macros.sync.syncStatusList;
    switch(syncItem.syncStatus) {
        case sl.changedServer:
            r = syncItem.syncTask.syncMachine.go("getTiddler",syncItem.title);
            break;
        case sl.notFound:
        case sl.changedLocally:
        case sl.changedBoth:
            r = syncItem.syncTask.syncMachine.go("putTiddler",syncItem.tiddler);
            break;
        default:
            break;
    }
    if(r !== true)
        displayMessage("Error in doSyncItem: " + r);
};

config.macros.sync.cancelSync = function()
{
    currSync = null;
};

function SyncMachine(serverType,steps)
{
    this.serverType = serverType;
    this.adaptor = new config.adaptors[serverType];
    this.steps = steps;
}

SyncMachine.prototype.go = function(step,varargs)
{
    if(!step)
        step = "start";
    var h = this.steps[step];
    if(!h)
        return null;
    var a = [];
    for(var t=1; t<arguments.length; t++)
        a.push(arguments[t]);
    var r = h.apply(this,a);
    if(typeof r == "string")
        this.invokeError(r);
    return r;
};

SyncMachine.prototype.invokeError = function(message)
{
    if(this.steps.error)
        this.steps.error(message);
};

SyncMachine.prototype.openHost = function(host,nextStep)
{
    var me = this;
    return me.adaptor.openHost(host,null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep);
    });
};

SyncMachine.prototype.getWorkspaceList = function(nextStep)
{
    var me = this;
    return me.adaptor.getWorkspaceList(null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep,context.workspaces);
    });
};

SyncMachine.prototype.openWorkspace = function(workspace,nextStep)
{
    var me = this;
    return me.adaptor.openWorkspace(workspace,null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep);
    });
};

SyncMachine.prototype.getTiddlerList = function(nextStep)
{
    var me = this;
    return me.adaptor.getTiddlerList(null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep,context.tiddlers);
    });
};

SyncMachine.prototype.generateTiddlerInfo = function(tiddler)
{
    return this.adaptor.generateTiddlerInfo(tiddler);
};

SyncMachine.prototype.getTiddler = function(title,nextStep)
{
    var me = this;
    return me.adaptor.getTiddler(title,null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep,context.tiddler);
    });
};

SyncMachine.prototype.putTiddler = function(tiddler,nextStep)
{
    var me = this;
    return me.adaptor.putTiddler(tiddler,null,null,function(context) {
        if(typeof context.status == "string")
            me.invokeError(context.status);
        else
            me.go(nextStep,tiddler);
    });
};

//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    var wizard = new Wizard();
    wizard.createWizard(place,this.wizardTitle);
    wizard.addStep(this.step1Title,this.step1Html);
    var markList = wizard.getElement("markList");
    var listWrapper = document.createElement("div");
    markList.parentNode.insertBefore(listWrapper,markList);
    listWrapper.setAttribute("refresh","macro");
    listWrapper.setAttribute("macroName","plugins");
    listWrapper.setAttribute("params",paramString);
    this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
    var wizard = new Wizard(listWrapper);
    var selectedRows = [];
    ListView.forEachSelector(listWrapper,function(e,rowName) {
            if(e.checked)
                selectedRows.push(e.getAttribute("rowName"));
        });
    removeChildren(listWrapper);
    params = params.parseParams("anon");
    var plugins = installedPlugins.slice(0);
    var t,tiddler,p;
    var configTiddlers = store.getTaggedTiddlers("systemConfig");
    for(t=0; t<configTiddlers.length; t++) {
        tiddler = configTiddlers[t];
        if(plugins.findByField("title",tiddler.title) == null) {
            p = getPluginInfo(tiddler);
            p.executed = false;
            p.log.splice(0,0,this.skippedText);
            plugins.push(p);
        }
    }
    for(t=0; t<plugins.length; t++) {
        p = plugins[t];
        p.size = p.tiddler.text ? p.tiddler.text.length : 0;
        p.forced = p.tiddler.isTagged("systemConfigForce");
        p.disabled = p.tiddler.isTagged("systemConfigDisable");
        p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
    }
    if(plugins.length == 0) {
        createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
        wizard.setButtons([]);
    } else {
        var listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);
        wizard.setValue("listView",listView);
        wizard.setButtons([
                {caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick:  config.macros.plugins.doRemoveTag},
                {caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick:  config.macros.plugins.doDelete}
            ]);
    }
};

config.macros.plugins.doRemoveTag = function(e)
{
    var wizard = new Wizard(this);
    var listView = wizard.getValue("listView");
    var rowNames = ListView.getSelectedRows(listView);
    if(rowNames.length == 0) {
        alert(config.messages.nothingSelected);
    } else {
        for(var t=0; t<rowNames.length; t++)
            store.setTiddlerTag(rowNames[t],false,"systemConfig");
    }
};

config.macros.plugins.doDelete = function(e)
{
    var wizard = new Wizard(this);
    var listView = wizard.getValue("listView");
    var rowNames = ListView.getSelectedRows(listView);
    if(rowNames.length == 0) {
        alert(config.messages.nothingSelected);
    } else {
        if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
            for(t=0; t<rowNames.length; t++) {
                store.removeTiddler(rowNames[t]);
                story.closeTiddler(rowNames[t],true);
            }
        }
    }
};

//--
//-- Message area
//--

function getMessageDiv()
{
    var msgArea = document.getElementById("messageArea");
    if(!msgArea)
        return null;
    if(!msgArea.hasChildNodes())
        createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
            config.messages.messageClose.text,
            config.messages.messageClose.tooltip,
            clearMessage);
    msgArea.style.display = "block";
    return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
    var e = getMessageDiv();
    if(!e) {
        alert(text);
        return;
    }
    if(linkText) {
        var link = createTiddlyElement(e,"a",null,null,text);
        link.href = linkText;
        link.target = "_blank";
    } else {
        e.appendChild(document.createTextNode(text));
    }
}

function clearMessage()
{
    var msgArea = document.getElementById("messageArea");
    if(msgArea) {
        removeChildren(msgArea);
        msgArea.style.display = "none";
    }
    return false;
}

//--
//-- Refresh mechanism
//--

config.refreshers = {
    link: function(e,changeList)
        {
        var title = e.getAttribute("tiddlyLink");
        refreshTiddlyLink(e,title);
        return true;
        },

    tiddler: function(e,changeList)
        {
        var title = e.getAttribute("tiddler");
        var template = e.getAttribute("template");
        if(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))
            story.refreshTiddler(title,template,true);
        else
            refreshElements(e,changeList);
        return true;
        },

    content: function(e,changeList)
        {
        var title = e.getAttribute("tiddler");
        var force = e.getAttribute("force");
        if(force != null || changeList == null || changeList.indexOf(title) != -1) {
            removeChildren(e);
            wikify(store.getTiddlerText(title,title),e,null);
            return true;
        } else
            return false;
        },

    macro: function(e,changeList)
        {
        var macro = e.getAttribute("macroName");
        var params = e.getAttribute("params");
        if(macro)
            macro = config.macros[macro];
        if(macro && macro.refresh)
            macro.refresh(e,params);
        return true;
        }
};

function refreshElements(root,changeList)
{
    var nodes = root.childNodes;
    for(var c=0; c<nodes.length; c++) {
        var e = nodes[c], type = null;
        if(e.getAttribute  && (e.tagName ? e.tagName != "IFRAME" : true))
            type = e.getAttribute("refresh");
        var refresher = config.refreshers[type];
        var refreshed = false;
        if(refresher != undefined)
            refreshed = refresher(e,changeList);
        if(e.hasChildNodes() && !refreshed)
            refreshElements(e,changeList);
    }
}

function applyHtmlMacros(root,tiddler)
{
    var e = root.firstChild;
    while(e) {
        var nextChild = e.nextSibling;
        if(e.getAttribute) {
            var macro = e.getAttribute("macro");
            if(macro) {
                var params = "";
                var p = macro.indexOf(" ");
                if(p != -1) {
                    params = macro.substr(p+1);
                    macro = macro.substr(0,p);
                }
                invokeMacro(e,macro,params,null,tiddler);
            }
        }
        if(e.hasChildNodes())
            applyHtmlMacros(e,tiddler);
        e = nextChild;
    }
}

function refreshPageTemplate(title)
{
    var stash = createTiddlyElement(document.body,"div");
    stash.style.display = "none";
    var display = document.getElementById("tiddlerDisplay");
    var nodes,t;
    if(display) {
        nodes = display.childNodes;
        for(t=nodes.length-1; t>=0; t--)
            stash.appendChild(nodes[t]);
    }
    var wrapper = document.getElementById("contentWrapper");
    if(!title)
        title = "PageTemplate";
    var html = store.getRecursiveTiddlerText(title,null,10);
    wrapper.innerHTML = html;
    applyHtmlMacros(wrapper);
    refreshElements(wrapper);
    display = document.getElementById("tiddlerDisplay");
    removeChildren(display);
    if(!display)
        display = createTiddlyElement(wrapper,"div","tiddlerDisplay");
    nodes = stash.childNodes;
    for(t=nodes.length-1; t>=0; t--)
        display.appendChild(nodes[t]);
    removeNode(stash);
}

function refreshDisplay(hint)
{
    if(typeof hint == "string")
        hint = [hint];
    var e = document.getElementById("contentWrapper");
    refreshElements(e,hint);
    if(backstage.isPanelVisible()) {
        e = document.getElementById("backstage");
        refreshElements(e,hint);
    }
}

function refreshPageTitle()
{
    document.title = getPageTitle();
}

function getPageTitle()
{
    var st = wikifyPlain("SiteTitle");
    var ss = wikifyPlain("SiteSubtitle");
    return st + ((st == "" || ss == "") ? "" : " - ") + ss;
}

function refreshStyles(title,doc)
{
    if(!doc)
        doc = document;
    setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc);
}

function refreshColorPalette(title)
{
    if(!startingUp)
        refreshAll();
}

function refreshAll()
{
    refreshPageTemplate();
    refreshDisplay();
    refreshStyles("StyleSheetLayout");
    refreshStyles("StyleSheetColors");
    refreshStyles("StyleSheet");
    refreshStyles("StyleSheetPrint");
}

//--
//-- Options cookie stuff
//--

config.optionHandlers = {
    'txt': {
        get: function(name) {return encodeCookie(config.options[name].toString());},
        set: function(name,value) {config.options[name] = decodeCookie(value);}
    },
    'chk': {
        get: function(name) {return config.options[name] ? "true" : "false";},
        set: function(name,value) {config.options[name] = value == "true";}
    }
};

function loadOptionsCookie()
{
    if(safeMode)
        return;
    var cookies = document.cookie.split(";");
    for(var c=0; c<cookies.length; c++) {
        var p = cookies[c].indexOf("=");
        if(p != -1) {
            var name = cookies[c].substr(0,p).trim();
            var value = cookies[c].substr(p+1).trim();
            var optType = name.substr(0,3);
            if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
                config.optionHandlers[optType].set(name,value);
        }
    }
}

function saveOptionCookie(name)
{
    if(safeMode)
        return;
    var c = name + "=";
    var optType = name.substr(0,3);
    if(config.optionHandlers[optType] && config.optionHandlers[optType].get)
        c += config.optionHandlers[optType].get(name);
    c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
    document.cookie = c;
}

function encodeCookie(s)
{
    return escape(manualConvertUnicodeToUTF8(s));
}

function decodeCookie(s)
{
    s = unescape(s);
    var re = /&#[0-9]{1,5};/g;
    return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,"")));});
}

//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
    hadConfirmExit = true;
    if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
        return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
    if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
        if(confirm(config.messages.unsavedChangesWarning))
            saveChanges();
    }
}

function updateLanguageAttribute(s)
{
    if(config.locale) {
        var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
        var m = mRE.exec(s);
        if(m) {
            var t = m[1];
            if(m[2])
                t += ' xml:lang="' + config.locale + '"';
            if(m[3])
                t += ' lang="' + config.locale + '"';
            t += ">";
            s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
        }
    }
    return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
    return s.replaceChunk(
            "<!--%0-START-->".format([blockName]),
            "<!--%0-END-->".format([blockName]),
            "\n" + store.getRecursiveTiddlerText(tiddlerName,"") + "\n");
}

function updateOriginal(original,posDiv)
{
    if(!posDiv)
        posDiv = locateStoreArea(original);
    if(!posDiv) {
        alert(config.messages.invalidFileError.format([localPath]));
        return null;
    }
    var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
                convertUnicodeToUTF8(store.allTiddlersAsHtml()) + "\n" +
                original.substr(posDiv[1]);
    var newSiteTitle = convertUnicodeToUTF8(getPageTitle()).htmlEncode();
    revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
    revised = updateLanguageAttribute(revised);
    revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
    revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
    revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
    revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
    return revised;
}

function locateStoreArea(original)
{
    // Locate the storeArea div's
    var posOpeningDiv = original.indexOf(startSaveArea);
    var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
    if(limitClosingDiv == -1)
        limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
    var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
    return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
    if(config.options.chkAutoSave)
        saveChanges(onlyIfDirty,tiddlers);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
    if(onlyIfDirty && !store.isDirty())
        return;
    clearMessage();
    // Get the URL of the document
    var originalPath = document.location.toString();
    // Check we were loaded from a file URL
    if(originalPath.substr(0,5) != "file:") {
        alert(config.messages.notFileUrlError);
        if(store.tiddlerExists(config.messages.saveInstructions))
            story.displayTiddler(null,config.messages.saveInstructions);
        return;
    }
    var localPath = getLocalPath(originalPath);
    // Load the original file
    var original = loadFile(localPath);
    if(original == null) {
        alert(config.messages.cantSaveError);
        if(store.tiddlerExists(config.messages.saveInstructions))
            story.displayTiddler(null,config.messages.saveInstructions);
        return;
    }
    // Locate the storeArea div's
    var posDiv = locateStoreArea(original);
    if(!posDiv) {
        alert(config.messages.invalidFileError.format([localPath]));
        return;
    }
    saveBackup(localPath,original);
    saveRss(localPath);
    saveEmpty(localPath,original,posDiv);
    saveMain(localPath,original,posDiv);
}

function saveBackup(localPath,original)
{
    // Save the backup
    if(config.options.chkSaveBackups) {
        var backupPath = getBackupPath(localPath);
        var backup = config.browser.isIE ? ieCopyFile(backupPath,localPath) : saveFile(backupPath,original);
        if(backup)
            displayMessage(config.messages.backupSaved,"file://" + backupPath);
        else
            alert(config.messages.backupFailed);
    }
}

function saveRss(localPath)
{
    if(config.options.chkGenerateAnRssFeed) {
        var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
        var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
        if(rssSave)
            displayMessage(config.messages.rssSaved,"file://" + rssPath);
        else
            alert(config.messages.rssFailed);
    }
}

function saveEmpty(localPath,original,posDiv)
{
    if(config.options.chkSaveEmptyTemplate) {
        var emptyPath,p;
        if((p = localPath.lastIndexOf("/")) != -1)
            emptyPath = localPath.substr(0,p) + "/empty.html";
        else if((p = localPath.lastIndexOf("\\")) != -1)
            emptyPath = localPath.substr(0,p) + "\\empty.html";
        else
            emptyPath = localPath + ".empty.html";
        var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
        var emptySave = saveFile(emptyPath,empty);
        if(emptySave)
            displayMessage(config.messages.emptySaved,"file://" + emptyPath);
        else
            alert(config.messages.emptyFailed);
    }
}

function saveMain(localPath,original,posDiv)
{
    var save;
    try {
        var revised = updateOriginal(original,posDiv);
        save = saveFile(localPath,revised);
    } catch (ex) {
        showException(ex);
    }
    if(save) {
        displayMessage(config.messages.mainSaved,"file://" + localPath);
        store.setDirty(false);
    } else {
        alert(config.messages.mainFailed);
    }
}

function getLocalPath(origPath)
{
    var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
    // Remove any location or query part of the URL
    var argPos = originalPath.indexOf("?");
    if(argPos != -1)
        originalPath = originalPath.substr(0,argPos);
    var hashPos = originalPath.indexOf("#");
    if(hashPos != -1)
        originalPath = originalPath.substr(0,hashPos);
    // Convert file://localhost/ to file:///
    if(originalPath.indexOf("file://localhost/") == 0)
        originalPath = "file://" + originalPath.substr(16);
    // Convert to a native file format
    var localPath;
    if(originalPath.charAt(9) == ":") // pc local file
        localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
    else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
        localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
    else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
        localPath = unescape(originalPath.substr(7));
    else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
        localPath = unescape(originalPath.substr(5));
    else // pc network file
        localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
    return localPath;
}

function getBackupPath(localPath)
{
    var backSlash = true;
    var dirPathPos = localPath.lastIndexOf("\\");
    if(dirPathPos == -1) {
        dirPathPos = localPath.lastIndexOf("/");
        backSlash = false;
    }
    var backupFolder = config.options.txtBackupFolder;
    if(!backupFolder || backupFolder == "")
        backupFolder = ".";
    var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? "\\" : "/") + backupFolder + localPath.substr(dirPathPos);
    backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
    return backupPath;
}

function generateRss()
{
    var s = [];
    var d = new Date();
    var u = store.getTiddlerText("SiteUrl");
    // Assemble the header
    s.push("<" + "?xml version=\"1.0\"?" + ">");
    s.push("<rss version=\"2.0\">");
    s.push("<channel>");
    s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
    if(u)
        s.push("<link>" + u.htmlEncode() + "</link>");
    s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
    s.push("<language>en-us</language>");
    s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
    s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
    s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
    s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
    s.push("<generator>TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + "</generator>");
    // The body
    var tiddlers = store.getTiddlers("modified","excludeLists");
    var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
    for (var t=tiddlers.length-1; t>=n; t--)
        s.push(tiddlers[t].saveToRss(u));
    // And footer
    s.push("</channel>");
    s.push("</rss>");
    // Save it all
    return s.join("\n");
}

//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
    if(window.netscape == undefined)
        return manualConvertUTF8ToUnicode(u);
    else
        return mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
    var uni = utf;
    var src = 0;
    var dst = 0;
    var b1, b2, b3;
    var c;
    while(src < utf.length) {
        b1 = utf.charCodeAt(src++);
        if(b1 < 0x80) {
            dst++;
        } else if(b1 < 0xE0) {
            b2 = utf.charCodeAt(src++);
            c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
            uni = uni.substring(0,dst++).concat(c,utf.substr(src));
        } else {
            b2 = utf.charCodeAt(src++);
            b3 = utf.charCodeAt(src++);
            c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
            uni = uni.substring(0,dst++).concat(c,utf.substr(src));
        }
    }
    return uni;
}

function mozConvertUTF8ToUnicode(u)
{
    try {
        netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
        var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
        converter.charset = "UTF-8";
    } catch(ex) {
        return manualConvertUTF8ToUnicode(u);
    } // fallback
    var s = converter.ConvertToUnicode(u);
    var fin = converter.Finish();
    return (fin.length > 0) ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
    if(window.netscape == undefined)
        return manualConvertUnicodeToUTF8(s);
    else
        return mozConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
    var re = /[^\u0000-\u007F]/g ;
    return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function mozConvertUnicodeToUTF8(s)
{
    try {
        netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
        var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
        converter.charset = "UTF-8";
    } catch(ex) {
        return manualConvertUnicodeToUTF8(s);
    } // fallback
    var u = converter.ConvertFromUnicode(s);
    var fin = converter.Finish();
    if(fin.length > 0)
        return u + fin;
    else
        return u;
}

function convertUriToUTF8(uri,charSet)
{
    if(window.netscape == undefined || charSet == undefined || charSet == "")
        return uri;
    try {
        netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
        var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
    } catch(ex) {
        return uri;
    }
    return converter.convertURISpecToUTF8(uri,charSet);
}

function saveFile(fileUrl,content)
{
    var r = null;
    if(!r) r = mozillaSaveFile(fileUrl,content);
    if(!r) r = ieSaveFile(fileUrl,content);
    if(!r) r = javaSaveFile(fileUrl,content);
    return r;
}

function loadFile(fileUrl)
{
    var r = null;
    if((r == null) || (r == false))
        r = mozillaLoadFile(fileUrl);
    if((r == null) || (r == false))
        r = ieLoadFile(fileUrl);
    if((r == null) || (r == false))
        r = javaLoadFile(fileUrl);
    return r;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
    try {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
    } catch(ex) {
        return null;
    }
    var file = fso.OpenTextFile(filePath,2,-1,0);
    file.Write(content);
    file.Close();
    return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
    try {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var file = fso.OpenTextFile(filePath,1);
        var content = file.ReadAll();
        file.Close();
    } catch(ex) {
        return null;
    }
    return content;
}

function ieCopyFile(dest,source)
{
    try {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        fso.GetFile(source).Copy(dest);
    } catch(ex) {
        return false;
    }
    return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
    if(window.Components) {
        try {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
            var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
            file.initWithPath(filePath);
            if(!file.exists())
                file.create(0,0664);
            var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
            out.init(file,0x20|0x02,00004,null);
            out.write(content,content.length);
            out.flush();
            out.close();
            return true;
        } catch(ex) {
            return false;
        }
    }
    return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
    if(window.Components) {
        try {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
            var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
            file.initWithPath(filePath);
            if(!file.exists())
                return null;
            var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
            inputStream.init(file,0x01,00004,null);
            var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
            sInputStream.init(inputStream);
            return sInputStream.read(sInputStream.available());
        } catch(ex) {
            return false;
        }
    }
    return null;
}

function javaUrlToFilename(url)
{
    var f = "//localhost";
    if(url.indexOf(f) == 0)
        return url.substring(f.length);
    var i = url.indexOf(":");
    if(i > 0)
        return url.substring(i-1);
    return url;
}

function javaSaveFile(filePath,content)
{
    try {
        if(document.applets["TiddlySaver"])
            return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
    } catch(ex) {
    }
    try {
        var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
        s.print(content);
        s.close();
    } catch(ex) {
        return null;
    }
    return true;
}

function javaLoadFile(filePath)
{
    try {
        if(document.applets["TiddlySaver"])
            return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
    } catch(ex) {
    }
    var content = [];
    try {
        var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
        var line;
        while((line = r.readLine()) != null)
            content.push(new String(line));
        r.close();
    } catch(ex) {
        return null;
    }
    return content.join("\n");
}

//--
//-- Server adaptor for talking to static files
//--

function FileAdaptor()
{
    this.host = null;
    this.store = null;
    return this;
}

FileAdaptor.NotLoadedError = "TiddlyWiki file has not been loaded";
FileAdaptor.serverType = 'file';

// Open the specified host/server
FileAdaptor.prototype.openHost = function(host,context,userParams,callback)
{
    this.host = host;
    if(!context)
        context = {};
    context.adaptor = this;
    context.callback = callback;
    context.userParams = userParams;
    var ret = loadRemoteFile(host,FileAdaptor.openHostCallback,context);
    return typeof(ret) == "string" ? ret : true;
};

FileAdaptor.openHostCallback = function(status,context,responseText,url,xhr)
{
    var adaptor = context.adaptor;
    context.status = status;
    if(!status) {
        context.statusText = "Error reading file: " + xhr.statusText;
    } else {
        // Load the content into a TiddlyWiki() object
        adaptor.store = new TiddlyWiki();
        if(!adaptor.store.importTiddlyWiki(responseText))
            context.statusText = config.messages.invalidFileError.format([url]);
    }
    context.callback(context,context.userParams);
};

// Gets the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
    if(!context)
        context = {};
    context.workspaces = [{title:"(default)"}];
    context.status = true;
    window.setTimeout(function() {callback(context,userParams);},10);
    return true;
};

// Open the specified workspace
FileAdaptor.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
    if(!context)
        context = {};
    context.status = true;
    window.setTimeout(function() {callback(context,userParams);},10);
    return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback)
{
    if(!this.store)
        return FileAdaptor.NotLoadedError;
    if(!context)
        context = {};
    context.tiddlers = [];
    this.store.forEachTiddler(function(title,tiddler)
        {
        var t = new Tiddler(title);
        t.text = tiddler.text;
        t.modified = tiddler.modified;
        t.modifier = tiddler.modifier;
        t.fields['server.page.revision'] = tiddler.modified.convertToYYYYMMDDHHMM();
        t.tags = tiddler.tags;
        context.tiddlers.push(t);
        });
    context.status = true;
    window.setTimeout(function() {callback(context,userParams);},10);
    return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
    var info = {};
    info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
    return info;
};

// Retrieves a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
    if(!this.store)
        return FileAdaptor.NotLoadedError;
    if(!context)
        context = {};
    context.tiddler = this.store.fetchTiddler(title);
    if(context.tiddler) {
        context.tiddler.fields['server.type'] = FileAdaptor.serverType;
        context.tiddler.fields['server.host'] = this.host;
        context.tiddler.fields['server.page.revision'] = context.tiddler.modified.convertToYYYYMMDDHHMM();
    }
    context.status = true;
    if(context.allowSynchronous) {
        context.isSynchronous = true;
        callback(context,userParams);
    } else {
        window.setTimeout(function() {callback(context,userParams);},10);
    }
    return true;
};

FileAdaptor.prototype.close = function()
{
    delete this.store;
    this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

//--
//-- Remote HTTP requests
//--

function loadRemoteFile(url,callback,params)
{
    return doHttp("GET",url,null,null,null,null,callback,params,null);
}

// HTTP status codes
var httpStatus = {
    OK: 200,
    ContentCreated: 201,
    NoContent: 204,
    Unauthorized: 401,
    Forbidden: 403,
    NotFound: 404,
    MethodNotAllowed: 405
};

function doHttp(type,url,data,contentType,username,password,callback,params,headers)
{
    // Get an xhr object
    var x = getXMLHttpRequest();
    if(!x)
        return "Can't create XMLHttpRequest object";
    // Install callback
    x.onreadystatechange = function() {
        if (x.readyState == 4 && callback && (x.status !== undefined)) {
            if([0, httpStatus.OK, httpStatus.ContentCreated, httpStatus.NoContent].contains(x.status))
                callback(true,params,x.responseText,url,x);
            else
                callback(false,params,null,url,x);
            x.onreadystatechange = function(){};
            x = null;
        }
    };
    // Send request
    if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
        window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
    try {
        url = url + (url.indexOf("?") < 0 ? "?" : "&") + "nocache=" + Math.random();
        x.open(type,url,true,username,password);
        if (data)
            x.setRequestHeader("Content-Type", contentType ? contentType : "application/x-www-form-urlencoded");
        if (x.overrideMimeType)
            x.setRequestHeader("Connection", "close");
        if(headers) {
            for(n in headers)
                x.setRequestHeader(n,headers[n]);
        }
        x.setRequestHeader("X-Requested-With", "TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
        x.send(data);
    } catch (ex) {
        return exceptionText(ex);
    }
    return x;
}

function getXMLHttpRequest()
{
    try {
        var x = new XMLHttpRequest(); // Modern
    } catch(ex) {
        try {
            x = new ActiveXObject("Msxml2.XMLHTTP"); // IE 6
        } catch (ex2) {
            return null;
        }
    }
    return x;
}

//--
//-- TiddlyWiki-specific utility functions
//--

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
    var theButton = document.createElement("a");
    if(theAction) {
        theButton.onclick = theAction;
        theButton.setAttribute("href","javascript:;");
    }
    if(theTooltip)
        theButton.setAttribute("title",theTooltip);
    if(theText)
        theButton.appendChild(document.createTextNode(theText));
    if(theClass)
        theButton.className = theClass;
    else
        theButton.className = "button";
    if(theId)
        theButton.id = theId;
    if(theParent)
        theParent.appendChild(theButton);
    if(theAccessKey)
        theButton.setAttribute("accessKey",theAccessKey);
    return theButton;
}

function createTiddlyLink(place,title,includeText,theClass,isStatic,linkedFromTiddler,noToggle)
{
    var text = includeText ? title : null;
    var i = getTiddlyLinkInfo(title,theClass);
    var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
    btn.setAttribute("refresh","link");
    btn.setAttribute("tiddlyLink",title);
    if(noToggle)
        btn.setAttribute("noToggle","true");
    if(linkedFromTiddler) {
        var fields = linkedFromTiddler.getInheritedFields();
        btn.setAttribute("tiddlyFields",fields);
    }
    return btn;
}

function refreshTiddlyLink(e,title)
{
    var i = getTiddlyLinkInfo(title,e.className);
    e.className = i.classes;
    e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
    var classes = currClasses ? currClasses.split(" ") : [];
    classes.pushUnique("tiddlyLink");
    var tiddler = store.fetchTiddler(title);
    var subTitle;
    if(tiddler) {
        subTitle = tiddler.getSubtitle();
        classes.pushUnique("tiddlyLinkExisting");
        classes.remove("tiddlyLinkNonExisting");
        classes.remove("shadow");
    } else {
        classes.remove("tiddlyLinkExisting");
        classes.pushUnique("tiddlyLinkNonExisting");
        if(store.isShadowTiddler(title)) {
            subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
            classes.pushUnique("shadow");
        } else {
            subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
            classes.remove("shadow");
        }
    }
    if(config.annotations[title])
        subTitle = config.annotations[title];
    return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url)
{
    var theLink = document.createElement("a");
    theLink.className = "externalLink";
    theLink.href = url;
    theLink.title = config.messages.externalLinkTooltip.format([url]);
    if(config.options.chkOpenInNewWindow)
        theLink.target = "_blank";
    place.appendChild(theLink);
    return theLink;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
    if(!e) e = window.event;
    var theTarget = resolveTarget(e);
    var theLink = theTarget;
    var title = null;
    var fields = null;
    var noToggle = null;
    do {
        title = theLink.getAttribute("tiddlyLink");
        fields = theLink.getAttribute("tiddlyFields");
        noToggle = theLink.getAttribute("noToggle");
        theLink = theLink.parentNode;
    } while(title == null && theLink != null);
    if(!fields && !store.isShadowTiddler(title))
        fields = String.encodeHashMap(config.defaultCustomFields);
    if(title) {
        var toggling = e.metaKey || e.ctrlKey;
        if(config.options.chkToggleLinks)
            toggling = !toggling;
        if(noToggle)
            toggling = false;
        story.displayTiddler(theTarget,title,null,true,null,fields,toggling);
    }
    clearMessage();
    return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
    var theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
    theTag.setAttribute("tag",tag);
    if(excludeTiddler)
        theTag.setAttribute("tiddler",excludeTiddler);
    return theTag;
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
    if(!e) var e = window.event;
    var theTarget = resolveTarget(e);
    var popup = Popup.create(this);
    var tag = this.getAttribute("tag");
    var title = this.getAttribute("tiddler");
    if(popup && tag) {
        var tagged = store.getTaggedTiddlers(tag);
        var titles = [];
        var li,r;
        for(r=0;r<tagged.length;r++) {
            if(tagged[r].title != title)
                titles.push(tagged[r].title);
        }
        var lingo = config.views.wikified.tag;
        if(titles.length > 0) {
            var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
            openAll.setAttribute("tag",tag);
            createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
            for(r=0; r<titles.length; r++) {
                createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
            }
        } else {
            createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
        }
        createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
        var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
        createTiddlyText(h,lingo.openTag.format([tag]));
    }
    Popup.show();
    e.cancelBubble = true;
    if(e.stopPropagation) e.stopPropagation();
    return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
    if(!e) var e = window.event;
    var tag = this.getAttribute("tag");
    var tagged = store.getTaggedTiddlers(tag);
    var titles = [];
    for(var t=0; t<tagged.length; t++)
        titles.push(tagged[t].title);
    story.displayTiddlers(this,titles);
    return false;
}

function onClickError(e)
{
    if(!e) var e = window.event;
    var popup = Popup.create(this);
    var lines = this.getAttribute("errorText").split("\n");
    for(var t=0; t<lines.length; t++)
        createTiddlyElement(popup,"li",null,null,lines[t]);
    Popup.show();
    e.cancelBubble = true;
    if(e.stopPropagation) e.stopPropagation();
    return false;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
    var sel = createTiddlyElement(place,"select");
    sel.onchange = onchange;
    for(var t=0; t<options.length; t++) {
        var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
        e.value = options[t].name;
        if(options[t].name == defaultValue)
            e.selected = true;
    }
    return sel;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
    if(tiddler.text) {
        createTiddlyLink(place,caption,true);
        var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
        btn.tiddler = tiddler;
    } else {
        createTiddlyText(place,caption);
    }
}

function onClickTiddlyPopup(e)
{
    var tiddler = this.tiddler;
    if(tiddler.text) {
        var popup = Popup.create(this,"div","popupTiddler");
        wikify(tiddler.text,popup,null,tiddler);
        Popup.show();
    }
    if(e) e.cancelBubble = true;
    if(e && e.stopPropagation) e.stopPropagation();
    return false;
}

function createTiddlyError(place,title,text)
{
    var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
    if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
    for(p in src) {
        if(!preserveExisting || dst[p] === undefined)
            dst[p] = src[p];
    }
    return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
    var s = e.description ? e.description : e.toString();
    return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
    alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
    alert(m);
    throw(m);
}

function glyph(name)
{
    var g = config.glyphs;
    var b = g.currBrowser;
    if(b == null) {
        b = 0;
        while(!g.browsers[b]() && b < g.browsers.length-1)
            b++;
        g.currBrowser = b;
    }
    if(!g.codes[name])
        return "";
    return g.codes[name][b];
}
//-
//- Animation engine
//-

function Animator()
{
    this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
    this.timerID = 0; // ID of the timer used for animating
    this.animations = []; // List of animations in progress
    return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
    for(var t=0; t<arguments.length; t++)
        this.animations.push(arguments[t]);
    if(this.running == 0) {
        var me = this;
        this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
    }
    this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
    var a = 0;
    while(a < me.animations.length) {
        var animation = me.animations[a];
        if(animation.tick()) {
            a++;
        } else {
            me.animations.splice(a,1);
            if(--me.running == 0)
                window.clearInterval(me.timerID);
        }
    }
};

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
    return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
    this.element = element;
    this.duration = duration;
    this.properties = properties;
    this.startTime = new Date();
    this.endTime = Number(this.startTime) + duration;
    this.callback = callback;
    this.tick();
    return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
    switch(style) {
        case "-tw-vertScroll":
            window.scrollTo(findScrollX(),value);
            break;
        case "-tw-horizScroll":
            window.scrollTo(value,findScrollY());
            break;
        default:
            element.style[style] = value;
            break;
    }
};

Morpher.prototype.stop = function()
{
    for(var t=0; t<this.properties.length; t++) {
        var p = this.properties[t];
        if(p.atEnd !== undefined) {
            this.assignStyle(this.element,p.style,p.atEnd);
        }
    }
    if(this.callback)
        this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
    var currTime = Number(new Date());
    progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
    for(var t=0; t<this.properties.length; t++) {
        var p = this.properties[t];
        if(p.start !== undefined && p.end !== undefined) {
            var template = p.template ? p.template : "%0";
            switch(p.format) {
                case undefined:
                case "style":
                    var v = p.start + (p.end-p.start) * progress;
                    this.assignStyle(this.element,p.style,template.format([v]));
                    break;
                case "color":
                    break;
            }
        }
    }
    if(currTime >= this.endTime) {
        this.stop();
        return false;
    }
    return true;
};

//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
    var e = createTiddlyElement(document.body,"div",null,"zoomer");
    createTiddlyElement(e,"div",null,null,text);
    var winWidth = findWindowWidth();
    var winHeight = findWindowHeight();
    var p = [
        {style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
        {style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
        {style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
        {style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
        {style: 'fontSize', start: 8, end: 24, template: '%0pt'}
    ];
    var c = function(element,properties) {removeNode(element);};
    return new Morpher(e,config.animDuration,p,c);
}

//--
//-- Scroller animation
//--

function Scroller(targetElement,unused)
{
    var p = [
        {style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}
    ];
    return new Morpher(targetElement,config.animDuration,p);
}

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
    element.style.overflow = 'hidden';
    if(opening)
        element.style.height = '0px'; // Resolves a Firefox flashing bug
    element.style.display = 'block';
    var left = findPosX(element);
    var width = element.scrollWidth;
    var height = element.scrollHeight;
    var winWidth = findWindowWidth();
    var p = [];
    var c = null;
    if(opening) {
        p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
        p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
        p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
    } else {
        p.push({style: 'height', start: height, end: 0, template: '%0px'});
        p.push({style: 'display', atEnd: 'none'});
        p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
        p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
        switch(deleteMode) {
            case "all":
                c = function(element,properties) {removeNode(element);};
                break;
            case "children":
                c = function(element,properties) {removeChildren(element);};
                break;
        }
    }
    return new Morpher(element,config.animDuration,p,c);
}

//--
//-- Popup menu
//--

var Popup = {
    stack: [] // Array of objects with members root: and popup:
    };

Popup.create = function(root,elem,theClass)
{
    Popup.remove();
    var popup = createTiddlyElement(document.body,elem ? elem : "ol","popup",theClass ? theClass : "popup");
    Popup.stack.push({root: root, popup: popup});
    return popup;
};

Popup.onDocumentClick = function(e)
{
    if (!e) var e = window.event;
    var target = resolveTarget(e);
    if(e.eventPhase == undefined)
        Popup.remove();
    else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
        Popup.remove();
    return true;
};

Popup.show = function(unused1,unused2)
{
    var curr = Popup.stack[Popup.stack.length-1];
    var rootLeft = findPosX(curr.root);
    var rootTop = findPosY(curr.root);
    var rootHeight = curr.root.offsetHeight;
    var popupLeft = rootLeft;
    var popupTop = rootTop + rootHeight;
    var winWidth = findWindowWidth();
    if(curr.popup.offsetWidth > winWidth*0.75)
        curr.popup.style.width = winWidth*0.75 + "px";
    var popupWidth = curr.popup.offsetWidth;
    if(popupLeft + popupWidth > winWidth)
        popupLeft = winWidth - popupWidth;
    curr.popup.style.left = popupLeft + "px";
    curr.popup.style.top = popupTop + "px";
    curr.popup.style.display = "block";
    addClass(curr.root,"highlight");
    if(config.options.chkAnimate && anim && typeof Scroller == "function")
        anim.startAnimating(new Scroller(curr.popup));
    else
        window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.remove = function()
{
    if(Popup.stack.length > 0) {
        Popup.removeFrom(0);
    }
};

Popup.removeFrom = function(from)
{
    for(var t=Popup.stack.length-1; t>=from; t--) {
        var p = Popup.stack[t];
        removeClass(p.root,"highlight");
        removeNode(p.popup);
    }
    Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem)
{
    if(elem) {
        this.formElem = findRelated(elem,"wizard","className");
        this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
        this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
    } else {
        this.formElem = null;
        this.bodyElem = null;
        this.footElem = null;
    }
}

Wizard.prototype.setValue = function(name,value)
{
    if(this.formElem)
        this.formElem[name] = value;
};

Wizard.prototype.getValue = function(name)
{
    return this.formElem ? this.formElem[name] : null;
};

Wizard.prototype.createWizard = function(place,title)
{
    this.formElem = createTiddlyElement(place,"form",null,"wizard");
    createTiddlyElement(this.formElem,"h1",null,null,title);
    this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
    this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
};

Wizard.prototype.clear = function()
{
    removeChildren(this.bodyElem);
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
    removeChildren(this.footElem);
    for(var t=0; t<buttonInfo.length; t++) {
        createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
        insertSpacer(this.footElem);
        }
    if(typeof status == "string") {
        createTiddlyElement(this.footElem,"span",null,"status",status);
    }
};

Wizard.prototype.addStep = function(stepTitle,html)
{
    removeChildren(this.bodyElem);
    var w = createTiddlyElement(this.bodyElem,"div");
    createTiddlyElement(w,"h2",null,null,stepTitle);
    var step = createTiddlyElement(w,"div",null,"wizardStep");
    step.innerHTML = html;
    applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
    return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
    var table = createTiddlyElement(place,"table",null,className ? className : "listView");
    var thead = createTiddlyElement(table,"thead");
    var r = createTiddlyElement(thead,"tr");
    for(var t=0; t<listTemplate.columns.length; t++) {
        var columnTemplate = listTemplate.columns[t];
        var c = createTiddlyElement(r,"th");
        var colType = ListView.columnTypes[columnTemplate.type];
        if(colType && colType.createHeader)
            colType.createHeader(c,columnTemplate,t);
    }
    var tbody = createTiddlyElement(table,"tbody");
    for(var rc=0; rc<listObject.length; rc++) {
        rowObject = listObject[rc];
        r = createTiddlyElement(tbody,"tr");
        for(c=0; c<listTemplate.rowClasses.length; c++) {
            if(rowObject[listTemplate.rowClasses[c].field])
                addClass(r,listTemplate.rowClasses[c].className);
        }
        rowObject.rowElement = r;
        rowObject.colElements = {};
        for(var cc=0; cc<listTemplate.columns.length; cc++) {
            c = createTiddlyElement(r,"td");
            columnTemplate = listTemplate.columns[cc];
            var field = columnTemplate.field;
            colType = ListView.columnTypes[columnTemplate.type];
            if(colType && colType.createItem)
                colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
            rowObject.colElements[field] = c;
        }
    }
    if(callback && listTemplate.actions)
        createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
    if(callback && listTemplate.buttons) {
        for(t=0; t<listTemplate.buttons.length; t++) {
            var a = listTemplate.buttons[t];
            if(a && a.name != "")
                createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
        }
    }
    return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
    return function(e) {
        var view = findRelated(this,"TABLE",null,"previousSibling");
        var tiddlers = [];
        ListView.forEachSelector(view,function(e,rowName) {
                    if(e.checked)
                        tiddlers.push(rowName);
                    });
        if(tiddlers.length == 0 && !allowEmptySelection) {
            alert(config.messages.nothingSelected);
        } else {
            if(this.nodeName.toLowerCase() == "select") {
                callback(view,this.value,tiddlers);
                this.selectedIndex = 0;
            } else {
                callback(view,name,tiddlers);
            }
        }
    };
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
    var checkboxes = view.getElementsByTagName("input");
    var hadOne = false;
    for(var t=0; t<checkboxes.length; t++) {
        var cb = checkboxes[t];
        if(cb.getAttribute("type") == "checkbox") {
            var rn = cb.getAttribute("rowName");
            if(rn) {
                callback(cb,rn);
                hadOne = true;
            }
        }
    }
    return hadOne;
};

ListView.getSelectedRows = function(view)
{
    var rowNames = [];
    ListView.forEachSelector(view,function(e,rowName) {
                if(e.checked)
                    rowNames.push(rowName);
                });
    return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
    createHeader: function(place,columnTemplate,col)
        {
            createTiddlyText(place,columnTemplate.title);
        },
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined)
                createTiddlyText(place,v);
        }
};

ListView.columnTypes.WikiText = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined)
                wikify(v,place,null,null);
        }
};

ListView.columnTypes.Tiddler = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined && v.title)
                createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
        }
};

ListView.columnTypes.Size = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined) {
                var t = 0;
                while(t<config.messages.sizeTemplates.length-1 && v<config.messages.sizeTemplates[t].unit)
                    t++;
                createTiddlyText(place,config.messages.sizeTemplates[t].template.format([Math.round(v/config.messages.sizeTemplates[t].unit)]));
            }
        }
};

ListView.columnTypes.Link = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            var c = columnTemplate.text;
            if(v != undefined)
                createTiddlyText(createExternalLink(place,v),c ? c : v);
        }
};

ListView.columnTypes.Date = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined)
                createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
        }
};

ListView.columnTypes.StringList = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined) {
                for(var t=0; t<v.length; t++) {
                    createTiddlyText(place,v[t]);
                    createTiddlyElement(place,"br");
                }
            }
        }
};

ListView.columnTypes.Selector = {
    createHeader: function(place,columnTemplate,col)
        {
            createTiddlyCheckbox(place,null,false,this.onHeaderChange);
        },
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var e = createTiddlyCheckbox(place,null,listObject[field],null);
            e.setAttribute("rowName",listObject[columnTemplate.rowName]);
        },
    onHeaderChange: function(e)
        {
            var state = this.checked;
            var view = findRelated(this,"TABLE");
            if(!view)
                return;
            ListView.forEachSelector(view,function(e,rowName) {
                                e.checked = state;
                            });
        }
};

ListView.columnTypes.Tags = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var tags = listObject[field];
            createTiddlyText(place,String.encodeTiddlyLinkList(tags));
        }
};

ListView.columnTypes.Boolean = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            if(listObject[field] == true)
                createTiddlyText(place,columnTemplate.trueText);
            if(listObject[field] == false)
                createTiddlyText(place,columnTemplate.falseText);
        }
};

ListView.columnTypes.TagCheckbox = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
            e.setAttribute("tiddler",listObject.title);
            e.setAttribute("tag",columnTemplate.tag);
        },
    onChange : function(e)
        {
            var tag = this.getAttribute("tag");
            var tiddler = this.getAttribute("tiddler");
            store.setTiddlerTag(tiddler,this.checked,tag);
        }
};

ListView.columnTypes.TiddlerLink = {
    createHeader: ListView.columnTypes.String.createHeader,
    createItem: function(place,listObject,field,columnTemplate,col,row)
        {
            var v = listObject[field];
            if(v != undefined) {
                var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
                createTiddlyText(link,listObject[field]);
            }
        }
};

//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
    var c = this;
    if(c < min)
        c = min;
    if(c > max)
        c = max;
    return c;
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
    if(!from)
        from = 0;
    for(var i=from; i<this.length; i++) {
        if(this[i] === item)
            return i;
    }
    return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
    for(var t=0; t<this.length; t++) {
        if(this[t][field] == value)
            return t;
    }
    return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
    return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
    var p = this.indexOf(value);
    if(mode == 0)
        mode = (p == -1) ? +1 : -1;
    if(mode == +1) {
        if(p == -1)
            this.push(value);
    } else if(mode == -1) {
        if(p != -1)
            this.splice(p,1);
    }
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
    for(var i=0; i<items.length; i++) {
        if (this.indexOf(items[i]) != -1)
            return true;
    }
    return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
    for (var i = 0; i<items.length; i++) {
        if (this.indexOf(items[i]) == -1)
            return false;
    }
    return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
    if(unique === false) {
        this.push(item);
    } else {
        if(this.indexOf(item) == -1)
            this.push(item);
    }
};

Array.prototype.remove = function(item)
{
    var p = this.indexOf(item);
    if(p != -1)
        this.splice(p,1);
};

// Get characters from the right end of a string
String.prototype.right = function(n)
{
    return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
    return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
    var s = this.split("-");
    if(s.length > 1) {
        for(var t=1; t<s.length; t++)
            s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
    }
    return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
    var subRegExp = /(?:%(\d+))/mg;
    var currPos = 0;
    var r = [];
    do {
        var match = subRegExp.exec(this);
        if(match && match[1]) {
            if(match.index > currPos)
                r.push(this.substring(currPos,match.index));
            r.push(substrings[parseInt(match[1])]);
            currPos = subRegExp.lastIndex;
        }
    } while(match);
    if(currPos < this.length)
        r.push(this.substring(currPos,this.length));
    return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
    var s = "\\^$*+?()=!|,{}[].";
    var c = this;
    for(var t=0; t<s.length; t++)
        c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
    return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
    return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
    return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
    return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
    return this.replace(/&amp;/mg,"&").replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"");
};

// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
String.prototype.toJSONString = function()
{
    var m = {
        '\b': '\\b',
        '\f': '\\f',
        '\n': '\\n',
        '\r': '\\r',
        '\t': '\\t',
        '"' : '\\"',
        '\\': '\\\\'
        };
    var replaceFn = function(a,b) {
        var c = m[b];
        if(c)
            return c;
        c = b.charCodeAt();
        return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
        };
    if(/["\\\x00-\x1f]/.test(this))
        return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
    return '"' + this + '"';
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
    var parseToken = function(match,p) {
        var n;
        if(match[p]) // Double quoted
            n = match[p];
        else if(match[p+1]) // Single quoted
            n = match[p+1];
        else if(match[p+2]) // Double-square-bracket quoted
            n = match[p+2];
        else if(match[p+3]) // Double-brace quoted
            try {
                n = match[p+3];
                if(allowEval)
                    n = window.eval(n);
            } catch(ex) {
                throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
            }
        else if(match[p+4]) // Unquoted
            n = match[p+4];
        else if(match[p+5]) // empty quote
            n = "";
        return n;
    };
    var r = [{}];
    var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
    var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
    var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
    var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
    var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
    var emptyQuote = "((?:\"\")|(?:''))";
    var skipSpace = "(?:\\s*)";
    var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
    var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
    var params = [];
    do {
        var match = re.exec(this);
        if(match) {
            var n = parseToken(match,1);
            if(noNames) {
                r.push({name:"",value:n});
            } else {
                var v = parseToken(match,8);
                if(v == null && defaultName) {
                    v = n;
                    n = defaultName;
                } else if(v == null && defaultValue) {
                    v = defaultValue;
                }
                r.push({name:n,value:v});
                if(cascadeDefaults) {
                    defaultName = n;
                    defaultValue = v;
                }
            }
        }
    } while(match);
    // Summarise parameters into first element
    for(var t=1; t<r.length; t++) {
        if(r[0][r[t].name])
            r[0][r[t].name].push(r[t].value);
        else
            r[0][r[t].name] = [r[t].value];
    }
    return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
    var p = this.parseParams("list",null,true,true);
    var n = [];
    for(var t=1; t<p.length; t++)
        n.push(p[t].value);
    return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
    var p = this.parseParams("list",null,false,true);
    var n = [];
    for(var t=1; t<p.length; t++)
        n.pushUnique(p[t].value,unique);
    return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
    var s = this.indexOf(start);
    if(s != -1) {
        s += start.length;
        var e = this.indexOf(end,s);
        if(e != -1)
            return [s,e];
    }
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
    var r = this.getChunkRange(start,end);
    return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
    var r = this.getChunkRange(start,end);
    if(r)
        return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
    return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
    if(list) {
        var results = [];
        for(var t=0; t<list.length; t++)
            results.push(String.encodeTiddlyLink(list[t]));
        return results.join(" ");
    } else {
        return "";
    }
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
    var fields = this.parseParams("anon","",false);
    var r = {};
    for(var t=1; t<fields.length; t++)
        r[fields[t].name] = fields[t].value;
    return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
    var r = [];
    for(var t in hashmap)
        r.push(t + ':"' + hashmap[t] + '"');
    return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
    var s = n.toString();
    if(s.length < d)
        s = "000000000000000000000000000".substr(0,d-s.length) + s;
    return s;
};

String.prototype.startsWith = function(prefix)
{
    return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
    if(!params)
        return defaultValue;
    var p = params[0][name];
    return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
    return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
    var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
    t = t.replace(/hh12/g,this.getHours12());
    t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
    t = t.replace(/hh/g,this.getHours());
    t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
    t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
    t = t.replace(/mm/g,this.getMinutes());
    t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
    t = t.replace(/ss/g,this.getSeconds());
    t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
    t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
    t = t.replace(/wYYYY/g,this.getYearForWeekNo());
    t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
    t = t.replace(/YYYY/g,this.getFullYear());
    t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
    t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
    t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
    t = t.replace(/MM/g,this.getMonth()+1);
    t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
    t = t.replace(/WW/g,this.getWeek());
    t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
    t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
    t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
    t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
    t = t.replace(/DD/g,this.getDate());
    return t;
};

Date.prototype.getWeek = function()
{
    var dt = new Date(this.getTime());
    var d = dt.getDay();
    if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
    dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
    var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
    return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
    var dt = new Date(this.getTime());
    var d = dt.getDay();
    if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
    dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
    return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
    var h = this.getHours();
    return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
    return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
    return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
    return String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
    return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
    return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
    return new Date(Date.UTC(parseInt(d.substr(0,4),10),
            parseInt(d.substr(4,2),10)-1,
            parseInt(d.substr(6,2),10),
            parseInt(d.substr(8,2),10),
            parseInt(d.substr(10,2),10),0,0));
};

//--
//-- Crypto functions and associated conversion routines
//--

// Crypto "namespace"
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
    var be = Array();
    var len = Math.floor(str.length/4);
    var i, j;
    for(i=0, j=0; i<len; i++, j+=4) {
        be[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
    }
    while (j<str.length) {
        be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
        j++;
    }
    return be;
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
    var str = "";
    for(var i=0;i<be.length*32;i+=8)
        str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
    return str;
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
    var hex = "0123456789ABCDEF";
    var str = "";
    for(var i=0;i<be.length*4;i++)
        str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
    return str;
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
    return Crypto.be32sToHex(Crypto.sha1Str(str));
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
    return Crypto.sha1(Crypto.strToBe32s(str),str.length);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
    // Add 32-bit integers, wrapping at 32 bits
    add32 = function(a,b)
    {
        var lsw = (a&0xFFFF)+(b&0xFFFF);
        var msw = (a>>16)+(b>>16)+(lsw>>16);
        return (msw<<16)|(lsw&0xFFFF);
    };
    // Add five 32-bit integers, wrapping at 32 bits
    add32x5 = function(a,b,c,d,e)
    {
        var lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
        var msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
        return (msw<<16)|(lsw&0xFFFF);
    };
    // Bitwise rotate left a 32-bit integer by 1 bit
    rol32 = function(n)
    {
        return (n>>>31)|(n<<1);
    };

    var len = blen*8;
    // Append padding so length in bits is 448 mod 512
    x[len>>5] |= 0x80 << (24-len%32);
    // Append length
    x[((len+64>>9)<<4)+15] = len;
    var w = Array(80);

    var k1 = 0x5A827999;
    var k2 = 0x6ED9EBA1;
    var k3 = 0x8F1BBCDC;
    var k4 = 0xCA62C1D6;

    var h0 = 0x67452301;
    var h1 = 0xEFCDAB89;
    var h2 = 0x98BADCFE;
    var h3 = 0x10325476;
    var h4 = 0xC3D2E1F0;

    for(var i=0;i<x.length;i+=16) {
        var j,t;
        var a = h0;
        var b = h1;
        var c = h2;
        var d = h3;
        var e = h4;
        for(j = 0;j<16;j++) {
            w[j] = x[i+j];
            t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
            e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
        }
        for(j=16;j<20;j++) {
            w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
            t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
            e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
        }
        for(j=20;j<40;j++) {
            w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
            t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);
            e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
        }
        for(j=40;j<60;j++) {
            w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
            t = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);
            e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
        }
        for(j=60;j<80;j++) {
            w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
            t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);
            e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
        }

        h0 = add32(h0,a);
        h1 = add32(h1,b);
        h2 = add32(h2,c);
        h3 = add32(h3,d);
        h4 = add32(h4,e);
    }
    return Array(h0,h1,h2,h3,h4);
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
    this.r = 0;
    this.g = 0;
    this.b = 0;
    if(typeof r == "string") {
        if(r.substr(0,1) == "#") {
            if(r.length == 7) {
                this.r = parseInt(r.substr(1,2),16)/255;
                this.g = parseInt(r.substr(3,2),16)/255;
                this.b = parseInt(r.substr(5,2),16)/255;
            } else {
                this.r = parseInt(r.substr(1,1),16)/15;
                this.g = parseInt(r.substr(2,1),16)/15;
                this.b = parseInt(r.substr(3,1),16)/15;
            }
        } else {
            var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
            var c = r.match(rgbPattern);
            if(c) {
                this.r = parseInt(c[1],10)/255;
                this.g = parseInt(c[2],10)/255;
                this.b = parseInt(c[3],10)/255;
            }
        }
    } else {
        this.r = r;
        this.g = g;
        this.b = b;
    }
    return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
    return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
    return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
                 ("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
                 ("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,colours)
{
    for(var t=0; t<= 100; t+=2) {
        var bar = document.createElement("div");
        place.appendChild(bar);
        bar.style.position = "absolute";
        bar.style.left = horiz ? t + "%" : 0;
        bar.style.top = horiz ? 0 : t + "%";
        bar.style.width = horiz ? (101-t) + "%" : "100%";
        bar.style.height = horiz ? "100%" : (101-t) + "%";
        bar.style.zIndex = -1;
        var f = t/100;
        var p = f*(colours.length-1);
        bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
    }
}

function createTiddlyText(theParent,theText)
{
    return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyCheckbox(theParent,caption,checked,onChange)
{
    var cb = document.createElement("input");
    cb.setAttribute("type","checkbox");
    cb.onclick = onChange;
    theParent.appendChild(cb);
    cb.checked = checked;
    cb.className = "chkOptionInput";
    if(caption)
        wikify(caption,theParent);
    return cb;
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
    var e = document.createElement(theElement);
    if(theClass != null)
        e.className = theClass;
    if(theID != null)
        e.setAttribute("id",theID);
    if(theText != null)
        e.appendChild(document.createTextNode(theText));
    if(theParent != null)
        theParent.appendChild(e);
    return e;
}

function addEvent(obj,type,fn)
{
    if(obj.attachEvent) {
        obj['e'+type+fn] = fn;
        obj[type+fn] = function(){obj['e'+type+fn](window.event);};
        obj.attachEvent('on'+type,obj[type+fn]);
    } else {
        obj.addEventListener(type,fn,false);
    }
}

function removeEvent(obj,type,fn)
{
    if(obj.detachEvent) {
        obj.detachEvent('on'+type,obj[type+fn]);
        obj[type+fn] = null;
    } else {
        obj.removeEventListener(type,fn,false);
    }
}

function addClass(e,theClass)
{
    var currClass = e.className.split(" ");
    if(currClass.indexOf(theClass) == -1)
        e.className += " " + theClass;
}

function removeClass(e,theClass)
{
    var currClass = e.className.split(" ");
    var i = currClass.indexOf(theClass);
    while(i != -1) {
        currClass.splice(i,1);
        i = currClass.indexOf(theClass);
    }
    e.className = currClass.join(" ");
}

function hasClass(e,theClass)
{
    if(e.className) {
        if(e.className.split(" ").indexOf(theClass) != -1)
            return true;
    }
    return false;
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
    name = name ? name : "tagName";
    relative = relative ? relative : "parentNode";
    if(name == "className") {
        while(e && !hasClass(e,value)) {
            e = e[relative];
        }
    } else {
        while(e && e[name] != value) {
            e = e[relative];
        }
    }
    return e;
}

// Resolve the target object of an event
function resolveTarget(e)
{
    var obj;
    if(e.target)
        obj = e.target;
    else if(e.srcElement)
        obj = e.srcElement;
    if(obj.nodeType == 3) // defeat Safari bug
        obj = obj.parentNode;
    return obj;
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
    var text = "";
    if(e.innerText)
        text = e.innerText;
    else if(e.textContent)
        text = e.textContent;
    return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
    var posTop = findPosY(e);
    var posBot = posTop + e.offsetHeight;
    var winTop = findScrollY();
    var winHeight = findWindowHeight();
    var winBot = winTop + winHeight;
    if(posTop < winTop) {
        return posTop;
    } else if(posBot > winBot) {
        if(e.offsetHeight < winHeight)
            return posTop - (winHeight - e.offsetHeight);
        else
            return posTop;
    } else {
        return winTop;
    }
}

// Get the current width of the display window
function findWindowWidth()
{
    return window.innerWidth ? window.innerWidth : document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
    return window.innerHeight ? window.innerHeight : document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
    return window.scrollX ? window.scrollX : document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
    return window.scrollY ? window.scrollY : document.documentElement.scrollTop;
}

function findPosX(obj)
{
    var curleft = 0;
    while(obj.offsetParent) {
        curleft += obj.offsetLeft;
        obj = obj.offsetParent;
    }
    return curleft;
}

function findPosY(obj)
{
    var curtop = 0;
    while(obj.offsetParent) {
        curtop += obj.offsetTop;
        obj = obj.offsetParent;
    }
    return curtop;
}

// Blur a particular element
function blurElement(e)
{
    if(e != null && e.focus && e.blur) {
        e.focus();
        e.blur();
    }
}

// Create a non-breaking space
function insertSpacer(place)
{
    var e = document.createTextNode(String.fromCharCode(160));
    if(place)
        place.appendChild(e);
    return e;
}

// Remove all children of a node
function removeChildren(e)
{
    while(e && e.hasChildNodes())
        removeNode(e.firstChild);
}

// Remove a node and all it's children
function removeNode(e)
{
    scrubNode(e);
    e.parentNode.removeChild(e);
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
    var att = e.attributes;
    if(att) {
        for(var t=0; t<att.length; t++) {
            var n = att[t].name;
            if(n !== 'style' && (typeof e[n] === 'function' || (typeof e[n] === 'object' && e[n] != null))) {
                try {
                    e[n] = null;
                } catch(ex) {
                }
            }
        }
    }
    var c = e.firstChild;
    while(c) {
        scrubNode(c);
        c = c.nextSibling;
    }
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id,doc)
{
    if(!id)
        id = "customStyleSheet";
    if(!doc)
        doc = document;
    var n = doc.getElementById(id);
    if(doc.createStyleSheet) {
        // Test for IE's non-standard createStyleSheet method
        if(n)
            n.parentNode.removeChild(n);
        // This failed without the &nbsp;
        doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
    } else {
        if(n) {
            n.replaceChild(doc.createTextNode(s),n.firstChild);
        } else {
            n = doc.createElement("style");
            n.type = "text/css";
            n.id = id;
            n.appendChild(doc.createTextNode(s));
            doc.getElementsByTagName("head")[0].appendChild(n);
        }
    }
}

// Force the browser to do a document reflow when needed to workaround browser bugs
function forceReflow()
{
    if(config.browser.isGecko) {
        setStylesheet("body {top:-1em;margin-top:1em;}");
        setStylesheet("");
    }
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
    if(e.setSelectionRange) {
        var oldpos = e.selectionStart;
        var isRange = e.selectionEnd > e.selectionStart;
        e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
        e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
        var linecount = e.value.split('\n').length;
        var thisline = e.value.substr(0,e.selectionStart).split('\n').length-1;
        e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
    } else if(document.selection) {
        var range = document.selection.createRange();
        if(range.parentElement() == e) {
            var isCollapsed = range.text == "";
            range.text = text;
            if(!isCollapsed) {
                range.moveStart('character', -text.length);
                range.select();
            }
        }
    }
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
    var t = "";
    while(e && e.nodeName == "#text") {
        t += e.nodeValue;
        e = e.nextSibling;
    }
    return t;
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
    var title = this.getTitle(store,node);
    if(title) {
        var tiddler = store.createTiddler(title);
        this.internalizeTiddler(store,tiddler,title,node);
        tiddlers.push(tiddler);
    }
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
    var tiddlers = [];
    for(var t = 0; t < nodes.length; t++) {
        try {
            this.loadTiddler(store,nodes[t],tiddlers);
        } catch(ex) {
            showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
        }
    }
    return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
    var results = [];
    var tiddlers = store.getTiddlers("title");
    for(var t = 0; t < tiddlers.length; t++)
        results.push(this.externalizeTiddler(store,tiddlers[t]));
    return results.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
    var title = null;
    if(node.getAttribute) {
        title = node.getAttribute("title");
        if(!title)
            title = node.getAttribute("tiddler");
    }
    if(!title && node.id) {
        var lenPrefix = store.idPrefix.length;
        if (node.id.substr(0,lenPrefix) == store.idPrefix)
            title = node.id.substr(lenPrefix);
    }
    return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
    var e = node.firstChild;
    var text = null;
    if(node.getAttribute("tiddler")) {
        text = getNodeText(e).unescapeLineBreaks();
    } else {
        while(e.nodeName!="PRE" && e.nodeName!="pre") {
            e = e.nextSibling;
        }
        text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
    }
    var modifier = node.getAttribute("modifier");
    var c = node.getAttribute("created");
    var m = node.getAttribute("modified");
    var created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;
    var modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;
    var tags = node.getAttribute("tags");
    var fields = {};
    var attrs = node.attributes;
    for(var i = attrs.length-1; i >= 0; i--) {
        var name = attrs[i].name;
        if (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
            fields[name] = attrs[i].value.unescapeLineBreaks();
        }
    }
    tiddler.assign(title,text,modifier,modified,tags,created,fields);
    return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
    try {
        var extendedAttributes = "";
        var usePre = config.options.chkUsePreForStorage;
        store.forEachField(tiddler,
            function(tiddler,fieldName,value) {
                // don't store stuff from the temp namespace
                if(typeof value != "string")
                    value = "";
                if (!fieldName.match(/^temp\./))
                    extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
            },true);
        var created = tiddler.created.convertToYYYYMMDDHHMM();
        var modified = tiddler.modified.convertToYYYYMMDDHHMM();
        var vdate = version.date.convertToYYYYMMDDHHMM();
        var attributes = tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
        attributes += (usePre && modified == created) ? "" : ' modified="' + modified +'"';
        attributes += (usePre && created == vdate) ? "" :' created="' + created + '"';
        var tags = tiddler.getTags();
        if(!usePre || tags)
            attributes += ' tags="' + tags.htmlEncode() + '"';
        return ('<div %0="%1"%2%3>%4</'+'div>').format([
                usePre ? "title" : "tiddler",
                tiddler.title.htmlEncode(),
                attributes,
                extendedAttributes,
                usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
            ]);
    } catch (ex) {
        throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
    }
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
    w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
    var lookaheadRegExp = new RegExp(this.lookahead,"mg");
    lookaheadRegExp.lastIndex = w.matchStart;
    var lookaheadMatch = lookaheadRegExp.exec(w.source);
    if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
        var text = lookaheadMatch[1];
        if(config.browser.isIE)
            text = text.replace(/\n/g,"\r");
        createTiddlyElement(w.output,"pre",null,null,text);
        w.nextMatch = lookaheadRegExp.lastIndex;
    }
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br.handler = function(place)
{
    createTiddlyElement(place,"br");
};

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
    var i = this.indexOf(item);
    return i == -1 ? null : i;
};

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
    return store.getLoader().internalizeTiddler(store,this,title,divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
    return store.getSaver().externalizeTiddler(store,this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
    return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
    refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,unused3)
{
    story.displayTiddlers(srcElement,titles,template,animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,unused3)
{
    story.displayTiddler(srcElement,title,template,animate);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");
//--
//-- End of scripts
//--
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
    document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!-- JC: anything between POST-SCRIPT-START and POST-SCRIPT-END will be cleared upon "Save changes". -->
<script type="text/javascript" src="primeapps.js"></script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
